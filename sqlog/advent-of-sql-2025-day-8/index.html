<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <title>Advent of SQL 2025 Day 8: Product Catalog | Meet Gor</title>
    <meta name="title" content="Advent of SQL 2025 Day 8: Product Catalog | Meet Gor">
    <meta name="description" content="">
    <meta name="author" content="Meet Gor">
    <meta name="keywords" content="sqlite, sql, advent-of-sql">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://meetgor.com/sqlog/advent-of-sql-2025-day-8">
    
    
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://meetgor.com/sqlog/advent-of-sql-2025-day-8">
    <meta property="og:title" content="Advent of SQL 2025 Day 8: Product Catalog">
    <meta property="og:description" content="">
    <meta property="og:image" content="https://meetgor.com/tbicon.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="Advent of SQL 2025 Day 8: Product Catalog">
    <meta property="og:locale" content="en_US">
    <meta property="og:site_name" content="Meet Gor">
    <meta property="article:published_time" content="2025-12-23 15:30 &#43;0530">
    <meta property="article:modified_time" content="2025-12-23 15:30 &#43;0530">
    <meta property="article:author" content="Meet Gor">
    
    <meta property="article:tag" content="sqlite">
    
    <meta property="article:tag" content="sql">
    
    <meta property="article:tag" content="advent-of-sql">
    
    
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@meetgor711">
    <meta name="twitter:creator" content="@meetgor711">
    <meta name="twitter:url" content="https://meetgor.com/sqlog/advent-of-sql-2025-day-8">
    <meta name="twitter:title" content="Advent of SQL 2025 Day 8: Product Catalog">
    <meta name="twitter:description" content="">
    <meta name="twitter:image" content="https://meetgor.com/tbicon.png">
    <meta name="twitter:image:alt" content="Advent of SQL 2025 Day 8: Product Catalog">
    
    
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/meetgor.com/sqlog\/advent-of-sql-2025-day-8"
        },
        "headline": "Advent of SQL 2025 Day 8: Product Catalog",
        "description": "",
        "datePublished": "2025-12-23 15:30 \u002b0530",
        "dateModified": "2025-12-23 15:30 \u002b0530",
        "author": {
            "@type": "Person",
            "name": "Meet Gor"
        },
        "publisher": {
            "@type": "Organization",
            "name": "Meet Gor",
            "logo": {
                "@type": "ImageObject",
                "url": "https:\/\/meetgor.com/tbicon.png"
            }
        },
        
        "keywords": "sqlite, sql, advent-of-sql",
        "articleBody": "\u0026lt;h2 id=\u0026#34;advent-of-sql---day-8-product-catalog\u0026#34;\u0026gt;Advent of SQL - Day 8, Product Catalog\u0026lt;\/h2\u0026gt;\n\u0026lt;p\u0026gt;Whopsies! This is day 8.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Let\u0026#39;s get straigh...\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;HOOH! We need to clean up some SQL for running in SQLite.\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;code-block\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;code-header\u0026#34;\u0026gt;\u0026lt;span class=\u0026#34;language-name\u0026#34;\u0026gt;bash\u0026lt;\/span\u0026gt;\u0026lt;button class=\u0026#34;copy-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-copy\u0026#34;\u0026gt;\u0026lt;rect x=\u0026#34;9\u0026#34; y=\u0026#34;9\u0026#34; width=\u0026#34;13\u0026#34; height=\u0026#34;13\u0026#34; rx=\u0026#34;2\u0026#34; ry=\u0026#34;2\u0026#34;\u0026gt;\u0026lt;\/rect\u0026gt;\u0026lt;path d=\u0026#34;M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-bash\u0026#34;\u0026gt;sed -i \u0026#39;s\/TIMESTAMP[[:space:]]*\/\/g\u0026#39; day8-inserts-sqlite.sql\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;Just cleaning up \u0026lt;code\u0026gt;TIMESTAMP\u0026lt;\/code\u0026gt; in \u0026lt;code\u0026gt;INSERT\u0026lt;\/code\u0026gt; before the date value.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Here we go:\nThe SQL to run in SQLite.\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;DROP TABLE IF EXISTS price_changes;\nDROP TABLE IF EXISTS products;\n\nCREATE TABLE products (\n    product_id INT PRIMARY KEY,\n    product_name TEXT\n);\n\nCREATE TABLE price_changes (\n    id INT PRIMARY KEY,\n    product_id INT,\n    price NUMERIC(10,2),\n    effective_timestamp \n);\n\nINSERT INTO products (product_id, product_name) VALUES\n    (1, \u0026#39;Deluxe Sled\u0026#39;),\n    (2, \u0026#39;Holiday Trail Mix Trio\u0026#39;),\n    (3, \u0026#39;Premium Cinnamon Roasted Almonds\u0026#39;),\n    (4, \u0026#39;Deluxe Wrapping Paper\u0026#39;),\n    (5, \u0026#39;Deluxe Roasted Cashews\u0026#39;),\n    (6, \u0026#39;Festive Cookware Set\u0026#39;),\n    (7, \u0026#39;Deluxe Mug\u0026#39;),\n    (8, \u0026#39;Premium Sled\u0026#39;),\n    (9, \u0026#39;Essential Sled\u0026#39;),\n    (10, \u0026#39;Family Snow Boots\u0026#39;),\n    (11, \u0026#39;Family Dark Chocolate Almonds\u0026#39;),\n    (12, \u0026#39;Premium Festive Scarf\u0026#39;),\n    (13, \u0026#39;Essential Cookie Decorating Kit\u0026#39;),\n    (14, \u0026#39;Festive White Chocolate Popcorn\u0026#39;),\n    (15, \u0026#39;Cozy Puzzle\u0026#39;),\n    (16, \u0026#39;Holiday Cheddar Popcorn\u0026#39;),\n    (17, \u0026#39;Premium Board Game\u0026#39;),\n    (18, \u0026#39;Deluxe Pecan Praline Bites\u0026#39;),\n    (19, \u0026#39;Cozy Almond Brittle\u0026#39;),\n    (20, \u0026#39;Winter Sled\u0026#39;);\n\nINSERT INTO price_changes (id, product_id, price, effective_timestamp) VALUES\n    (1, 1, 148.28, \u0026#39;2025-12-01 05:25:35\u0026#39;),\n    (2, 1, 148.63, \u0026#39;2025-12-02 18:15:33\u0026#39;),\n    (3, 1, 126.78, \u0026#39;2025-12-02 18:40:38\u0026#39;),\n    (4, 1, 119.12, \u0026#39;2025-12-03 10:14:35\u0026#39;),\n    (5, 1, 98.57, \u0026#39;2025-12-04 04:14:31\u0026#39;),\n    (6, 1, 88.49, \u0026#39;2025-12-06 19:02:40\u0026#39;),\n    (7, 1, 80.88, \u0026#39;2025-12-07 10:43:54\u0026#39;),\n    (8, 1, 78.88, \u0026#39;2025-12-08 06:45:39\u0026#39;),\n    (9, 1, 80.24, \u0026#39;2025-12-08 16:11:11\u0026#39;),\n    (10, 1, 73.9, \u0026#39;2025-12-10 14:33:43\u0026#39;),\n    (11, 1, 88.2, \u0026#39;2025-12-12 02:21:09\u0026#39;),\n    (12, 1, 99.03, \u0026#39;2025-12-12 02:58:14\u0026#39;),\n    (13, 1, 100.18, \u0026#39;2025-12-14 15:58:03\u0026#39;),\n    (14, 1, 106.91, \u0026#39;2025-12-16 01:51:05\u0026#39;),\n    (15, 1, 109.25, \u0026#39;2025-12-16 16:01:53\u0026#39;),\n    (16, 2, 29.54, \u0026#39;2025-12-03 14:21:10\u0026#39;),\n    (17, 2, 34.33, \u0026#39;2025-12-03 19:14:31\u0026#39;),\n    (18, 2, 39.08, \u0026#39;2025-12-04 06:13:48\u0026#39;),\n    (19, 2, 32.71, \u0026#39;2025-12-04 18:33:17\u0026#39;),\n    (20, 2, 31.71, \u0026#39;2025-12-05 22:36:14\u0026#39;),\n    (21, 2, 28.88, \u0026#39;2025-12-06 02:42:02\u0026#39;),\n    (22, 2, 23.14, \u0026#39;2025-12-07 09:46:54\u0026#39;),\n    (23, 2, 25.65, \u0026#39;2025-12-07 10:03:45\u0026#39;),\n    (24, 2, 27.06, \u0026#39;2025-12-07 14:39:15\u0026#39;),\n    (25, 2, 24.48, \u0026#39;2025-12-07 20:08:05\u0026#39;),\n    (26, 2, 26.84, \u0026#39;2025-12-09 07:44:32\u0026#39;),\n    (27, 2, 27.39, \u0026#39;2025-12-13 06:25:19\u0026#39;),\n    (28, 2, 26.6, \u0026#39;2025-12-14 10:16:34\u0026#39;),\n    (29, 2, 21.38, \u0026#39;2025-12-15 16:20:20\u0026#39;),\n    (30, 2, 17.75, \u0026#39;2025-12-16 09:28:13\u0026#39;);\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;We can get started.\u0026lt;\/p\u0026gt;\n\u0026lt;h2 id=\u0026#34;problem\u0026#34;\u0026gt;Problem\u0026lt;\/h2\u0026gt;\n\u0026lt;blockquote\u0026gt;\n\u0026lt;p\u0026gt;Generate a report, using the products and \u0026lt;code\u0026gt;price_changes\u0026lt;\/code\u0026gt; tables for leadership that returns the \u0026lt;code\u0026gt;product_name\u0026lt;\/code\u0026gt;, \u0026lt;code\u0026gt;current_price\u0026lt;\/code\u0026gt;, \u0026lt;code\u0026gt;previous_price\u0026lt;\/code\u0026gt;, and the difference between the current and previous prices\u0026lt;\/p\u0026gt;\n\u0026lt;\/blockquote\u0026gt;\n\u0026lt;p\u0026gt;So what we need is\u0026lt;\/p\u0026gt;\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;product_name\u0026lt;\/li\u0026gt;\n\u0026lt;li\u0026gt;current_price (latest)\u0026lt;\/li\u0026gt;\n\u0026lt;li\u0026gt;previous_price (just before the latest)\u0026lt;\/li\u0026gt;\n\u0026lt;li\u0026gt;price_difference = current - previous\u0026lt;\/li\u0026gt;\n\u0026lt;\/ul\u0026gt;\n\u0026lt;p\u0026gt;Again we have to meddle with dates, maybe, maybe not!\u0026lt;\/p\u0026gt;\n\u0026lt;h3 id=\u0026#34;with-ctes-and-joins\u0026#34;\u0026gt;With CTEs and JOINs\u0026lt;\/h3\u0026gt;\n\u0026lt;p\u0026gt;Let\u0026#39;s start with the simplest approach. We need 2 prices, the latest(highest date timestamp) and the 2nd latest (the 2nd highest date timestamp). We can get the first pretty easily, but what about the second?\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Well, if we get the first, then the second should be easy to get right? Right? Because it will be just before it. Well not directly.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Let\u0026#39;s first grab the max timestamp.\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;SELECT \n    product_id,\n    MAX(effective_timestamp) AS latest_timestamp\nFROM price_changes\nGROUP BY product_id;\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;div class=\u0026#34;code-block\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;code-header\u0026#34;\u0026gt;\u0026lt;span class=\u0026#34;language-name\u0026#34;\u0026gt;\u0026lt;\/span\u0026gt;\u0026lt;button class=\u0026#34;copy-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-copy\u0026#34;\u0026gt;\u0026lt;rect x=\u0026#34;9\u0026#34; y=\u0026#34;9\u0026#34; width=\u0026#34;13\u0026#34; height=\u0026#34;13\u0026#34; rx=\u0026#34;2\u0026#34; ry=\u0026#34;2\u0026#34;\u0026gt;\u0026lt;\/rect\u0026gt;\u0026lt;path d=\u0026#34;M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code\u0026gt;sqlite\u0026gt; SELECT product_id, MAX(effective_timestamp) AS max_ts\n        FROM price_changes\n        GROUP BY product_id;\n\u002b------------\u002b---------------------\u002b\n| product_id |       max_ts        |\n\u002b------------\u002b---------------------\u002b\n| 1          | 2025-12-16 16:01:53 |\n| 2          | 2025-12-16 09:28:13 |\n| 3          | 2025-12-15 03:20:11 |\n| 4          | 2025-12-16 01:33:41 |\n| 5          | 2025-12-12 10:11:48 |\n| 6          | 2025-12-15 11:31:40 |\n| 7          | 2025-12-16 03:00:51 |\n| 8          | 2025-12-15 22:33:48 |\n| 9          | 2025-12-15 20:05:34 |\n| 10         | 2025-12-15 20:53:45 |\n...\n...\n| 139        | 2025-12-16 04:46:33 |\n| 140        | 2025-12-16 21:19:30 |\n| 141        | 2025-12-15 09:50:36 |\n| 142        | 2025-12-16 18:39:51 |\n| 143        | 2025-12-15 07:27:06 |\n| 144        | 2025-12-16 16:25:16 |\n| 146        | 2025-12-13 07:07:19 |\n| 148        | 2025-12-16 09:30:11 |\n| 149        | 2025-12-13 16:40:21 |\n| 150        | 2025-12-13 08:24:43 |\n\u002b------------\u002b---------------------\u002b\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;We got all the timestamp\u0026#39;s for each product. But we wanted the prices. Well we can\u0026#39;t grab the price here, since we are grouping!\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;We can use the timestamp as we are selecting the \u0026lt;code\u0026gt;MAX\u0026lt;\/code\u0026gt; aggregate function however among the many rows for single product how do we group the price? \u0026lt;code\u0026gt;MIN\u0026lt;\/code\u0026gt;, \u0026lt;code\u0026gt;MAX\u0026lt;\/code\u0026gt;, \u0026lt;code\u0026gt;AVG\u0026lt;\/code\u0026gt;, but that\u0026#39;s not we want, we just want the price for that timestamp.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Well, we need to join to the same table for that timestamp and grab the price.\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;SELECT \n    price_changes.product_id,\n    price_changes.price AS current_price,\n    price_changes.effective_timestamp AS latest_ts\nFROM price_changes\nJOIN (\n    SELECT \n        product_id, \n        MAX(effective_timestamp) AS latest_timestamp\n    FROM price_changes\n    GROUP BY product_id\n) AS latest_price_change\n  ON price_changes.product_id = latest_price_change.product_id\n AND price_changes.effective_timestamp = latest_price_change.latest_timestamp;\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;Here, we first specify what we want\u0026lt;\/p\u0026gt;\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;code\u0026gt;product_id\u0026lt;\/code\u0026gt;\u0026lt;\/li\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;code\u0026gt;current_price\u0026lt;\/code\u0026gt; which is the price for the\u0026lt;\/li\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;code\u0026gt;latest_timestamp\u0026lt;\/code\u0026gt; which is the latest time recorded for the product price.\u0026lt;\/li\u0026gt;\n\u0026lt;\/ul\u0026gt;\n\u0026lt;p\u0026gt;We are grouping this by \u0026lt;code\u0026gt;product_id\u0026lt;\/code\u0026gt; since there are price recorded and various timestamps. We need to get the latest timestamp.\nSo, we do a nested query to join the latest timestamp and join the price with the same timestamp.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;This condition \u0026lt;code\u0026gt;price_changes.effective_timestamp = latest_price_change.latest_timestamp\u0026lt;\/code\u0026gt; helps us get the \u0026lt;code\u0026gt;price\u0026lt;\/code\u0026gt; for the \u0026lt;code\u0026gt;latest_timestamp\u0026lt;\/code\u0026gt;. We first get each timestamp for the product and then find its max, so that\u0026#39;s the inner query from which we joined this table to. Self join with the different thing to find.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;This gives us 2 things.\u0026lt;\/p\u0026gt;\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;Product id\u0026lt;\/li\u0026gt;\n\u0026lt;li\u0026gt;Price for the latest timestamp\u0026lt;\/li\u0026gt;\n\u0026lt;\/ul\u0026gt;\n\u0026lt;p\u0026gt;We don\u0026#39;t really want the timestamp in the final result, its just a criteria or a intermediate value to get the current and the previous prices for each product.\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;code-block\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;code-header\u0026#34;\u0026gt;\u0026lt;span class=\u0026#34;language-name\u0026#34;\u0026gt;\u0026lt;\/span\u0026gt;\u0026lt;button class=\u0026#34;copy-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-copy\u0026#34;\u0026gt;\u0026lt;rect x=\u0026#34;9\u0026#34; y=\u0026#34;9\u0026#34; width=\u0026#34;13\u0026#34; height=\u0026#34;13\u0026#34; rx=\u0026#34;2\u0026#34; ry=\u0026#34;2\u0026#34;\u0026gt;\u0026lt;\/rect\u0026gt;\u0026lt;path d=\u0026#34;M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code\u0026gt;sqlite\u0026gt; \nsqlite\u0026gt; SELECT \n    price_changes.product_id,\n    price_changes.price AS current_price,\n    price_changes.effective_timestamp AS latest_ts\nFROM price_changes\nJOIN (\n    SELECT \n        product_id, \n        MAX(effective_timestamp) AS latest_timestamp\n    FROM price_changes\n    GROUP BY product_id\n) AS latest_price_change\n  ON price_changes.product_id = latest_price_change.product_id\n AND price_changes.effective_timestamp = latest_price_change.latest_timestamp;\n\u002b------------\u002b---------------\u002b---------------------\u002b\n| product_id | current_price |      latest_ts      |\n\u002b------------\u002b---------------\u002b---------------------\u002b\n| 1          | 109.25        | 2025-12-16 16:01:53 |\n| 2          | 17.75         | 2025-12-16 09:28:13 |\n| 3          | 143.65        | 2025-12-15 03:20:11 |\n| 4          | 98.51         | 2025-12-16 01:33:41 |\n| 5          | 124.04        | 2025-12-12 10:11:48 |\n| 6          | 84.14         | 2025-12-15 11:31:40 |\n| 7          | 123.09        | 2025-12-16 03:00:51 |\n| 8          | 221.06        | 2025-12-15 22:33:48 |\n| 9          | 255.88        | 2025-12-15 20:05:34 |\n| 10         | 57.99         | 2025-12-15 20:53:45 |\n...\n...\n| 139        | 16.41         | 2025-12-16 04:46:33 |\n| 140        | 173.05        | 2025-12-16 21:19:30 |\n| 141        | 69.97         | 2025-12-15 09:50:36 |\n| 142        | 35.05         | 2025-12-16 18:39:51 |\n| 143        | 153.94        | 2025-12-15 07:27:06 |\n| 144        | 118.21        | 2025-12-16 16:25:16 |\n| 146        | 54.73         | 2025-12-13 07:07:19 |\n| 148        | 107.81        | 2025-12-16 09:30:11 |\n| 149        | 72.6          | 2025-12-13 16:40:21 |\n| 150        | 138.66        | 2025-12-13 08:24:43 |\n\u002b------------\u002b---------------\u002b---------------------\u002b\nsqlite\u0026gt; \n\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;Now, we need to the price before this max timestamp. How do we get it?\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;We need to again join? Yes...\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;We need to subquery the timestamp just before it. But how will we get the max timestamp for each product. Well that\u0026#39;s what we wrote above.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;We can convert that to a CTE.\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;\nWITH latest AS (\n    SELECT price_changes.product_id,\n           price_changes.price AS current_price,\n           price_changes.effective_timestamp AS latest_timestamp\n    FROM price_changes\n    JOIN (                                                   \n        SELECT product_id, MAX(effective_timestamp) AS max_timestamp\n        FROM price_changes\n        GROUP BY product_id\n    ) latest_price_changes                             \n      ON price_changes.product_id = latest_price_changes.product_id\n     AND price_changes.effective_timestamp = latest_price_changes.max_timestamp\n)\nSELECT * FROM latest;\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;We just got the same thing, however we can now use \u0026lt;code\u0026gt;latest\u0026lt;\/code\u0026gt; as a temporary table in the query.\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;WITH latest AS (\n    SELECT price_changes.product_id,\n           price_changes.price AS current_price,\n           price_changes.effective_timestamp AS latest_timestamp\n    FROM price_changes\n    JOIN (                                                   \n        SELECT product_id, MAX(effective_timestamp) AS max_timestamp\n        FROM price_changes\n        GROUP BY product_id\n    ) latest_price_changes\n      ON price_changes.product_id = latest_price_changes.product_id\n     AND price_changes.effective_timestamp = latest_price_changes.max_timestamp\n),  previous AS (\n    SELECT price_changes.product_id,\n           price_changes.price AS previous_price,\n           MAX(price_changes.effective_timestamp) AS previous_timestamp\n    FROM price_changes\n    JOIN latest\n      ON price_changes.product_id = latest.product_id\n    WHERE price_changes.effective_timestamp \u0026lt; latest.latest_timestamp\n    GROUP BY price_changes.product_id\n)\nSELECT * FROM previous JOIN latest ON previous.product_id = latest.product_id;\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;So, ok, this is getting long.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Just we added this\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;SELECT \n    price_changes.product_id,\n    price_changes.price AS previous_price,\n    MAX(price_changes.effective_timestamp) AS previous_timestamp\nFROM price_changes\nJOIN latest\n    ON price_changes.product_id = latest.product_id\nWHERE \n    price_changes.effective_timestamp \u0026lt; latest.latest_timestamp\nGROUP BY price_changes.product_id\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;This won\u0026#39;t work as we need the latest table which we converted to CTE.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;So, to get the 2nd highest or latest timestamp for each product, we do this.\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;WITH latest AS (\n    SELECT price_changes.product_id,\n           price_changes.price AS current_price,\n           price_changes.effective_timestamp AS latest_timestamp\n    FROM price_changes\n    JOIN (                                                   \n        SELECT product_id, MAX(effective_timestamp) AS max_timestamp\n        FROM price_changes\n        GROUP BY product_id\n    ) latest_price_changes                             \n      ON price_changes.product_id = latest_price_changes.product_id\n     AND price_changes.effective_timestamp = latest_price_changes.max_timestamp\n) \n    SELECT price_changes.product_id,\n           price_changes.price AS previous_price,\n           MAX(price_changes.effective_timestamp) AS previous_timestamp\n    FROM price_changes\n    JOIN latest\n      ON price_changes.product_id = latest.product_id\n    WHERE price_changes.effective_timestamp \u0026lt; latest.latest_timestamp\n    GROUP BY price_changes.product_id;\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;We use:\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt; JOIN latest\n      ON price_changes.product_id = latest.product_id\n    WHERE price_changes.effective_timestamp \u0026lt; latest.latest_timestamp\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;To get match the timestamp which will exclude the latest timestamp and that way we can again get the \u0026lt;code\u0026gt;MAX(price_changes.effective_timestamp) AS previous_timestamp\u0026lt;\/code\u0026gt; for the subset of the timestamp.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;This gives us all the previous timestamps i.e. the price just before the max timestamp for each product.\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;code-block\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;code-header\u0026#34;\u0026gt;\u0026lt;span class=\u0026#34;language-name\u0026#34;\u0026gt;\u0026lt;\/span\u0026gt;\u0026lt;button class=\u0026#34;copy-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-copy\u0026#34;\u0026gt;\u0026lt;rect x=\u0026#34;9\u0026#34; y=\u0026#34;9\u0026#34; width=\u0026#34;13\u0026#34; height=\u0026#34;13\u0026#34; rx=\u0026#34;2\u0026#34; ry=\u0026#34;2\u0026#34;\u0026gt;\u0026lt;\/rect\u0026gt;\u0026lt;path d=\u0026#34;M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code\u0026gt;sqlite\u0026gt; WITH latest AS (\n    SELECT price_changes.product_id,\n           price_changes.price AS current_price,\n           price_changes.effective_timestamp AS latest_timestamp\n    FROM price_changes\n    JOIN (                                                   \n        SELECT product_id, MAX(effective_timestamp) AS max_timestamp\n        FROM price_changes\n        GROUP BY product_id\n    ) latest_price_changes                             \n      ON price_changes.product_id = latest_price_changes.product_id\n     AND price_changes.effective_timestamp = latest_price_changes.max_timestamp\n) \n    SELECT price_changes.product_id,\n           price_changes.price AS previous_price,\n           MAX(price_changes.effective_timestamp) AS previous_timestamp\n    FROM price_changes\n    JOIN latest\n      ON price_changes.product_id = latest.product_id\n    WHERE price_changes.effective_timestamp \u0026lt; latest.latest_timestamp\n    GROUP BY price_changes.product_id;\n\u002b------------\u002b----------------\u002b---------------------\u002b\n| product_id | previous_price | previous_timestamp  |\n\u002b------------\u002b----------------\u002b---------------------\u002b\n| 1          | 106.91         | 2025-12-16 01:51:05 |\n| 2          | 21.38          | 2025-12-15 16:20:20 |\n| 3          | 159.65         | 2025-12-14 09:52:09 |\n| 4          | 105.6          | 2025-12-14 14:09:20 |\n| 5          | 129.23         | 2025-12-12 04:08:45 |\n| 6          | 88.97          | 2025-12-15 02:13:04 |\n| 7          | 127.14         | 2025-12-13 07:25:12 |\n| 8          | 241.99         | 2025-12-14 19:31:40 |\n| 9          | 259.56         | 2025-12-12 12:47:13 |\n| 10         | 64.88          | 2025-12-15 10:52:34 |\n...\n...\n| 140        | 157.02         | 2025-12-09 17:58:07 |\n| 141        | 73.88          | 2025-12-13 14:35:53 |\n| 142        | 30.25          | 2025-12-16 13:44:42 |\n| 143        | 143.04         | 2025-12-11 10:08:13 |\n| 144        | 114.22         | 2025-12-15 17:33:37 |\n| 146        | 65.71          | 2025-12-10 15:50:14 |\n| 148        | 101.09         | 2025-12-15 05:37:27 |\n| 149        | 86.31          | 2025-12-13 13:18:14 |\n| 150        | 123.61         | 2025-12-12 10:49:22 |\n\u002b------------\u002b----------------\u002b---------------------\u002b\nsqlite\u0026gt; \n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;Now, we need to join both of these on the same product id, to fetch both previous and current timestamp as well as the price.\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;SELECT * FROM previous JOIN latest ON previous.product_id = latest.product_id;\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;Simple\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;WITH latest AS (\n    SELECT price_changes.product_id,\n           price_changes.price AS current_price,\n           price_changes.effective_timestamp AS latest_timestamp\n    FROM price_changes\n    JOIN (                                                   \n        SELECT product_id, MAX(effective_timestamp) AS max_timestamp\n        FROM price_changes\n        GROUP BY product_id\n    ) latest_price_changes                             \n      ON price_changes.product_id = latest_price_changes.product_id\n     AND price_changes.effective_timestamp = latest_price_changes.max_timestamp\n),  previous AS (\n    SELECT price_changes.product_id,\n           price_changes.price AS previous_price,\n           MAX(price_changes.effective_timestamp) AS previous_timestamp\n    FROM price_changes\n    JOIN latest\n      ON price_changes.product_id = latest.product_id\n    WHERE price_changes.effective_timestamp \u0026lt; latest.latest_timestamp\n    GROUP BY price_changes.product_id \n)\nSELECT * FROM previous JOIN latest ON previous.product_id = latest.product_id;\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;div class=\u0026#34;code-block\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;code-header\u0026#34;\u0026gt;\u0026lt;span class=\u0026#34;language-name\u0026#34;\u0026gt;\u0026lt;\/span\u0026gt;\u0026lt;button class=\u0026#34;copy-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-copy\u0026#34;\u0026gt;\u0026lt;rect x=\u0026#34;9\u0026#34; y=\u0026#34;9\u0026#34; width=\u0026#34;13\u0026#34; height=\u0026#34;13\u0026#34; rx=\u0026#34;2\u0026#34; ry=\u0026#34;2\u0026#34;\u0026gt;\u0026lt;\/rect\u0026gt;\u0026lt;path d=\u0026#34;M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code\u0026gt;sqlite\u0026gt; WITH latest AS (\n    SELECT price_changes.product_id,\n           price_changes.price AS current_price,\n           price_changes.effective_timestamp AS latest_timestamp\n    FROM price_changes\n    JOIN (                                                   \n        SELECT product_id, MAX(effective_timestamp) AS max_timestamp\n        FROM price_changes\n        GROUP BY product_id\n    ) latest_price_changes                             \n      ON price_changes.product_id = latest_price_changes.product_id\n     AND price_changes.effective_timestamp = latest_price_changes.max_timestamp\n),  previous AS (\n    SELECT price_changes.product_id,\n           price_changes.price AS previous_price,\n           MAX(price_changes.effective_timestamp) AS previous_timestamp\n    FROM price_changes\n    JOIN latest\n      ON price_changes.product_id = latest.product_id\n    WHERE price_changes.effective_timestamp \u0026lt; latest.latest_timestamp\n    GROUP BY price_changes.product_id\n)\nSELECT * FROM previous JOIN latest ON previous.product_id = latest.product_id;\n\u002b------------\u002b----------------\u002b---------------------\u002b------------\u002b---------------\u002b---------------------\u002b\n| product_id | previous_price | previous_timestamp  | product_id | current_price |  latest_timestamp   |\n\u002b------------\u002b----------------\u002b---------------------\u002b------------\u002b---------------\u002b---------------------\u002b\n| 1          | 106.91         | 2025-12-16 01:51:05 | 1          | 109.25        | 2025-12-16 16:01:53 |\n| 2          | 21.38          | 2025-12-15 16:20:20 | 2          | 17.75         | 2025-12-16 09:28:13 |\n| 3          | 159.65         | 2025-12-14 09:52:09 | 3          | 143.65        | 2025-12-15 03:20:11 |\n| 4          | 105.6          | 2025-12-14 14:09:20 | 4          | 98.51         | 2025-12-16 01:33:41 |\n| 5          | 129.23         | 2025-12-12 04:08:45 | 5          | 124.04        | 2025-12-12 10:11:48 |\n| 6          | 88.97          | 2025-12-15 02:13:04 | 6          | 84.14         | 2025-12-15 11:31:40 |\n| 7          | 127.14         | 2025-12-13 07:25:12 | 7          | 123.09        | 2025-12-16 03:00:51 |\n| 8          | 241.99         | 2025-12-14 19:31:40 | 8          | 221.06        | 2025-12-15 22:33:48 |\n| 9          | 259.56         | 2025-12-12 12:47:13 | 9          | 255.88        | 2025-12-15 20:05:34 |\n| 10         | 64.88          | 2025-12-15 10:52:34 | 10         | 57.99         | 2025-12-15 20:53:45 |\n...\n...\n| 139        | 15.26          | 2025-12-12 03:43:32 | 139        | 16.41         | 2025-12-16 04:46:33 |\n| 140        | 157.02         | 2025-12-09 17:58:07 | 140        | 173.05        | 2025-12-16 21:19:30 |\n| 141        | 73.88          | 2025-12-13 14:35:53 | 141        | 69.97         | 2025-12-15 09:50:36 |\n| 142        | 30.25          | 2025-12-16 13:44:42 | 142        | 35.05         | 2025-12-16 18:39:51 |\n| 143        | 143.04         | 2025-12-11 10:08:13 | 143        | 153.94        | 2025-12-15 07:27:06 |\n| 144        | 114.22         | 2025-12-15 17:33:37 | 144        | 118.21        | 2025-12-16 16:25:16 |\n| 146        | 65.71          | 2025-12-10 15:50:14 | 146        | 54.73         | 2025-12-13 07:07:19 |\n| 148        | 101.09         | 2025-12-15 05:37:27 | 148        | 107.81        | 2025-12-16 09:30:11 |\n| 149        | 86.31          | 2025-12-13 13:18:14 | 149        | 72.6          | 2025-12-13 16:40:21 |\n| 150        | 123.61         | 2025-12-12 10:49:22 | 150        | 138.66        | 2025-12-13 08:24:43 |\n\u002b------------\u002b----------------\u002b---------------------\u002b------------\u002b---------------\u002b---------------------\u002b\nsqlite\u0026gt; \n\n\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;Now, we are getting somewhere, we just need to find the difference right?\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Yes, but more JOINs\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;We need the product_name from the \u0026lt;code\u0026gt;product\u0026lt;\/code\u0026gt; table. Almost forgot that table exists?\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;SELECT \n    *\nFROM \n    products \nJOIN latest \n    ON products.product_id = latest.product_id \nLEFT JOIN previous \n    ON products.product_id = previous.product_id;\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;We need both right? So, we need to fetch the product id and join for the latest and the previous table from the CTE, joining on the \u0026lt;code\u0026gt;product_id\u0026lt;\/code\u0026gt;.\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;WITH latest AS (                                        \n    SELECT price_changes.product_id,\n           price_changes.price AS current_price,\n           price_changes.effective_timestamp AS latest_timestamp\n    FROM price_changes\n    JOIN (                                                   \n        SELECT product_id, MAX(effective_timestamp) AS max_timestamp\n        FROM price_changes\n        GROUP BY product_id\n    ) latest_price_changes                             \n      ON price_changes.product_id = latest_price_changes.product_id\n     AND price_changes.effective_timestamp = latest_price_changes.max_timestamp\n),  previous AS (\n    SELECT price_changes.product_id,\n           price_changes.price AS previous_price,\n           MAX(price_changes.effective_timestamp) AS previous_timestamp\n    FROM price_changes\n    JOIN latest\n      ON price_changes.product_id = latest.product_id\n    WHERE price_changes.effective_timestamp \u0026lt; latest.latest_timestamp\n    GROUP BY price_changes.product_id\n)\nSELECT \n    *\nFROM \n    products \nJOIN latest \n    ON products.product_id = latest.product_id \nLEFT JOIN previous \n    ON products.product_id = previous.product_id;\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;div class=\u0026#34;code-block\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;code-header\u0026#34;\u0026gt;\u0026lt;span class=\u0026#34;language-name\u0026#34;\u0026gt;\u0026lt;\/span\u0026gt;\u0026lt;button class=\u0026#34;copy-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-copy\u0026#34;\u0026gt;\u0026lt;rect x=\u0026#34;9\u0026#34; y=\u0026#34;9\u0026#34; width=\u0026#34;13\u0026#34; height=\u0026#34;13\u0026#34; rx=\u0026#34;2\u0026#34; ry=\u0026#34;2\u0026#34;\u0026gt;\u0026lt;\/rect\u0026gt;\u0026lt;path d=\u0026#34;M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code\u0026gt;sqlite\u0026gt; WITH latest AS (                                        \n    SELECT price_changes.product_id,\n           price_changes.price AS current_price,\n           price_changes.effective_timestamp AS latest_timestamp\n    FROM price_changes\n    JOIN (                                                   \n        SELECT product_id, MAX(effective_timestamp) AS max_timestamp\n        FROM price_changes\n        GROUP BY product_id\n    ) latest_price_changes                             \n      ON price_changes.product_id = latest_price_changes.product_id\n     AND price_changes.effective_timestamp = latest_price_changes.max_timestamp\n),  previous AS (\n    SELECT price_changes.product_id,\n           price_changes.price AS previous_price,\n           MAX(price_changes.effective_timestamp) AS previous_timestamp\n    FROM price_changes\n    JOIN latest\n      ON price_changes.product_id = latest.product_id\n    WHERE price_changes.effective_timestamp \u0026lt; latest.latest_timestamp\n    GROUP BY price_changes.product_id\n)\nSELECT * FROM products JOIN latest ON products.product_id = latest.product_id \n   ...\u0026gt; LEFT JOIN previous ON products.product_id = previous.product_id;\n\u002b------------\u002b-----------------------------------\u002b------------\u002b---------------\u002b---------------------\u002b------------\u002b----------------\u002b---------------------\u002b\n| product_id |           product_name            | product_id | current_price |  latest_timestamp   | product_id | previous_price | previous_timestamp  |\n\u002b------------\u002b-----------------------------------\u002b------------\u002b---------------\u002b---------------------\u002b------------\u002b----------------\u002b---------------------\u002b\n| 1          | Deluxe Sled                       | 1          | 109.25        | 2025-12-16 16:01:53 | 1          | 106.91         | 2025-12-16 01:51:05 |\n| 2          | Holiday Trail Mix Trio            | 2          | 17.75         | 2025-12-16 09:28:13 | 2          | 21.38          | 2025-12-15 16:20:20 |\n| 3          | Premium Cinnamon Roasted Almonds  | 3          | 143.65        | 2025-12-15 03:20:11 | 3          | 159.65         | 2025-12-14 09:52:09 |\n| 4          | Deluxe Wrapping Paper             | 4          | 98.51         | 2025-12-16 01:33:41 | 4          | 105.6          | 2025-12-14 14:09:20 |\n| 5          | Deluxe Roasted Cashews            | 5          | 124.04        | 2025-12-12 10:11:48 | 5          | 129.23         | 2025-12-12 04:08:45 |\n| 6          | Festive Cookware Set              | 6          | 84.14         | 2025-12-15 11:31:40 | 6          | 88.97          | 2025-12-15 02:13:04 |\n| 7          | Deluxe Mug                        | 7          | 123.09        | 2025-12-16 03:00:51 | 7          | 127.14         | 2025-12-13 07:25:12 |\n| 8          | Premium Sled                      | 8          | 221.06        | 2025-12-15 22:33:48 | 8          | 241.99         | 2025-12-14 19:31:40 |\n| 9          | Essential Sled                    | 9          | 255.88        | 2025-12-15 20:05:34 | 9          | 259.56         | 2025-12-12 12:47:13 |\n| 10         | Family Snow Boots                 | 10         | 57.99         | 2025-12-15 20:53:45 | 10         | 64.88          | 2025-12-15 10:52:34 |\n...\n...\n| 140        | Classic Mug                       | 140        | 173.05        | 2025-12-16 21:19:30 | 140        | 157.02         | 2025-12-09 17:58:07 |\n| 141        | Family Fruit Assortment           | 141        | 69.97         | 2025-12-15 09:50:36 | 141        | 73.88          | 2025-12-13 14:35:53 |\n| 142        | Classic Ornament                  | 142        | 35.05         | 2025-12-16 18:39:51 | 142        | 30.25          | 2025-12-16 13:44:42 |\n| 143        | Essential Ornament                | 143        | 153.94        | 2025-12-15 07:27:06 | 143        | 143.04         | 2025-12-11 10:08:13 |\n| 144        | Premium Trail Mix Trio            | 144        | 118.21        | 2025-12-16 16:25:16 | 144        | 114.22         | 2025-12-15 17:33:37 |\n| 146        | Premium Book Collection           | 146        | 54.73         | 2025-12-13 07:07:19 | 146        | 65.71          | 2025-12-10 15:50:14 |\n| 148        | Cozy Trail Mix Trio               | 148        | 107.81        | 2025-12-16 09:30:11 | 148        | 101.09         | 2025-12-15 05:37:27 |\n| 149        | Family Cheddar Popcorn            | 149        | 72.6          | 2025-12-13 16:40:21 | 149        | 86.31          | 2025-12-13 13:18:14 |\n| 150        | Holiday Headphones                | 150        | 138.66        | 2025-12-13 08:24:43 | 150        | 123.61         | 2025-12-12 10:49:22 |\n\u002b------------\u002b-----------------------------------\u002b------------\u002b---------------\u002b---------------------\u002b------------\u002b----------------\u002b---------------------\u002b\nsqlite\u0026gt; \n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;Now, we just want\u0026lt;\/p\u0026gt;\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;product_name\u0026lt;\/li\u0026gt;\n\u0026lt;li\u0026gt;previous_price\u0026lt;\/li\u0026gt;\n\u0026lt;li\u0026gt;current_price\u0026lt;\/li\u0026gt;\n\u0026lt;li\u0026gt;difference of current_price and previous price\u0026lt;\/li\u0026gt;\n\u0026lt;\/ul\u0026gt;\n\u0026lt;p\u0026gt;So,\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;WITH latest AS (                                        \n    SELECT price_changes.product_id,\n           price_changes.price AS current_price,\n           price_changes.effective_timestamp AS latest_timestamp\n    FROM price_changes\n    JOIN (                                                   \n        SELECT product_id, MAX(effective_timestamp) AS max_timestamp\n        FROM price_changes\n        GROUP BY product_id\n    ) latest_price_changes                             \n      ON price_changes.product_id = latest_price_changes.product_id\n     AND price_changes.effective_timestamp = latest_price_changes.max_timestamp\n),  previous AS (\n    SELECT price_changes.product_id,\n           price_changes.price AS previous_price,\n           MAX(price_changes.effective_timestamp) AS previous_timestamp\n    FROM price_changes\n    JOIN latest\n      ON price_changes.product_id = latest.product_id\n    WHERE price_changes.effective_timestamp \u0026lt; latest.latest_timestamp\n    GROUP BY price_changes.product_id\n)\nSELECT \n    products.product_name, \n    latest.current_price, \n    previous.previous_price, \n    (latest.current_price - previous.previous_price) as price_difference\nFROM \n    products \nJOIN latest \n    ON products.product_id = latest.product_id \nLEFT JOIN previous \n    ON products.product_id = previous.product_id;\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;div class=\u0026#34;code-block\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;code-header\u0026#34;\u0026gt;\u0026lt;span class=\u0026#34;language-name\u0026#34;\u0026gt;\u0026lt;\/span\u0026gt;\u0026lt;button class=\u0026#34;copy-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-copy\u0026#34;\u0026gt;\u0026lt;rect x=\u0026#34;9\u0026#34; y=\u0026#34;9\u0026#34; width=\u0026#34;13\u0026#34; height=\u0026#34;13\u0026#34; rx=\u0026#34;2\u0026#34; ry=\u0026#34;2\u0026#34;\u0026gt;\u0026lt;\/rect\u0026gt;\u0026lt;path d=\u0026#34;M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code\u0026gt;sqlite\u0026gt; WITH latest AS (                                        \n    SELECT price_changes.product_id,\n           price_changes.price AS current_price,\n           price_changes.effective_timestamp AS latest_timestamp\n    FROM price_changes\n    JOIN (                                                   \n        SELECT product_id, MAX(effective_timestamp) AS max_timestamp\n        FROM price_changes\n        GROUP BY product_id\n    ) latest_price_changes                             \n      ON price_changes.product_id = latest_price_changes.product_id\n     AND price_changes.effective_timestamp = latest_price_changes.max_timestamp\n),  previous AS (\n    SELECT price_changes.product_id,\n           price_changes.price AS previous_price,\n           MAX(price_changes.effective_timestamp) AS previous_timestamp\n    FROM price_changes\n    JOIN latest\n      ON price_changes.product_id = latest.product_id\n    WHERE price_changes.effective_timestamp \u0026lt; latest.latest_timestamp\n    GROUP BY price_changes.product_id\n)\nSELECT \n    products.product_name, latest.current_price, previous.previous_price, (latest.current_price - previous.previous_price) as price_difference\nFROM \n    products \nJOIN latest \n    ON products.product_id = latest.product_id \nLEFT JOIN previous \n    ON products.product_id = previous.product_id;\n\n\u002b-----------------------------------\u002b---------------\u002b----------------\u002b-------------------\u002b\n|           product_name            | current_price | previous_price | price_difference  |\n\u002b-----------------------------------\u002b---------------\u002b----------------\u002b-------------------\u002b\n| Deluxe Sled                       | 109.25        | 106.91         | 2.34              |\n| Holiday Trail Mix Trio            | 17.75         | 21.38          | -3.63             |\n| Premium Cinnamon Roasted Almonds  | 143.65        | 159.65         | -16.0             |\n| Deluxe Wrapping Paper             | 98.51         | 105.6          | -7.08999999999999 |\n| Deluxe Roasted Cashews            | 124.04        | 129.23         | -5.18999999999998 |\n| Festive Cookware Set              | 84.14         | 88.97          | -4.83             |\n| Deluxe Mug                        | 123.09        | 127.14         | -4.05             |\n| Premium Sled                      | 221.06        | 241.99         | -20.93            |\n| Essential Sled                    | 255.88        | 259.56         | -3.68000000000001 |\n...\n...\n| Classic Ornament                  | 35.05         | 30.25          | 4.8               |\n| Essential Ornament                | 153.94        | 143.04         | 10.9              |\n| Premium Trail Mix Trio            | 118.21        | 114.22         | 3.98999999999999  |\n| Premium Book Collection           | 54.73         | 65.71          | -10.98            |\n| Cozy Trail Mix Trio               | 107.81        | 101.09         | 6.72              |\n| Family Cheddar Popcorn            | 72.6          | 86.31          | -13.71            |\n| Holiday Headphones                | 138.66        | 123.61         | 15.05             |\n\u002b-----------------------------------\u002b---------------\u002b----------------\u002b-------------------\u002b\nsqlite\u0026gt; \n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;Oh ok! That is it!\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;CTEs and some nasty number of JOINs.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Can we do it some other ways?\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Of course we can, and we will\u0026lt;\/p\u0026gt;\n\u0026lt;h3 id=\u0026#34;row-number---window-function\u0026#34;\u0026gt;ROW NUMBER - Window Function\u0026lt;\/h3\u0026gt;\n\u0026lt;p\u0026gt;We can even use some window functions because we are doing things per product so we can leverage \u0026lt;a href=\u0026#34;https:\/\/sqlite.org\/windowfunctions.html#:~:text=in%20window%20functions%3A-,row_number(),-The%20number%20of\u0026#34;\u0026gt;ROW_NUMBER\u0026lt;\/a\u0026gt; in our case.\u0026lt;\/p\u0026gt;\n\u0026lt;blockquote\u0026gt;\n\u0026lt;p\u0026gt;ROW_NUMBER: The number of the row within the current partition. Rows are numbered starting from 1 in the order defined by the ORDER BY clause in the window definition, or in arbitrary order otherwise.\u0026lt;\/p\u0026gt;\n\u0026lt;\/blockquote\u0026gt;\n\u0026lt;p\u0026gt;So, we can partition by \u0026lt;code\u0026gt;product_id\u0026lt;\/code\u0026gt; in the \u0026lt;code\u0026gt;price_changes\u0026lt;\/code\u0026gt; table and order by the timestamp (latest first i.e. descending) and grab the first two prices.\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;WITH ranked_prices AS (\n    SELECT price_changes.*,\n           ROW_NUMBER() OVER (\n               PARTITION BY price_changes.product_id\n               ORDER BY price_changes.effective_timestamp DESC\n           ) AS row_number\n    FROM price_changes\n)\nSELECT\n    *\nFROM ranked_prices;\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;Here, we just partitioned the price table based on the latest to oldest timestamp (descending) and added the other column \u0026lt;code\u0026gt;row_number\u0026lt;\/code\u0026gt; that will be further used to get the \u0026lt;code\u0026gt;previous\u0026lt;\/code\u0026gt; and the \u0026lt;code\u0026gt;current\u0026lt;\/code\u0026gt; price and time.\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;code-block\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;code-header\u0026#34;\u0026gt;\u0026lt;span class=\u0026#34;language-name\u0026#34;\u0026gt;\u0026lt;\/span\u0026gt;\u0026lt;button class=\u0026#34;copy-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-copy\u0026#34;\u0026gt;\u0026lt;rect x=\u0026#34;9\u0026#34; y=\u0026#34;9\u0026#34; width=\u0026#34;13\u0026#34; height=\u0026#34;13\u0026#34; rx=\u0026#34;2\u0026#34; ry=\u0026#34;2\u0026#34;\u0026gt;\u0026lt;\/rect\u0026gt;\u0026lt;path d=\u0026#34;M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code\u0026gt;sqlite\u0026gt; WITH ranked_prices AS (\n    SELECT price_changes.*,\n           ROW_NUMBER() OVER (\n               PARTITION BY price_changes.product_id\n               ORDER BY price_changes.effective_timestamp DESC\n           ) AS row_number\n    FROM price_changes\n)\nSELECT\n    *\nFROM ranked_prices;\n\u002b------\u002b------------\u002b--------\u002b---------------------\u002b------------\u002b\n|  id  | product_id | price  | effective_timestamp | row_number |\n\u002b------\u002b------------\u002b--------\u002b---------------------\u002b------------\u002b\n| 15   | 1          | 109.25 | 2025-12-16 16:01:53 | 1          |\n| 14   | 1          | 106.91 | 2025-12-16 01:51:05 | 2          |\n| 13   | 1          | 100.18 | 2025-12-14 15:58:03 | 3          |\n| 12   | 1          | 99.03  | 2025-12-12 02:58:14 | 4          |\n| 11   | 1          | 88.2   | 2025-12-12 02:21:09 | 5          |\n| 10   | 1          | 73.9   | 2025-12-10 14:33:43 | 6          |\n| 9    | 1          | 80.24  | 2025-12-08 16:11:11 | 7          |\n| 8    | 1          | 78.88  | 2025-12-08 06:45:39 | 8          |\n| 7    | 1          | 80.88  | 2025-12-07 10:43:54 | 9          |\n| 6    | 1          | 88.49  | 2025-12-06 19:02:40 | 10         |\n| 5    | 1          | 98.57  | 2025-12-04 04:14:31 | 11         |\n| 4    | 1          | 119.12 | 2025-12-03 10:14:35 | 12         |\n| 3    | 1          | 126.78 | 2025-12-02 18:40:38 | 13         |\n| 2    | 1          | 148.63 | 2025-12-02 18:15:33 | 14         |\n| 1    | 1          | 148.28 | 2025-12-01 05:25:35 | 15         |\n...\n...\n| 1260 | 149        | 167.1  | 2025-12-01 06:36:43 | 15         |\n| 1288 | 150        | 138.66 | 2025-12-13 08:24:43 | 1          |\n| 1287 | 150        | 123.61 | 2025-12-12 10:49:22 | 2          |\n| 1286 | 150        | 141.8  | 2025-12-10 07:06:06 | 3          |\n| 1285 | 150        | 122.16 | 2025-12-09 20:01:54 | 4          |\n| 1284 | 150        | 122.06 | 2025-12-06 22:27:41 | 5          |\n| 1283 | 150        | 128.6  | 2025-12-06 13:03:18 | 6          |\n| 1282 | 150        | 154.72 | 2025-12-05 08:15:08 | 7          |\n| 1281 | 150        | 170.3  | 2025-12-04 15:25:50 | 8          |\n| 1280 | 150        | 156.51 | 2025-12-03 19:11:12 | 9          |\n| 1279 | 150        | 161.93 | 2025-12-02 02:47:10 | 10         |\n| 1278 | 150        | 174.36 | 2025-12-02 01:39:14 | 11         |\n| 1277 | 150        | 180.17 | 2025-12-01 20:36:02 | 12         |\n| 1276 | 150        | 164.35 | 2025-12-01 07:09:29 | 13         |\n| 1275 | 150        | 141    | 2025-12-01 01:29:46 | 14         |\n\u002b------\u002b------------\u002b--------\u002b---------------------\u002b------------\u002b\n\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;WITH ranked_prices AS (\n    SELECT price_changes.*,\n           ROW_NUMBER() OVER (\n               PARTITION BY price_changes.product_id\n               ORDER BY price_changes.effective_timestamp DESC\n           ) AS row_number\n    FROM price_changes\n)\nSELECT\n    products.product_name,\n    current_price.price AS current_price,\n    previous_price.price AS previous_price,\n    current_price.price - previous_price.price AS price_difference\nFROM products\nLEFT JOIN ranked_prices AS current_price\n       ON products.product_id = current_price.product_id\n      AND current_price.row_number = 1\nLEFT JOIN ranked_prices AS previous_price\n       ON products.product_id = previous_price.product_id\n      AND previous_price.row_number = 2;\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;This is pretty simple, we just get\u0026lt;\/p\u0026gt;\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;the \u0026lt;code\u0026gt;current_price\u0026lt;\/code\u0026gt; as \u0026lt;code\u0026gt;row_number = 1\u0026lt;\/code\u0026gt; from the \u0026lt;code\u0026gt;ranked_prices\u0026lt;\/code\u0026gt; CTE\u0026lt;\/li\u0026gt;\n\u0026lt;li\u0026gt;the \u0026lt;code\u0026gt;previous_price\u0026lt;\/code\u0026gt; as \u0026lt;code\u0026gt;row_number = 2\u0026lt;\/code\u0026gt; from the \u0026lt;code\u0026gt;ranked_prices\u0026lt;\/code\u0026gt; CTE\u0026lt;\/li\u0026gt;\n\u0026lt;\/ul\u0026gt;\n\u0026lt;p\u0026gt;We got all we needed as:\u0026lt;\/p\u0026gt;\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;code\u0026gt;products.product_name\u0026lt;\/code\u0026gt;\u0026lt;\/li\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;code\u0026gt;current_price.price AS current_price\u0026lt;\/code\u0026gt;\u0026lt;\/li\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;code\u0026gt;previous_price.price AS previous_price\u0026lt;\/code\u0026gt;\u0026lt;\/li\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;code\u0026gt;current_price.price - previous_price.price AS price_difference\u0026lt;\/code\u0026gt;\u0026lt;\/li\u0026gt;\n\u0026lt;\/ul\u0026gt;\n\u0026lt;p\u0026gt;So, this is how \u0026lt;code\u0026gt;ROW_NUMBER\u0026lt;\/code\u0026gt; can be used here.\u0026lt;\/p\u0026gt;\n\u0026lt;h3 id=\u0026#34;with-lead-lag---window-functions\u0026#34;\u0026gt;With LEAD LAG - Window Functions\u0026lt;\/h3\u0026gt;\n\u0026lt;p\u0026gt;We can also use [LEAD](https:\/\/sqlite.org\/windowfunctions.html#:~:text=does%20not%20exist.-,lead(expr),-lead(expr%2C%20offset) and [LAG](https:\/\/sqlite.org\/windowfunctions.html#:~:text=a%20part%20of.-,lag(expr),-lag(expr%2C%20offset) window functions here. We can specifically use \u0026lt;code\u0026gt;LAG\u0026lt;\/code\u0026gt; as it was a challenge to get the second latest timestamped price.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;We will partition the \u0026lt;code\u0026gt;price_changes\u0026lt;\/code\u0026gt; table on the \u0026lt;code\u0026gt;product_id\u0026lt;\/code\u0026gt; and order it by the \u0026lt;code\u0026gt;effective_timestamp\u0026lt;\/code\u0026gt;. This will give us the row before the timestamp of the current one, so the first row for each product can be empty (if sorted in ascending order of timestamp since there is no before row for the first row)\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt; WITH lagged_prices AS (\n    SELECT\n        product_id,\n        price AS current_price,\n        LAG(price) OVER (\n            PARTITION BY product_id\n            ORDER BY effective_timestamp\n        ) AS previous_price,\n        effective_timestamp\n    FROM price_changes\n)\nSELECT * FROM lagged_prices;\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;Here, we simply selected the data that we need, \u0026lt;code\u0026gt;product_id\u0026lt;\/code\u0026gt;, \u0026lt;code\u0026gt;price\u0026lt;\/code\u0026gt; as the \u0026lt;code\u0026gt;current_price\u0026lt;\/code\u0026gt; since we can order by latest timestamp.\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;code-block\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;code-header\u0026#34;\u0026gt;\u0026lt;span class=\u0026#34;language-name\u0026#34;\u0026gt;\u0026lt;\/span\u0026gt;\u0026lt;button class=\u0026#34;copy-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-copy\u0026#34;\u0026gt;\u0026lt;rect x=\u0026#34;9\u0026#34; y=\u0026#34;9\u0026#34; width=\u0026#34;13\u0026#34; height=\u0026#34;13\u0026#34; rx=\u0026#34;2\u0026#34; ry=\u0026#34;2\u0026#34;\u0026gt;\u0026lt;\/rect\u0026gt;\u0026lt;path d=\u0026#34;M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code\u0026gt;sqlite\u0026gt; WITH lagged_prices AS (\n    SELECT\n        product_id,\n        price AS current_price,\n        LAG(price) OVER (\n            PARTITION BY product_id\n            ORDER BY effective_timestamp\n        ) AS previous_price,\n        effective_timestamp\n    FROM price_changes\n)\nSELECT * FROM lagged_prices;\n\u002b------------\u002b---------------\u002b----------------\u002b---------------------\u002b\n| product_id | current_price | previous_price | effective_timestamp |\n\u002b------------\u002b---------------\u002b----------------\u002b---------------------\u002b\n| 1          | 148.28        |                | 2025-12-01 05:25:35 |\n| 1          | 148.63        | 148.28         | 2025-12-02 18:15:33 |\n| 1          | 126.78        | 148.63         | 2025-12-02 18:40:38 |\n| 1          | 119.12        | 126.78         | 2025-12-03 10:14:35 |\n| 1          | 98.57         | 119.12         | 2025-12-04 04:14:31 |\n| 1          | 88.49         | 98.57          | 2025-12-06 19:02:40 |\n| 1          | 80.88         | 88.49          | 2025-12-07 10:43:54 |\n| 1          | 78.88         | 80.88          | 2025-12-08 06:45:39 |\n| 1          | 80.24         | 78.88          | 2025-12-08 16:11:11 |\n| 1          | 73.9          | 80.24          | 2025-12-10 14:33:43 |\n| 1          | 88.2          | 73.9           | 2025-12-12 02:21:09 |\n| 1          | 99.03         | 88.2           | 2025-12-12 02:58:14 |\n| 1          | 100.18        | 99.03          | 2025-12-14 15:58:03 |\n| 1          | 106.91        | 100.18         | 2025-12-16 01:51:05 |\n| 1          | 109.25        | 106.91         | 2025-12-16 16:01:53 |\n| 2          | 29.54         |                | 2025-12-03 14:21:10 |\n| 2          | 34.33         | 29.54          | 2025-12-03 19:14:31 |\n| 2          | 39.08         | 34.33          | 2025-12-04 06:13:48 |\n| 2          | 32.71         | 39.08          | 2025-12-04 18:33:17 |\n| 2          | 31.71         | 32.71          | 2025-12-05 22:36:14 |\n| 2          | 28.88         | 31.71          | 2025-12-06 02:42:02 |\n...\n...\n| 149        | 101.03        | 98.4           | 2025-12-10 00:37:46 |\n| 149        | 95.68         | 101.03         | 2025-12-13 01:10:53 |\n| 149        | 86.31         | 95.68          | 2025-12-13 13:18:14 |\n| 149        | 72.6          | 86.31          | 2025-12-13 16:40:21 |\n| 150        | 141           |                | 2025-12-01 01:29:46 |\n| 150        | 164.35        | 141            | 2025-12-01 07:09:29 |\n| 150        | 180.17        | 164.35         | 2025-12-01 20:36:02 |\n| 150        | 174.36        | 180.17         | 2025-12-02 01:39:14 |\n| 150        | 161.93        | 174.36         | 2025-12-02 02:47:10 |\n| 150        | 156.51        | 161.93         | 2025-12-03 19:11:12 |\n| 150        | 170.3         | 156.51         | 2025-12-04 15:25:50 |\n| 150        | 154.72        | 170.3          | 2025-12-05 08:15:08 |\n| 150        | 128.6         | 154.72         | 2025-12-06 13:03:18 |\n| 150        | 122.06        | 128.6          | 2025-12-06 22:27:41 |\n| 150        | 122.16        | 122.06         | 2025-12-09 20:01:54 |\n| 150        | 141.8         | 122.16         | 2025-12-10 07:06:06 |\n| 150        | 123.61        | 141.8          | 2025-12-12 10:49:22 |\n| 150        | 138.66        | 123.61         | 2025-12-13 08:24:43 |\n\u002b------------\u002b---------------\u002b----------------\u002b---------------------\u002b\n\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;Then we can join. The conditions are important to filter.\u0026lt;\/p\u0026gt;\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;we get the lagged time stamp where we want the max of the timestamp since the latest timestamp will have the lagging timestamp for it from the CTE of lagged_prices and current_price as well.\u0026lt;\/li\u0026gt;\n\u0026lt;\/ul\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;SELECT\n    products.product_name,\n    lagged_prices.current_price,\n    lagged_prices.previous_price,\n    lagged_prices.current_price - lagged_prices.previous_price AS price_difference\nFROM products\nJOIN lagged_prices\n  ON products.product_id = lagged_prices.product_id\nWHERE lagged_prices.effective_timestamp = (\n    SELECT MAX(effective_timestamp)\n    FROM price_changes\n    WHERE product_id = products.product_id\n);\n\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;WITH lagged_prices AS (\n    SELECT\n        product_id,\n        price AS current_price,\n        LAG(price) OVER (\n            PARTITION BY product_id\n            ORDER BY effective_timestamp\n        ) AS previous_price,\n        effective_timestamp\n    FROM price_changes\n)\nSELECT\n    products.product_name,\n    lagged_prices.current_price,\n    lagged_prices.previous_price,\n    lagged_prices.current_price - lagged_prices.previous_price AS price_difference\nFROM products\nJOIN lagged_prices\n  ON products.product_id = lagged_prices.product_id\nWHERE lagged_prices.effective_timestamp = (\n    SELECT MAX(effective_timestamp)\n    FROM price_changes\n    WHERE product_id = products.product_id\n);\n\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;This yields the same result.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;This is all big, any smaller queries?\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Not quite small.\u0026lt;\/p\u0026gt;\n\u0026lt;h3 id=\u0026#34;limit-offset-and-cte\u0026#34;\u0026gt;LIMIT OFFSET and CTE\u0026lt;\/h3\u0026gt;\n\u0026lt;p\u0026gt;Well here\u0026#39;s a little short, but quite dirty.\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;SELECT *,\n       current_price - previous_price AS price_difference\nFROM (\n    SELECT\n        products.product_name,\n        (SELECT price\n         FROM price_changes\n         WHERE price_changes.product_id = products.product_id\n         ORDER BY effective_timestamp DESC\n         LIMIT 1) AS current_price,\n        (SELECT price\n         FROM price_changes\n         WHERE price_changes.product_id = products.product_id\n         ORDER BY effective_timestamp DESC\n         LIMIT 1 OFFSET 1) AS previous_price\n    FROM products\n);\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;This basically grabs the  price from the latest timestamp and the 2nd timestamp with offset and wraps it in a CTE to compute the difference.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Pretty slick if you ask me.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;But hey! I am done for this!\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;It was a great problem.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Getting data behind certain data is quite relatable and challenging enough to explore window functions and what not.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;That\u0026#39;s it from day 8.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;See you tomorrow for day 9!\u0026lt;\/p\u0026gt;\n"
    }
    </script>
    
    
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="/code-block.css">
    <link rel="stylesheet" href="/post-navigation.css">
    
    <link rel="icon" href="/tbicon.png" type="image/png">
    <link rel="apple-touch-icon" href="/tbicon.png">
    
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <link id="syntax-theme" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/go.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.13.0/sql-wasm.js"></script>
    <link rel="stylesheet" href="/sql-playground.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/monokai.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/sql/sql.min.js"></script>
    <script src="/sql-playground.js"></script>
    
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script>
    document.addEventListener("DOMContentLoaded", () => {
        const body = document.body;
        const stylesheet = document.getElementById("syntax-theme");
        const themeToggle = document.getElementById('theme-toggle');

        function setSyntaxTheme(theme) {
            if (theme === "secondary") {
                stylesheet.href = "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css";
            } else {
                stylesheet.href = "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css";
            }
        }

        
        document.querySelectorAll("pre code").forEach((block) => {
            hljs.highlightElement(block);
        });

        
        const currentTheme = localStorage.getItem("theme") || "default";
        if (currentTheme === "secondary") {
            body.classList.add("secondary-theme");
            if (themeToggle) themeToggle.checked = true;
        }
        setSyntaxTheme(currentTheme);

        
        if (themeToggle) {
            themeToggle.addEventListener('change', () => {
                const newTheme = themeToggle.checked ? 'secondary' : 'default';
                if (themeToggle.checked) {
                    body.classList.add('secondary-theme');
                } else {
                    body.classList.remove('secondary-theme');
                }
                localStorage.setItem('theme', newTheme);
                setSyntaxTheme(newTheme);
            });
        }
        
        
        const editBtn = document.getElementById('editor-edit');
        if (editBtn) {
            editBtn.addEventListener('click', async function () {
                const slug = "sqlog\/advent-of-sql-2025-day-8";
                const type = "sqlog";
                console.log("Editing post:", slug, type);
                const url = "https:\/\/devmeetgor.netlify.app/.netlify/functions/api?slug=" + slug + "&method=edit&type=" + type;
                
                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error("Failed to fetch edit content");
                    const html = await res.text();
                    document.querySelector('.post-content').innerHTML = html;
                } catch (err) {
                    console.error(err);
                    alert("Error loading editor content");
                }
            });
        }
    });
    </script>
    
    
    <script src="/seasonal-effects.js" defer></script>
    
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EET2ZX4QY1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-EET2ZX4QY1');
    </script>
</head>
<body>
    <header class="header">
  <a class="site-title" href="/" aria-label="Meet Gor - Home">Meet Gor</a>
  <nav>
    <ul>
      <li><a href="/" aria-label="Home">Home</a></li>
      <li><a href="/posts" aria-label="Posts">Posts</a></li>
      <li><a href="/all-content" aria-label="All Content">All Content</a></li>
      <li><a href="/about" aria-label="About">About</a></li>
      <li><a href="/contact" aria-label="Contact">Contact</a></li>
    </ul>
  </nav>
  <div class="theme-switch">
    <input type="checkbox" id="theme-toggle" aria-label="Toggle Theme">
    <label for="theme-toggle"></label>
  </div>
  
</header>
    
    <main class="container">
        <article class="blog-post">
            <h1>Advent of SQL 2025 Day 8: Product Catalog</h1>
            
            <div class="post-meta">
                Published on  <time datetime="2025-12-23 15:30 &#43;0530">2025-12-23 15:30 &#43;0530</time>
            </div>
            
            <div class="post-meta">
                Type: <a href="/sqlog">sqlog</a>
            </div>
            
            <div class="post-meta tags">
                <span class="post-series-label"> Tags:</span>
                
                <a href="/tags/sqlite">#sqlite</a>
                
                <a href="/tags/sql">#sql</a>
                
                <a href="/tags/advent-of-sql">#advent-of-sql</a>
                
            </div>
            
            
            <div class="post-series">
                <span class="series-label">Part of the
                <span class="series-list">
                    
                    <a href="/series/advent-of-sql-2025" class="series-link"> advent-of-sql-2025</a>
                    
                </span></span>
                <span class="series-label">series</span>
            </div>
            
            
            
            
            <hr>
            
            <div class="post-content">
                <h2 id="advent-of-sql---day-8-product-catalog">Advent of SQL - Day 8, Product Catalog</h2>
<p>Whopsies! This is day 8.</p>
<p>Let's get straigh...</p>
<p>HOOH! We need to clean up some SQL for running in SQLite.</p>
<div class="code-block"><div class="code-header"><span class="language-name">bash</span><button class="copy-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button></div><pre><code class="language-bash">sed -i 's/TIMESTAMP[[:space:]]*//g' day8-inserts-sqlite.sql
</code></pre></div><p>Just cleaning up <code>TIMESTAMP</code> in <code>INSERT</code> before the date value.</p>
<p>Here we go:
The SQL to run in SQLite.</p>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">DROP TABLE IF EXISTS price_changes;
DROP TABLE IF EXISTS products;

CREATE TABLE products (
    product_id INT PRIMARY KEY,
    product_name TEXT
);

CREATE TABLE price_changes (
    id INT PRIMARY KEY,
    product_id INT,
    price NUMERIC(10,2),
    effective_timestamp 
);

INSERT INTO products (product_id, product_name) VALUES
    (1, 'Deluxe Sled'),
    (2, 'Holiday Trail Mix Trio'),
    (3, 'Premium Cinnamon Roasted Almonds'),
    (4, 'Deluxe Wrapping Paper'),
    (5, 'Deluxe Roasted Cashews'),
    (6, 'Festive Cookware Set'),
    (7, 'Deluxe Mug'),
    (8, 'Premium Sled'),
    (9, 'Essential Sled'),
    (10, 'Family Snow Boots'),
    (11, 'Family Dark Chocolate Almonds'),
    (12, 'Premium Festive Scarf'),
    (13, 'Essential Cookie Decorating Kit'),
    (14, 'Festive White Chocolate Popcorn'),
    (15, 'Cozy Puzzle'),
    (16, 'Holiday Cheddar Popcorn'),
    (17, 'Premium Board Game'),
    (18, 'Deluxe Pecan Praline Bites'),
    (19, 'Cozy Almond Brittle'),
    (20, 'Winter Sled');

INSERT INTO price_changes (id, product_id, price, effective_timestamp) VALUES
    (1, 1, 148.28, '2025-12-01 05:25:35'),
    (2, 1, 148.63, '2025-12-02 18:15:33'),
    (3, 1, 126.78, '2025-12-02 18:40:38'),
    (4, 1, 119.12, '2025-12-03 10:14:35'),
    (5, 1, 98.57, '2025-12-04 04:14:31'),
    (6, 1, 88.49, '2025-12-06 19:02:40'),
    (7, 1, 80.88, '2025-12-07 10:43:54'),
    (8, 1, 78.88, '2025-12-08 06:45:39'),
    (9, 1, 80.24, '2025-12-08 16:11:11'),
    (10, 1, 73.9, '2025-12-10 14:33:43'),
    (11, 1, 88.2, '2025-12-12 02:21:09'),
    (12, 1, 99.03, '2025-12-12 02:58:14'),
    (13, 1, 100.18, '2025-12-14 15:58:03'),
    (14, 1, 106.91, '2025-12-16 01:51:05'),
    (15, 1, 109.25, '2025-12-16 16:01:53'),
    (16, 2, 29.54, '2025-12-03 14:21:10'),
    (17, 2, 34.33, '2025-12-03 19:14:31'),
    (18, 2, 39.08, '2025-12-04 06:13:48'),
    (19, 2, 32.71, '2025-12-04 18:33:17'),
    (20, 2, 31.71, '2025-12-05 22:36:14'),
    (21, 2, 28.88, '2025-12-06 02:42:02'),
    (22, 2, 23.14, '2025-12-07 09:46:54'),
    (23, 2, 25.65, '2025-12-07 10:03:45'),
    (24, 2, 27.06, '2025-12-07 14:39:15'),
    (25, 2, 24.48, '2025-12-07 20:08:05'),
    (26, 2, 26.84, '2025-12-09 07:44:32'),
    (27, 2, 27.39, '2025-12-13 06:25:19'),
    (28, 2, 26.6, '2025-12-14 10:16:34'),
    (29, 2, 21.38, '2025-12-15 16:20:20'),
    (30, 2, 17.75, '2025-12-16 09:28:13');
</code></pre><div class="output"></div></div><p>We can get started.</p>
<h2 id="problem">Problem</h2>
<blockquote>
<p>Generate a report, using the products and <code>price_changes</code> tables for leadership that returns the <code>product_name</code>, <code>current_price</code>, <code>previous_price</code>, and the difference between the current and previous prices</p>
</blockquote>
<p>So what we need is</p>
<ul>
<li>product_name</li>
<li>current_price (latest)</li>
<li>previous_price (just before the latest)</li>
<li>price_difference = current - previous</li>
</ul>
<p>Again we have to meddle with dates, maybe, maybe not!</p>
<h3 id="with-ctes-and-joins">With CTEs and JOINs</h3>
<p>Let's start with the simplest approach. We need 2 prices, the latest(highest date timestamp) and the 2nd latest (the 2nd highest date timestamp). We can get the first pretty easily, but what about the second?</p>
<p>Well, if we get the first, then the second should be easy to get right? Right? Because it will be just before it. Well not directly.</p>
<p>Let's first grab the max timestamp.</p>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">SELECT 
    product_id,
    MAX(effective_timestamp) AS latest_timestamp
FROM price_changes
GROUP BY product_id;
</code></pre><div class="output"></div></div><div class="code-block"><div class="code-header"><span class="language-name"></span><button class="copy-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button></div><pre><code>sqlite> SELECT product_id, MAX(effective_timestamp) AS max_ts
        FROM price_changes
        GROUP BY product_id;
+------------+---------------------+
| product_id |       max_ts        |
+------------+---------------------+
| 1          | 2025-12-16 16:01:53 |
| 2          | 2025-12-16 09:28:13 |
| 3          | 2025-12-15 03:20:11 |
| 4          | 2025-12-16 01:33:41 |
| 5          | 2025-12-12 10:11:48 |
| 6          | 2025-12-15 11:31:40 |
| 7          | 2025-12-16 03:00:51 |
| 8          | 2025-12-15 22:33:48 |
| 9          | 2025-12-15 20:05:34 |
| 10         | 2025-12-15 20:53:45 |
...
...
| 139        | 2025-12-16 04:46:33 |
| 140        | 2025-12-16 21:19:30 |
| 141        | 2025-12-15 09:50:36 |
| 142        | 2025-12-16 18:39:51 |
| 143        | 2025-12-15 07:27:06 |
| 144        | 2025-12-16 16:25:16 |
| 146        | 2025-12-13 07:07:19 |
| 148        | 2025-12-16 09:30:11 |
| 149        | 2025-12-13 16:40:21 |
| 150        | 2025-12-13 08:24:43 |
+------------+---------------------+
</code></pre></div><p>We got all the timestamp's for each product. But we wanted the prices. Well we can't grab the price here, since we are grouping!</p>
<p>We can use the timestamp as we are selecting the <code>MAX</code> aggregate function however among the many rows for single product how do we group the price? <code>MIN</code>, <code>MAX</code>, <code>AVG</code>, but that's not we want, we just want the price for that timestamp.</p>
<p>Well, we need to join to the same table for that timestamp and grab the price.</p>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">SELECT 
    price_changes.product_id,
    price_changes.price AS current_price,
    price_changes.effective_timestamp AS latest_ts
FROM price_changes
JOIN (
    SELECT 
        product_id, 
        MAX(effective_timestamp) AS latest_timestamp
    FROM price_changes
    GROUP BY product_id
) AS latest_price_change
  ON price_changes.product_id = latest_price_change.product_id
 AND price_changes.effective_timestamp = latest_price_change.latest_timestamp;
</code></pre><div class="output"></div></div><p>Here, we first specify what we want</p>
<ul>
<li><code>product_id</code></li>
<li><code>current_price</code> which is the price for the</li>
<li><code>latest_timestamp</code> which is the latest time recorded for the product price.</li>
</ul>
<p>We are grouping this by <code>product_id</code> since there are price recorded and various timestamps. We need to get the latest timestamp.
So, we do a nested query to join the latest timestamp and join the price with the same timestamp.</p>
<p>This condition <code>price_changes.effective_timestamp = latest_price_change.latest_timestamp</code> helps us get the <code>price</code> for the <code>latest_timestamp</code>. We first get each timestamp for the product and then find its max, so that's the inner query from which we joined this table to. Self join with the different thing to find.</p>
<p>This gives us 2 things.</p>
<ul>
<li>Product id</li>
<li>Price for the latest timestamp</li>
</ul>
<p>We don't really want the timestamp in the final result, its just a criteria or a intermediate value to get the current and the previous prices for each product.</p>
<div class="code-block"><div class="code-header"><span class="language-name"></span><button class="copy-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button></div><pre><code>sqlite> 
sqlite> SELECT 
    price_changes.product_id,
    price_changes.price AS current_price,
    price_changes.effective_timestamp AS latest_ts
FROM price_changes
JOIN (
    SELECT 
        product_id, 
        MAX(effective_timestamp) AS latest_timestamp
    FROM price_changes
    GROUP BY product_id
) AS latest_price_change
  ON price_changes.product_id = latest_price_change.product_id
 AND price_changes.effective_timestamp = latest_price_change.latest_timestamp;
+------------+---------------+---------------------+
| product_id | current_price |      latest_ts      |
+------------+---------------+---------------------+
| 1          | 109.25        | 2025-12-16 16:01:53 |
| 2          | 17.75         | 2025-12-16 09:28:13 |
| 3          | 143.65        | 2025-12-15 03:20:11 |
| 4          | 98.51         | 2025-12-16 01:33:41 |
| 5          | 124.04        | 2025-12-12 10:11:48 |
| 6          | 84.14         | 2025-12-15 11:31:40 |
| 7          | 123.09        | 2025-12-16 03:00:51 |
| 8          | 221.06        | 2025-12-15 22:33:48 |
| 9          | 255.88        | 2025-12-15 20:05:34 |
| 10         | 57.99         | 2025-12-15 20:53:45 |
...
...
| 139        | 16.41         | 2025-12-16 04:46:33 |
| 140        | 173.05        | 2025-12-16 21:19:30 |
| 141        | 69.97         | 2025-12-15 09:50:36 |
| 142        | 35.05         | 2025-12-16 18:39:51 |
| 143        | 153.94        | 2025-12-15 07:27:06 |
| 144        | 118.21        | 2025-12-16 16:25:16 |
| 146        | 54.73         | 2025-12-13 07:07:19 |
| 148        | 107.81        | 2025-12-16 09:30:11 |
| 149        | 72.6          | 2025-12-13 16:40:21 |
| 150        | 138.66        | 2025-12-13 08:24:43 |
+------------+---------------+---------------------+
sqlite> 

</code></pre></div><p>Now, we need to the price before this max timestamp. How do we get it?</p>
<p>We need to again join? Yes...</p>
<p>We need to subquery the timestamp just before it. But how will we get the max timestamp for each product. Well that's what we wrote above.</p>
<p>We can convert that to a CTE.</p>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">
WITH latest AS (
    SELECT price_changes.product_id,
           price_changes.price AS current_price,
           price_changes.effective_timestamp AS latest_timestamp
    FROM price_changes
    JOIN (                                                   
        SELECT product_id, MAX(effective_timestamp) AS max_timestamp
        FROM price_changes
        GROUP BY product_id
    ) latest_price_changes                             
      ON price_changes.product_id = latest_price_changes.product_id
     AND price_changes.effective_timestamp = latest_price_changes.max_timestamp
)
SELECT * FROM latest;
</code></pre><div class="output"></div></div><p>We just got the same thing, however we can now use <code>latest</code> as a temporary table in the query.</p>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">WITH latest AS (
    SELECT price_changes.product_id,
           price_changes.price AS current_price,
           price_changes.effective_timestamp AS latest_timestamp
    FROM price_changes
    JOIN (                                                   
        SELECT product_id, MAX(effective_timestamp) AS max_timestamp
        FROM price_changes
        GROUP BY product_id
    ) latest_price_changes
      ON price_changes.product_id = latest_price_changes.product_id
     AND price_changes.effective_timestamp = latest_price_changes.max_timestamp
),  previous AS (
    SELECT price_changes.product_id,
           price_changes.price AS previous_price,
           MAX(price_changes.effective_timestamp) AS previous_timestamp
    FROM price_changes
    JOIN latest
      ON price_changes.product_id = latest.product_id
    WHERE price_changes.effective_timestamp < latest.latest_timestamp
    GROUP BY price_changes.product_id
)
SELECT * FROM previous JOIN latest ON previous.product_id = latest.product_id;
</code></pre><div class="output"></div></div><p>So, ok, this is getting long.</p>
<p>Just we added this</p>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">SELECT 
    price_changes.product_id,
    price_changes.price AS previous_price,
    MAX(price_changes.effective_timestamp) AS previous_timestamp
FROM price_changes
JOIN latest
    ON price_changes.product_id = latest.product_id
WHERE 
    price_changes.effective_timestamp < latest.latest_timestamp
GROUP BY price_changes.product_id
</code></pre><div class="output"></div></div><p>This won't work as we need the latest table which we converted to CTE.</p>
<p>So, to get the 2nd highest or latest timestamp for each product, we do this.</p>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">WITH latest AS (
    SELECT price_changes.product_id,
           price_changes.price AS current_price,
           price_changes.effective_timestamp AS latest_timestamp
    FROM price_changes
    JOIN (                                                   
        SELECT product_id, MAX(effective_timestamp) AS max_timestamp
        FROM price_changes
        GROUP BY product_id
    ) latest_price_changes                             
      ON price_changes.product_id = latest_price_changes.product_id
     AND price_changes.effective_timestamp = latest_price_changes.max_timestamp
) 
    SELECT price_changes.product_id,
           price_changes.price AS previous_price,
           MAX(price_changes.effective_timestamp) AS previous_timestamp
    FROM price_changes
    JOIN latest
      ON price_changes.product_id = latest.product_id
    WHERE price_changes.effective_timestamp < latest.latest_timestamp
    GROUP BY price_changes.product_id;
</code></pre><div class="output"></div></div><p>We use:</p>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql"> JOIN latest
      ON price_changes.product_id = latest.product_id
    WHERE price_changes.effective_timestamp < latest.latest_timestamp
</code></pre><div class="output"></div></div><p>To get match the timestamp which will exclude the latest timestamp and that way we can again get the <code>MAX(price_changes.effective_timestamp) AS previous_timestamp</code> for the subset of the timestamp.</p>
<p>This gives us all the previous timestamps i.e. the price just before the max timestamp for each product.</p>
<div class="code-block"><div class="code-header"><span class="language-name"></span><button class="copy-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button></div><pre><code>sqlite> WITH latest AS (
    SELECT price_changes.product_id,
           price_changes.price AS current_price,
           price_changes.effective_timestamp AS latest_timestamp
    FROM price_changes
    JOIN (                                                   
        SELECT product_id, MAX(effective_timestamp) AS max_timestamp
        FROM price_changes
        GROUP BY product_id
    ) latest_price_changes                             
      ON price_changes.product_id = latest_price_changes.product_id
     AND price_changes.effective_timestamp = latest_price_changes.max_timestamp
) 
    SELECT price_changes.product_id,
           price_changes.price AS previous_price,
           MAX(price_changes.effective_timestamp) AS previous_timestamp
    FROM price_changes
    JOIN latest
      ON price_changes.product_id = latest.product_id
    WHERE price_changes.effective_timestamp < latest.latest_timestamp
    GROUP BY price_changes.product_id;
+------------+----------------+---------------------+
| product_id | previous_price | previous_timestamp  |
+------------+----------------+---------------------+
| 1          | 106.91         | 2025-12-16 01:51:05 |
| 2          | 21.38          | 2025-12-15 16:20:20 |
| 3          | 159.65         | 2025-12-14 09:52:09 |
| 4          | 105.6          | 2025-12-14 14:09:20 |
| 5          | 129.23         | 2025-12-12 04:08:45 |
| 6          | 88.97          | 2025-12-15 02:13:04 |
| 7          | 127.14         | 2025-12-13 07:25:12 |
| 8          | 241.99         | 2025-12-14 19:31:40 |
| 9          | 259.56         | 2025-12-12 12:47:13 |
| 10         | 64.88          | 2025-12-15 10:52:34 |
...
...
| 140        | 157.02         | 2025-12-09 17:58:07 |
| 141        | 73.88          | 2025-12-13 14:35:53 |
| 142        | 30.25          | 2025-12-16 13:44:42 |
| 143        | 143.04         | 2025-12-11 10:08:13 |
| 144        | 114.22         | 2025-12-15 17:33:37 |
| 146        | 65.71          | 2025-12-10 15:50:14 |
| 148        | 101.09         | 2025-12-15 05:37:27 |
| 149        | 86.31          | 2025-12-13 13:18:14 |
| 150        | 123.61         | 2025-12-12 10:49:22 |
+------------+----------------+---------------------+
sqlite> 
</code></pre></div><p>Now, we need to join both of these on the same product id, to fetch both previous and current timestamp as well as the price.</p>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">SELECT * FROM previous JOIN latest ON previous.product_id = latest.product_id;
</code></pre><div class="output"></div></div><p>Simple</p>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">WITH latest AS (
    SELECT price_changes.product_id,
           price_changes.price AS current_price,
           price_changes.effective_timestamp AS latest_timestamp
    FROM price_changes
    JOIN (                                                   
        SELECT product_id, MAX(effective_timestamp) AS max_timestamp
        FROM price_changes
        GROUP BY product_id
    ) latest_price_changes                             
      ON price_changes.product_id = latest_price_changes.product_id
     AND price_changes.effective_timestamp = latest_price_changes.max_timestamp
),  previous AS (
    SELECT price_changes.product_id,
           price_changes.price AS previous_price,
           MAX(price_changes.effective_timestamp) AS previous_timestamp
    FROM price_changes
    JOIN latest
      ON price_changes.product_id = latest.product_id
    WHERE price_changes.effective_timestamp < latest.latest_timestamp
    GROUP BY price_changes.product_id 
)
SELECT * FROM previous JOIN latest ON previous.product_id = latest.product_id;
</code></pre><div class="output"></div></div><div class="code-block"><div class="code-header"><span class="language-name"></span><button class="copy-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button></div><pre><code>sqlite> WITH latest AS (
    SELECT price_changes.product_id,
           price_changes.price AS current_price,
           price_changes.effective_timestamp AS latest_timestamp
    FROM price_changes
    JOIN (                                                   
        SELECT product_id, MAX(effective_timestamp) AS max_timestamp
        FROM price_changes
        GROUP BY product_id
    ) latest_price_changes                             
      ON price_changes.product_id = latest_price_changes.product_id
     AND price_changes.effective_timestamp = latest_price_changes.max_timestamp
),  previous AS (
    SELECT price_changes.product_id,
           price_changes.price AS previous_price,
           MAX(price_changes.effective_timestamp) AS previous_timestamp
    FROM price_changes
    JOIN latest
      ON price_changes.product_id = latest.product_id
    WHERE price_changes.effective_timestamp < latest.latest_timestamp
    GROUP BY price_changes.product_id
)
SELECT * FROM previous JOIN latest ON previous.product_id = latest.product_id;
+------------+----------------+---------------------+------------+---------------+---------------------+
| product_id | previous_price | previous_timestamp  | product_id | current_price |  latest_timestamp   |
+------------+----------------+---------------------+------------+---------------+---------------------+
| 1          | 106.91         | 2025-12-16 01:51:05 | 1          | 109.25        | 2025-12-16 16:01:53 |
| 2          | 21.38          | 2025-12-15 16:20:20 | 2          | 17.75         | 2025-12-16 09:28:13 |
| 3          | 159.65         | 2025-12-14 09:52:09 | 3          | 143.65        | 2025-12-15 03:20:11 |
| 4          | 105.6          | 2025-12-14 14:09:20 | 4          | 98.51         | 2025-12-16 01:33:41 |
| 5          | 129.23         | 2025-12-12 04:08:45 | 5          | 124.04        | 2025-12-12 10:11:48 |
| 6          | 88.97          | 2025-12-15 02:13:04 | 6          | 84.14         | 2025-12-15 11:31:40 |
| 7          | 127.14         | 2025-12-13 07:25:12 | 7          | 123.09        | 2025-12-16 03:00:51 |
| 8          | 241.99         | 2025-12-14 19:31:40 | 8          | 221.06        | 2025-12-15 22:33:48 |
| 9          | 259.56         | 2025-12-12 12:47:13 | 9          | 255.88        | 2025-12-15 20:05:34 |
| 10         | 64.88          | 2025-12-15 10:52:34 | 10         | 57.99         | 2025-12-15 20:53:45 |
...
...
| 139        | 15.26          | 2025-12-12 03:43:32 | 139        | 16.41         | 2025-12-16 04:46:33 |
| 140        | 157.02         | 2025-12-09 17:58:07 | 140        | 173.05        | 2025-12-16 21:19:30 |
| 141        | 73.88          | 2025-12-13 14:35:53 | 141        | 69.97         | 2025-12-15 09:50:36 |
| 142        | 30.25          | 2025-12-16 13:44:42 | 142        | 35.05         | 2025-12-16 18:39:51 |
| 143        | 143.04         | 2025-12-11 10:08:13 | 143        | 153.94        | 2025-12-15 07:27:06 |
| 144        | 114.22         | 2025-12-15 17:33:37 | 144        | 118.21        | 2025-12-16 16:25:16 |
| 146        | 65.71          | 2025-12-10 15:50:14 | 146        | 54.73         | 2025-12-13 07:07:19 |
| 148        | 101.09         | 2025-12-15 05:37:27 | 148        | 107.81        | 2025-12-16 09:30:11 |
| 149        | 86.31          | 2025-12-13 13:18:14 | 149        | 72.6          | 2025-12-13 16:40:21 |
| 150        | 123.61         | 2025-12-12 10:49:22 | 150        | 138.66        | 2025-12-13 08:24:43 |
+------------+----------------+---------------------+------------+---------------+---------------------+
sqlite> 


</code></pre></div><p>Now, we are getting somewhere, we just need to find the difference right?</p>
<p>Yes, but more JOINs</p>
<p>We need the product_name from the <code>product</code> table. Almost forgot that table exists?</p>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">SELECT 
    *
FROM 
    products 
JOIN latest 
    ON products.product_id = latest.product_id 
LEFT JOIN previous 
    ON products.product_id = previous.product_id;
</code></pre><div class="output"></div></div><p>We need both right? So, we need to fetch the product id and join for the latest and the previous table from the CTE, joining on the <code>product_id</code>.</p>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">WITH latest AS (                                        
    SELECT price_changes.product_id,
           price_changes.price AS current_price,
           price_changes.effective_timestamp AS latest_timestamp
    FROM price_changes
    JOIN (                                                   
        SELECT product_id, MAX(effective_timestamp) AS max_timestamp
        FROM price_changes
        GROUP BY product_id
    ) latest_price_changes                             
      ON price_changes.product_id = latest_price_changes.product_id
     AND price_changes.effective_timestamp = latest_price_changes.max_timestamp
),  previous AS (
    SELECT price_changes.product_id,
           price_changes.price AS previous_price,
           MAX(price_changes.effective_timestamp) AS previous_timestamp
    FROM price_changes
    JOIN latest
      ON price_changes.product_id = latest.product_id
    WHERE price_changes.effective_timestamp < latest.latest_timestamp
    GROUP BY price_changes.product_id
)
SELECT 
    *
FROM 
    products 
JOIN latest 
    ON products.product_id = latest.product_id 
LEFT JOIN previous 
    ON products.product_id = previous.product_id;
</code></pre><div class="output"></div></div><div class="code-block"><div class="code-header"><span class="language-name"></span><button class="copy-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button></div><pre><code>sqlite> WITH latest AS (                                        
    SELECT price_changes.product_id,
           price_changes.price AS current_price,
           price_changes.effective_timestamp AS latest_timestamp
    FROM price_changes
    JOIN (                                                   
        SELECT product_id, MAX(effective_timestamp) AS max_timestamp
        FROM price_changes
        GROUP BY product_id
    ) latest_price_changes                             
      ON price_changes.product_id = latest_price_changes.product_id
     AND price_changes.effective_timestamp = latest_price_changes.max_timestamp
),  previous AS (
    SELECT price_changes.product_id,
           price_changes.price AS previous_price,
           MAX(price_changes.effective_timestamp) AS previous_timestamp
    FROM price_changes
    JOIN latest
      ON price_changes.product_id = latest.product_id
    WHERE price_changes.effective_timestamp < latest.latest_timestamp
    GROUP BY price_changes.product_id
)
SELECT * FROM products JOIN latest ON products.product_id = latest.product_id 
   ...> LEFT JOIN previous ON products.product_id = previous.product_id;
+------------+-----------------------------------+------------+---------------+---------------------+------------+----------------+---------------------+
| product_id |           product_name            | product_id | current_price |  latest_timestamp   | product_id | previous_price | previous_timestamp  |
+------------+-----------------------------------+------------+---------------+---------------------+------------+----------------+---------------------+
| 1          | Deluxe Sled                       | 1          | 109.25        | 2025-12-16 16:01:53 | 1          | 106.91         | 2025-12-16 01:51:05 |
| 2          | Holiday Trail Mix Trio            | 2          | 17.75         | 2025-12-16 09:28:13 | 2          | 21.38          | 2025-12-15 16:20:20 |
| 3          | Premium Cinnamon Roasted Almonds  | 3          | 143.65        | 2025-12-15 03:20:11 | 3          | 159.65         | 2025-12-14 09:52:09 |
| 4          | Deluxe Wrapping Paper             | 4          | 98.51         | 2025-12-16 01:33:41 | 4          | 105.6          | 2025-12-14 14:09:20 |
| 5          | Deluxe Roasted Cashews            | 5          | 124.04        | 2025-12-12 10:11:48 | 5          | 129.23         | 2025-12-12 04:08:45 |
| 6          | Festive Cookware Set              | 6          | 84.14         | 2025-12-15 11:31:40 | 6          | 88.97          | 2025-12-15 02:13:04 |
| 7          | Deluxe Mug                        | 7          | 123.09        | 2025-12-16 03:00:51 | 7          | 127.14         | 2025-12-13 07:25:12 |
| 8          | Premium Sled                      | 8          | 221.06        | 2025-12-15 22:33:48 | 8          | 241.99         | 2025-12-14 19:31:40 |
| 9          | Essential Sled                    | 9          | 255.88        | 2025-12-15 20:05:34 | 9          | 259.56         | 2025-12-12 12:47:13 |
| 10         | Family Snow Boots                 | 10         | 57.99         | 2025-12-15 20:53:45 | 10         | 64.88          | 2025-12-15 10:52:34 |
...
...
| 140        | Classic Mug                       | 140        | 173.05        | 2025-12-16 21:19:30 | 140        | 157.02         | 2025-12-09 17:58:07 |
| 141        | Family Fruit Assortment           | 141        | 69.97         | 2025-12-15 09:50:36 | 141        | 73.88          | 2025-12-13 14:35:53 |
| 142        | Classic Ornament                  | 142        | 35.05         | 2025-12-16 18:39:51 | 142        | 30.25          | 2025-12-16 13:44:42 |
| 143        | Essential Ornament                | 143        | 153.94        | 2025-12-15 07:27:06 | 143        | 143.04         | 2025-12-11 10:08:13 |
| 144        | Premium Trail Mix Trio            | 144        | 118.21        | 2025-12-16 16:25:16 | 144        | 114.22         | 2025-12-15 17:33:37 |
| 146        | Premium Book Collection           | 146        | 54.73         | 2025-12-13 07:07:19 | 146        | 65.71          | 2025-12-10 15:50:14 |
| 148        | Cozy Trail Mix Trio               | 148        | 107.81        | 2025-12-16 09:30:11 | 148        | 101.09         | 2025-12-15 05:37:27 |
| 149        | Family Cheddar Popcorn            | 149        | 72.6          | 2025-12-13 16:40:21 | 149        | 86.31          | 2025-12-13 13:18:14 |
| 150        | Holiday Headphones                | 150        | 138.66        | 2025-12-13 08:24:43 | 150        | 123.61         | 2025-12-12 10:49:22 |
+------------+-----------------------------------+------------+---------------+---------------------+------------+----------------+---------------------+
sqlite> 
</code></pre></div><p>Now, we just want</p>
<ul>
<li>product_name</li>
<li>previous_price</li>
<li>current_price</li>
<li>difference of current_price and previous price</li>
</ul>
<p>So,</p>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">WITH latest AS (                                        
    SELECT price_changes.product_id,
           price_changes.price AS current_price,
           price_changes.effective_timestamp AS latest_timestamp
    FROM price_changes
    JOIN (                                                   
        SELECT product_id, MAX(effective_timestamp) AS max_timestamp
        FROM price_changes
        GROUP BY product_id
    ) latest_price_changes                             
      ON price_changes.product_id = latest_price_changes.product_id
     AND price_changes.effective_timestamp = latest_price_changes.max_timestamp
),  previous AS (
    SELECT price_changes.product_id,
           price_changes.price AS previous_price,
           MAX(price_changes.effective_timestamp) AS previous_timestamp
    FROM price_changes
    JOIN latest
      ON price_changes.product_id = latest.product_id
    WHERE price_changes.effective_timestamp < latest.latest_timestamp
    GROUP BY price_changes.product_id
)
SELECT 
    products.product_name, 
    latest.current_price, 
    previous.previous_price, 
    (latest.current_price - previous.previous_price) as price_difference
FROM 
    products 
JOIN latest 
    ON products.product_id = latest.product_id 
LEFT JOIN previous 
    ON products.product_id = previous.product_id;
</code></pre><div class="output"></div></div><div class="code-block"><div class="code-header"><span class="language-name"></span><button class="copy-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button></div><pre><code>sqlite> WITH latest AS (                                        
    SELECT price_changes.product_id,
           price_changes.price AS current_price,
           price_changes.effective_timestamp AS latest_timestamp
    FROM price_changes
    JOIN (                                                   
        SELECT product_id, MAX(effective_timestamp) AS max_timestamp
        FROM price_changes
        GROUP BY product_id
    ) latest_price_changes                             
      ON price_changes.product_id = latest_price_changes.product_id
     AND price_changes.effective_timestamp = latest_price_changes.max_timestamp
),  previous AS (
    SELECT price_changes.product_id,
           price_changes.price AS previous_price,
           MAX(price_changes.effective_timestamp) AS previous_timestamp
    FROM price_changes
    JOIN latest
      ON price_changes.product_id = latest.product_id
    WHERE price_changes.effective_timestamp < latest.latest_timestamp
    GROUP BY price_changes.product_id
)
SELECT 
    products.product_name, latest.current_price, previous.previous_price, (latest.current_price - previous.previous_price) as price_difference
FROM 
    products 
JOIN latest 
    ON products.product_id = latest.product_id 
LEFT JOIN previous 
    ON products.product_id = previous.product_id;

+-----------------------------------+---------------+----------------+-------------------+
|           product_name            | current_price | previous_price | price_difference  |
+-----------------------------------+---------------+----------------+-------------------+
| Deluxe Sled                       | 109.25        | 106.91         | 2.34              |
| Holiday Trail Mix Trio            | 17.75         | 21.38          | -3.63             |
| Premium Cinnamon Roasted Almonds  | 143.65        | 159.65         | -16.0             |
| Deluxe Wrapping Paper             | 98.51         | 105.6          | -7.08999999999999 |
| Deluxe Roasted Cashews            | 124.04        | 129.23         | -5.18999999999998 |
| Festive Cookware Set              | 84.14         | 88.97          | -4.83             |
| Deluxe Mug                        | 123.09        | 127.14         | -4.05             |
| Premium Sled                      | 221.06        | 241.99         | -20.93            |
| Essential Sled                    | 255.88        | 259.56         | -3.68000000000001 |
...
...
| Classic Ornament                  | 35.05         | 30.25          | 4.8               |
| Essential Ornament                | 153.94        | 143.04         | 10.9              |
| Premium Trail Mix Trio            | 118.21        | 114.22         | 3.98999999999999  |
| Premium Book Collection           | 54.73         | 65.71          | -10.98            |
| Cozy Trail Mix Trio               | 107.81        | 101.09         | 6.72              |
| Family Cheddar Popcorn            | 72.6          | 86.31          | -13.71            |
| Holiday Headphones                | 138.66        | 123.61         | 15.05             |
+-----------------------------------+---------------+----------------+-------------------+
sqlite> 
</code></pre></div><p>Oh ok! That is it!</p>
<p>CTEs and some nasty number of JOINs.</p>
<p>Can we do it some other ways?</p>
<p>Of course we can, and we will</p>
<h3 id="row-number---window-function">ROW NUMBER - Window Function</h3>
<p>We can even use some window functions because we are doing things per product so we can leverage <a href="https://sqlite.org/windowfunctions.html#:~:text=in%20window%20functions%3A-,row_number(),-The%20number%20of">ROW_NUMBER</a> in our case.</p>
<blockquote>
<p>ROW_NUMBER: The number of the row within the current partition. Rows are numbered starting from 1 in the order defined by the ORDER BY clause in the window definition, or in arbitrary order otherwise.</p>
</blockquote>
<p>So, we can partition by <code>product_id</code> in the <code>price_changes</code> table and order by the timestamp (latest first i.e. descending) and grab the first two prices.</p>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">WITH ranked_prices AS (
    SELECT price_changes.*,
           ROW_NUMBER() OVER (
               PARTITION BY price_changes.product_id
               ORDER BY price_changes.effective_timestamp DESC
           ) AS row_number
    FROM price_changes
)
SELECT
    *
FROM ranked_prices;
</code></pre><div class="output"></div></div><p>Here, we just partitioned the price table based on the latest to oldest timestamp (descending) and added the other column <code>row_number</code> that will be further used to get the <code>previous</code> and the <code>current</code> price and time.</p>
<div class="code-block"><div class="code-header"><span class="language-name"></span><button class="copy-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button></div><pre><code>sqlite> WITH ranked_prices AS (
    SELECT price_changes.*,
           ROW_NUMBER() OVER (
               PARTITION BY price_changes.product_id
               ORDER BY price_changes.effective_timestamp DESC
           ) AS row_number
    FROM price_changes
)
SELECT
    *
FROM ranked_prices;
+------+------------+--------+---------------------+------------+
|  id  | product_id | price  | effective_timestamp | row_number |
+------+------------+--------+---------------------+------------+
| 15   | 1          | 109.25 | 2025-12-16 16:01:53 | 1          |
| 14   | 1          | 106.91 | 2025-12-16 01:51:05 | 2          |
| 13   | 1          | 100.18 | 2025-12-14 15:58:03 | 3          |
| 12   | 1          | 99.03  | 2025-12-12 02:58:14 | 4          |
| 11   | 1          | 88.2   | 2025-12-12 02:21:09 | 5          |
| 10   | 1          | 73.9   | 2025-12-10 14:33:43 | 6          |
| 9    | 1          | 80.24  | 2025-12-08 16:11:11 | 7          |
| 8    | 1          | 78.88  | 2025-12-08 06:45:39 | 8          |
| 7    | 1          | 80.88  | 2025-12-07 10:43:54 | 9          |
| 6    | 1          | 88.49  | 2025-12-06 19:02:40 | 10         |
| 5    | 1          | 98.57  | 2025-12-04 04:14:31 | 11         |
| 4    | 1          | 119.12 | 2025-12-03 10:14:35 | 12         |
| 3    | 1          | 126.78 | 2025-12-02 18:40:38 | 13         |
| 2    | 1          | 148.63 | 2025-12-02 18:15:33 | 14         |
| 1    | 1          | 148.28 | 2025-12-01 05:25:35 | 15         |
...
...
| 1260 | 149        | 167.1  | 2025-12-01 06:36:43 | 15         |
| 1288 | 150        | 138.66 | 2025-12-13 08:24:43 | 1          |
| 1287 | 150        | 123.61 | 2025-12-12 10:49:22 | 2          |
| 1286 | 150        | 141.8  | 2025-12-10 07:06:06 | 3          |
| 1285 | 150        | 122.16 | 2025-12-09 20:01:54 | 4          |
| 1284 | 150        | 122.06 | 2025-12-06 22:27:41 | 5          |
| 1283 | 150        | 128.6  | 2025-12-06 13:03:18 | 6          |
| 1282 | 150        | 154.72 | 2025-12-05 08:15:08 | 7          |
| 1281 | 150        | 170.3  | 2025-12-04 15:25:50 | 8          |
| 1280 | 150        | 156.51 | 2025-12-03 19:11:12 | 9          |
| 1279 | 150        | 161.93 | 2025-12-02 02:47:10 | 10         |
| 1278 | 150        | 174.36 | 2025-12-02 01:39:14 | 11         |
| 1277 | 150        | 180.17 | 2025-12-01 20:36:02 | 12         |
| 1276 | 150        | 164.35 | 2025-12-01 07:09:29 | 13         |
| 1275 | 150        | 141    | 2025-12-01 01:29:46 | 14         |
+------+------------+--------+---------------------+------------+

</code></pre></div><div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">WITH ranked_prices AS (
    SELECT price_changes.*,
           ROW_NUMBER() OVER (
               PARTITION BY price_changes.product_id
               ORDER BY price_changes.effective_timestamp DESC
           ) AS row_number
    FROM price_changes
)
SELECT
    products.product_name,
    current_price.price AS current_price,
    previous_price.price AS previous_price,
    current_price.price - previous_price.price AS price_difference
FROM products
LEFT JOIN ranked_prices AS current_price
       ON products.product_id = current_price.product_id
      AND current_price.row_number = 1
LEFT JOIN ranked_prices AS previous_price
       ON products.product_id = previous_price.product_id
      AND previous_price.row_number = 2;
</code></pre><div class="output"></div></div><p>This is pretty simple, we just get</p>
<ul>
<li>the <code>current_price</code> as <code>row_number = 1</code> from the <code>ranked_prices</code> CTE</li>
<li>the <code>previous_price</code> as <code>row_number = 2</code> from the <code>ranked_prices</code> CTE</li>
</ul>
<p>We got all we needed as:</p>
<ul>
<li><code>products.product_name</code></li>
<li><code>current_price.price AS current_price</code></li>
<li><code>previous_price.price AS previous_price</code></li>
<li><code>current_price.price - previous_price.price AS price_difference</code></li>
</ul>
<p>So, this is how <code>ROW_NUMBER</code> can be used here.</p>
<h3 id="with-lead-lag---window-functions">With LEAD LAG - Window Functions</h3>
<p>We can also use [LEAD](https://sqlite.org/windowfunctions.html#:~:text=does%20not%20exist.-,lead(expr),-lead(expr%2C%20offset) and [LAG](https://sqlite.org/windowfunctions.html#:~:text=a%20part%20of.-,lag(expr),-lag(expr%2C%20offset) window functions here. We can specifically use <code>LAG</code> as it was a challenge to get the second latest timestamped price.</p>
<p>We will partition the <code>price_changes</code> table on the <code>product_id</code> and order it by the <code>effective_timestamp</code>. This will give us the row before the timestamp of the current one, so the first row for each product can be empty (if sorted in ascending order of timestamp since there is no before row for the first row)</p>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql"> WITH lagged_prices AS (
    SELECT
        product_id,
        price AS current_price,
        LAG(price) OVER (
            PARTITION BY product_id
            ORDER BY effective_timestamp
        ) AS previous_price,
        effective_timestamp
    FROM price_changes
)
SELECT * FROM lagged_prices;
</code></pre><div class="output"></div></div><p>Here, we simply selected the data that we need, <code>product_id</code>, <code>price</code> as the <code>current_price</code> since we can order by latest timestamp.</p>
<div class="code-block"><div class="code-header"><span class="language-name"></span><button class="copy-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button></div><pre><code>sqlite> WITH lagged_prices AS (
    SELECT
        product_id,
        price AS current_price,
        LAG(price) OVER (
            PARTITION BY product_id
            ORDER BY effective_timestamp
        ) AS previous_price,
        effective_timestamp
    FROM price_changes
)
SELECT * FROM lagged_prices;
+------------+---------------+----------------+---------------------+
| product_id | current_price | previous_price | effective_timestamp |
+------------+---------------+----------------+---------------------+
| 1          | 148.28        |                | 2025-12-01 05:25:35 |
| 1          | 148.63        | 148.28         | 2025-12-02 18:15:33 |
| 1          | 126.78        | 148.63         | 2025-12-02 18:40:38 |
| 1          | 119.12        | 126.78         | 2025-12-03 10:14:35 |
| 1          | 98.57         | 119.12         | 2025-12-04 04:14:31 |
| 1          | 88.49         | 98.57          | 2025-12-06 19:02:40 |
| 1          | 80.88         | 88.49          | 2025-12-07 10:43:54 |
| 1          | 78.88         | 80.88          | 2025-12-08 06:45:39 |
| 1          | 80.24         | 78.88          | 2025-12-08 16:11:11 |
| 1          | 73.9          | 80.24          | 2025-12-10 14:33:43 |
| 1          | 88.2          | 73.9           | 2025-12-12 02:21:09 |
| 1          | 99.03         | 88.2           | 2025-12-12 02:58:14 |
| 1          | 100.18        | 99.03          | 2025-12-14 15:58:03 |
| 1          | 106.91        | 100.18         | 2025-12-16 01:51:05 |
| 1          | 109.25        | 106.91         | 2025-12-16 16:01:53 |
| 2          | 29.54         |                | 2025-12-03 14:21:10 |
| 2          | 34.33         | 29.54          | 2025-12-03 19:14:31 |
| 2          | 39.08         | 34.33          | 2025-12-04 06:13:48 |
| 2          | 32.71         | 39.08          | 2025-12-04 18:33:17 |
| 2          | 31.71         | 32.71          | 2025-12-05 22:36:14 |
| 2          | 28.88         | 31.71          | 2025-12-06 02:42:02 |
...
...
| 149        | 101.03        | 98.4           | 2025-12-10 00:37:46 |
| 149        | 95.68         | 101.03         | 2025-12-13 01:10:53 |
| 149        | 86.31         | 95.68          | 2025-12-13 13:18:14 |
| 149        | 72.6          | 86.31          | 2025-12-13 16:40:21 |
| 150        | 141           |                | 2025-12-01 01:29:46 |
| 150        | 164.35        | 141            | 2025-12-01 07:09:29 |
| 150        | 180.17        | 164.35         | 2025-12-01 20:36:02 |
| 150        | 174.36        | 180.17         | 2025-12-02 01:39:14 |
| 150        | 161.93        | 174.36         | 2025-12-02 02:47:10 |
| 150        | 156.51        | 161.93         | 2025-12-03 19:11:12 |
| 150        | 170.3         | 156.51         | 2025-12-04 15:25:50 |
| 150        | 154.72        | 170.3          | 2025-12-05 08:15:08 |
| 150        | 128.6         | 154.72         | 2025-12-06 13:03:18 |
| 150        | 122.06        | 128.6          | 2025-12-06 22:27:41 |
| 150        | 122.16        | 122.06         | 2025-12-09 20:01:54 |
| 150        | 141.8         | 122.16         | 2025-12-10 07:06:06 |
| 150        | 123.61        | 141.8          | 2025-12-12 10:49:22 |
| 150        | 138.66        | 123.61         | 2025-12-13 08:24:43 |
+------------+---------------+----------------+---------------------+

</code></pre></div><p>Then we can join. The conditions are important to filter.</p>
<ul>
<li>we get the lagged time stamp where we want the max of the timestamp since the latest timestamp will have the lagging timestamp for it from the CTE of lagged_prices and current_price as well.</li>
</ul>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">SELECT
    products.product_name,
    lagged_prices.current_price,
    lagged_prices.previous_price,
    lagged_prices.current_price - lagged_prices.previous_price AS price_difference
FROM products
JOIN lagged_prices
  ON products.product_id = lagged_prices.product_id
WHERE lagged_prices.effective_timestamp = (
    SELECT MAX(effective_timestamp)
    FROM price_changes
    WHERE product_id = products.product_id
);

</code></pre><div class="output"></div></div><div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">WITH lagged_prices AS (
    SELECT
        product_id,
        price AS current_price,
        LAG(price) OVER (
            PARTITION BY product_id
            ORDER BY effective_timestamp
        ) AS previous_price,
        effective_timestamp
    FROM price_changes
)
SELECT
    products.product_name,
    lagged_prices.current_price,
    lagged_prices.previous_price,
    lagged_prices.current_price - lagged_prices.previous_price AS price_difference
FROM products
JOIN lagged_prices
  ON products.product_id = lagged_prices.product_id
WHERE lagged_prices.effective_timestamp = (
    SELECT MAX(effective_timestamp)
    FROM price_changes
    WHERE product_id = products.product_id
);

</code></pre><div class="output"></div></div><p>This yields the same result.</p>
<p>This is all big, any smaller queries?</p>
<p>Not quite small.</p>
<h3 id="limit-offset-and-cte">LIMIT OFFSET and CTE</h3>
<p>Well here's a little short, but quite dirty.</p>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">SELECT *,
       current_price - previous_price AS price_difference
FROM (
    SELECT
        products.product_name,
        (SELECT price
         FROM price_changes
         WHERE price_changes.product_id = products.product_id
         ORDER BY effective_timestamp DESC
         LIMIT 1) AS current_price,
        (SELECT price
         FROM price_changes
         WHERE price_changes.product_id = products.product_id
         ORDER BY effective_timestamp DESC
         LIMIT 1 OFFSET 1) AS previous_price
    FROM products
);
</code></pre><div class="output"></div></div><p>This basically grabs the  price from the latest timestamp and the 2nd timestamp with offset and wraps it in a CTE to compute the difference.</p>
<p>Pretty slick if you ask me.</p>
<p>But hey! I am done for this!</p>
<p>It was a great problem.</p>
<p>Getting data behind certain data is quite relatable and challenging enough to explore window functions and what not.</p>
<p>That's it from day 8.</p>
<p>See you tomorrow for day 9!</p>

            </div>
        </article>
        
        
        

<nav class="post-navigation" aria-label="Post Navigation">
    <div class="nav-container">
        
        
        <a href="/sqlog/advent-of-sql-2025-day-7" class="nav-link nav-prev" title="Previous Post">
            <span class="nav-arrow"></span>
            <span class="nav-label">Previous</span>
            <span class="nav-title">Advent of SQL 2025 Day 7: Polar Express Mixin</span>
        </a>
        

        
        
        <a href="/sqlog/advent-of-sql-2025-day-9" class="nav-link nav-next" title="Next Post">
            <span class="nav-label">Next</span>
            <span class="nav-title">Advent of SQL 2025 Day 9: Evergreen Market Orders</span>
            <span class="nav-arrow"></span>
        </a>
        
    </div>
</nav>


        
        
        


<aside class="related-reading" aria-labelledby="related-reading-title">
    <h3 id="related-reading-title" class="related-title"> Related Reading</h3>
    <ul class="related-list">
        
        
        <li class="related-item">
            <a href="/sqlog/advent-of-sql-2025-day-15" class="related-link">
                <span class="related-post-title">Advent of SQL 2025 Day 15: Confirmation Phrase Dispatches</span>
                <span class="related-post-date">2025-12-28 20:30 &#43;0530</span>
            </a>
        </li>
        
        
        
        <li class="related-item">
            <a href="/sqlog/advent-of-sql-2025-day-14" class="related-link">
                <span class="related-post-title">Advent of SQL 2025 Day 14: Ski Resort Paths</span>
                <span class="related-post-date">2025-12-28 15:30 &#43;0530</span>
            </a>
        </li>
        
        
        
        <li class="related-item">
            <a href="/sqlog/advent-of-sql-2025-day-13" class="related-link">
                <span class="related-post-title">Advent of SQL 2025 Day 13: XML Travel Manifests</span>
                <span class="related-post-date">2025-12-27 20:30 &#43;0530</span>
            </a>
        </li>
        
        
        
        <li class="related-item">
            <a href="/sqlog/advent-of-sql-2025-day-12" class="related-link">
                <span class="related-post-title">Advent of SQL 2025 Day 12: Archive Flight Records</span>
                <span class="related-post-date">2025-12-27 15:30 &#43;0530</span>
            </a>
        </li>
        
        
        
        <li class="related-item">
            <a href="/sqlog/advent-of-sql-2025-day-11" class="related-link">
                <span class="related-post-title">Advent of SQL 2025 Day 11: Behavior Score</span>
                <span class="related-post-date">2025-12-26 15:30 &#43;0530</span>
            </a>
        </li>
        
        
    </ul>
</aside>


    </main>
    
    <div id="comments">
        <script src="https://giscus.app/client.js"
            data-repo="Mr-Destructive/meetgor.com"
            data-repo-id="R_kgDOHZ6V_g"
            data-category="Q&A"
            data-category-id="DIC_kwDOHZ6V_s4CRfn4"
            data-mapping="pathname"
            data-strict="0"
            data-reactions-enabled="1"
            data-emit-metadata="0"
            data-input-position="bottom"
            data-theme="dark_high_contrast"
            data-lang="en"
            crossorigin="anonymous"
            async>
        </script>
    </div>
    
    <footer class="site-footer" role="contentinfo">
  <div class="footer-content">
    <p>&copy; Meet Gor. All rights reserved.</p>
    <div class="social-links">
      <a href="/contact" aria-label="Connect with me">Connect with me</a>
    </div>
  </div>
</footer>
    
</body>
</html>
