<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <title>Advent of SQL 2025 Day 5: EchoTrack Wrapped | Meet Gor</title>
    <meta name="title" content="Advent of SQL 2025 Day 5: EchoTrack Wrapped | Meet Gor">
    <meta name="description" content="">
    <meta name="author" content="Meet Gor">
    <meta name="keywords" content="sqlite, sql, advent-of-sql">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://meetgor.com/sqlog/advent-of-sql-2025-day-5">
    
    
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://meetgor.com/sqlog/advent-of-sql-2025-day-5">
    <meta property="og:title" content="Advent of SQL 2025 Day 5: EchoTrack Wrapped">
    <meta property="og:description" content="">
    <meta property="og:image" content="https://meetgor.com/tbicon.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="Advent of SQL 2025 Day 5: EchoTrack Wrapped">
    <meta property="og:locale" content="en_US">
    <meta property="og:site_name" content="Meet Gor">
    <meta property="article:published_time" content="2025-12-20 15:30 &#43;0530">
    <meta property="article:modified_time" content="2025-12-20 15:30 &#43;0530">
    <meta property="article:author" content="Meet Gor">
    
    <meta property="article:tag" content="sqlite">
    
    <meta property="article:tag" content="sql">
    
    <meta property="article:tag" content="advent-of-sql">
    
    
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@meetgor711">
    <meta name="twitter:creator" content="@meetgor711">
    <meta name="twitter:url" content="https://meetgor.com/sqlog/advent-of-sql-2025-day-5">
    <meta name="twitter:title" content="Advent of SQL 2025 Day 5: EchoTrack Wrapped">
    <meta name="twitter:description" content="">
    <meta name="twitter:image" content="https://meetgor.com/tbicon.png">
    <meta name="twitter:image:alt" content="Advent of SQL 2025 Day 5: EchoTrack Wrapped">
    
    
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/meetgor.com/sqlog\/advent-of-sql-2025-day-5"
        },
        "headline": "Advent of SQL 2025 Day 5: EchoTrack Wrapped",
        "description": "",
        "datePublished": "2025-12-20 15:30 \u002b0530",
        "dateModified": "2025-12-20 15:30 \u002b0530",
        "author": {
            "@type": "Person",
            "name": "Meet Gor"
        },
        "publisher": {
            "@type": "Organization",
            "name": "Meet Gor",
            "logo": {
                "@type": "ImageObject",
                "url": "https:\/\/meetgor.com/tbicon.png"
            }
        },
        
        "keywords": "sqlite, sql, advent-of-sql",
        "articleBody": "\u0026lt;h2 id=\u0026#34;advent-of-sql-day-5---echotrack-wrapped\u0026#34;\u0026gt;Advent of SQL Day 5 - EchoTrack Wrapped\u0026lt;\/h2\u0026gt;\n\u0026lt;p\u0026gt;It is day 5 of advent of SQL.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Let\u0026#39;s get rollin. It looks like a good problem. I am excited!\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Here\u0026#39;s the SQL to get started.\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;DROP TABLE IF EXISTS listening_logs;\n\nCREATE TABLE listening_logs (\n    id INTEGER PRIMARY KEY,\n    user_name TEXT,\n    artist TEXT,\n    played_at TIMESTAMP,\n    content_type TEXT\n);\n\nINSERT INTO listening_logs (id, user_name, artist, played_at, content_type) VALUES\n    (1, \u0026#39;Zoe Garcia\u0026#39;, \u0026#39;Arijit Singh\u0026#39;, \u0026#39;2025-04-08 00:21:53\u0026#39;, \u0026#39;song\u0026#39;),\n    (2, \u0026#39;Zoe Garcia\u0026#39;, \u0026#39;Huberman Lab\u0026#39;, \u0026#39;2025-11-10 19:18:47\u0026#39;, \u0026#39;podcast\u0026#39;),\n    (3, \u0026#39;Zoe Garcia\u0026#39;, \u0026#39;Huberman Lab\u0026#39;, \u0026#39;2025-01-20 15:31:02\u0026#39;, \u0026#39;podcast\u0026#39;),\n    (4, \u0026#39;Zoe Garcia\u0026#39;, \u0026#39;Arijit Singh\u0026#39;, \u0026#39;2025-01-06 17:33:11\u0026#39;, \u0026#39;song\u0026#39;),\n    (5, \u0026#39;Zoe Garcia\u0026#39;, \u0026#39;Candace\u0026#39;, \u0026#39;2025-03-06 14:07:54\u0026#39;, \u0026#39;podcast\u0026#39;),\n    (6, \u0026#39;Zoe Garcia\u0026#39;, \u0026#39;Arijit Singh\u0026#39;, \u0026#39;2025-06-05 17:57:59\u0026#39;, \u0026#39;song\u0026#39;),\n    (7, \u0026#39;Zoe Garcia\u0026#39;, \u0026#39;Huberman Lab\u0026#39;, \u0026#39;2025-01-01 20:05:22\u0026#39;, \u0026#39;podcast\u0026#39;),\n    (8, \u0026#39;Zoe Garcia\u0026#39;, \u0026#39;Huberman Lab\u0026#39;, \u0026#39;2025-11-01 12:04:03\u0026#39;, \u0026#39;podcast\u0026#39;),\n    (9, \u0026#39;Zoe Garcia\u0026#39;, \u0026#39;Arijit Singh\u0026#39;, \u0026#39;2025-09-28 12:42:12\u0026#39;, \u0026#39;song\u0026#39;),\n    (10, \u0026#39;Zoe Garcia\u0026#39;, \u0026#39;The Ben Shapiro Show\u0026#39;, \u0026#39;2025-09-15 01:05:15\u0026#39;, \u0026#39;podcast\u0026#39;),\n    (11, \u0026#39;Zoe Garcia\u0026#39;, \u0026#39;Arijit Singh\u0026#39;, \u0026#39;2025-04-26 05:31:02\u0026#39;, \u0026#39;song\u0026#39;),\n    (12, \u0026#39;Zoe Garcia\u0026#39;, \u0026#39;Arijit Singh\u0026#39;, \u0026#39;2025-10-13 17:34:03\u0026#39;, \u0026#39;song\u0026#39;),\n    (13, \u0026#39;Zoe Garcia\u0026#39;, \u0026#39;Mariah Carey\u0026#39;, \u0026#39;2025-01-20 11:21:37\u0026#39;, \u0026#39;song\u0026#39;),\n    (14, \u0026#39;Zoe Garcia\u0026#39;, \u0026#39;Arijit Singh\u0026#39;, \u0026#39;2025-11-28 03:55:31\u0026#39;, \u0026#39;song\u0026#39;),\n    (15, \u0026#39;Zoe Garcia\u0026#39;, \u0026#39;Arijit Singh\u0026#39;, \u0026#39;2025-07-17 05:18:16\u0026#39;, \u0026#39;song\u0026#39;),\n    (16, \u0026#39;Zoe Garcia\u0026#39;, \u0026#39;Arijit Singh\u0026#39;, \u0026#39;2025-08-20 02:07:45\u0026#39;, \u0026#39;song\u0026#39;),\n    (17, \u0026#39;Zoe Garcia\u0026#39;, \u0026#39;Kendrick Lamar\u0026#39;, \u0026#39;2025-02-16 13:25:27\u0026#39;, \u0026#39;song\u0026#39;),\n    (18, \u0026#39;Zoe Garcia\u0026#39;, \u0026#39;Huberman Lab\u0026#39;, \u0026#39;2025-08-13 19:55:00\u0026#39;, \u0026#39;podcast\u0026#39;),\n    (19, \u0026#39;Zoe Garcia\u0026#39;, \u0026#39;Bruno Mars\u0026#39;, \u0026#39;2025-09-13 07:09:43\u0026#39;, \u0026#39;song\u0026#39;),\n    (20, \u0026#39;Zoe Garcia\u0026#39;, \u0026#39;Arijit Singh\u0026#39;, \u0026#39;2025-04-12 06:30:44\u0026#39;, \u0026#39;song\u0026#39;);\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;Let\u0026#39;s open a SQLite shell and get started.\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;code-block\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;code-header\u0026#34;\u0026gt;\u0026lt;span class=\u0026#34;language-name\u0026#34;\u0026gt;\u0026lt;\/span\u0026gt;\u0026lt;button class=\u0026#34;copy-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-copy\u0026#34;\u0026gt;\u0026lt;rect x=\u0026#34;9\u0026#34; y=\u0026#34;9\u0026#34; width=\u0026#34;13\u0026#34; height=\u0026#34;13\u0026#34; rx=\u0026#34;2\u0026#34; ry=\u0026#34;2\u0026#34;\u0026gt;\u0026lt;\/rect\u0026gt;\u0026lt;path d=\u0026#34;M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code\u0026gt;$ sqlite3\nSQLite version 3.50.4 2025-07-30 19:33:53\nEnter \u0026#34;.help\u0026#34; for usage hints.\nConnected to a transient in-memory database.\nUse \u0026#34;.open FILENAME\u0026#34; to reopen on a persistent database.\nsqlite\u0026gt; .read day5-inserts.sql\nsqlite\u0026gt; .schema\nCREATE TABLE listening_logs (\n    id INTEGER PRIMARY KEY,\n    user_name TEXT,\n    artist TEXT,\n    played_at TIMESTAMP,\n    content_type TEXT\n);\nsqlite\u0026gt; .mode table\nsqlite\u0026gt; SELECT * FROM listening_logs LIMIT 20;\n\u002b----\u002b------------\u002b----------------------\u002b---------------------\u002b--------------\u002b\n| id | user_name  |        artist        |      played_at      | content_type |\n\u002b----\u002b------------\u002b----------------------\u002b---------------------\u002b--------------\u002b\n| 1  | Zoe Garcia | Arijit Singh         | 2025-04-08 00:21:53 | song         |\n| 2  | Zoe Garcia | Huberman Lab         | 2025-11-10 19:18:47 | podcast      |\n| 3  | Zoe Garcia | Huberman Lab         | 2025-01-20 15:31:02 | podcast      |\n| 4  | Zoe Garcia | Arijit Singh         | 2025-01-06 17:33:11 | song         |\n| 5  | Zoe Garcia | Candace              | 2025-03-06 14:07:54 | podcast      |\n| 6  | Zoe Garcia | Arijit Singh         | 2025-06-05 17:57:59 | song         |\n| 7  | Zoe Garcia | Huberman Lab         | 2025-01-01 20:05:22 | podcast      |\n| 8  | Zoe Garcia | Huberman Lab         | 2025-11-01 12:04:03 | podcast      |\n| 9  | Zoe Garcia | Arijit Singh         | 2025-09-28 12:42:12 | song         |\n| 10 | Zoe Garcia | The Ben Shapiro Show | 2025-09-15 01:05:15 | podcast      |\n| 11 | Zoe Garcia | Arijit Singh         | 2025-04-26 05:31:02 | song         |\n| 12 | Zoe Garcia | Arijit Singh         | 2025-10-13 17:34:03 | song         |\n| 13 | Zoe Garcia | Mariah Carey         | 2025-01-20 11:21:37 | song         |\n| 14 | Zoe Garcia | Arijit Singh         | 2025-11-28 03:55:31 | song         |\n| 15 | Zoe Garcia | Arijit Singh         | 2025-07-17 05:18:16 | song         |\n| 16 | Zoe Garcia | Arijit Singh         | 2025-08-20 02:07:45 | song         |\n| 17 | Zoe Garcia | Kendrick Lamar       | 2025-02-16 13:25:27 | song         |\n| 18 | Zoe Garcia | Huberman Lab         | 2025-08-13 19:55:00 | podcast      |\n| 19 | Zoe Garcia | Bruno Mars           | 2025-09-13 07:09:43 | song         |\n| 20 | Zoe Garcia | Arijit Singh         | 2025-04-12 06:30:44 | song         |\n\u002b----\u002b------------\u002b----------------------\u002b---------------------\u002b--------------\u002b\nsqlite\u0026gt;\nsqlite\u0026gt; SELECT COUNT(*) FROM listening_logs;\n\u002b----------\u002b\n| COUNT(*) |\n\u002b----------\u002b\n| 18174    |\n\u002b----------\u002b\nsqlite\u0026gt;\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;OK! We have around 18k records in a single table! That\u0026#39;s a lot but not not much!\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Let\u0026#39;s see what we have to do\u0026lt;\/p\u0026gt;\n\u0026lt;h2 id=\u0026#34;problem\u0026#34;\u0026gt;Problem\u0026lt;\/h2\u0026gt;\n\u0026lt;blockquote\u0026gt;\n\u0026lt;p\u0026gt;Write a query that returns the top 3 artists per user. Order the results by the most played\u0026lt;\/p\u0026gt;\n\u0026lt;\/blockquote\u0026gt;\n\u0026lt;p\u0026gt;Alright, this is quite a problem to solve, if you are thinking, it easy peasy, then hold on!\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;We clearly see, that we have 2 columns of our interest.\u0026lt;\/p\u0026gt;\n\u0026lt;ol\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;code\u0026gt;user_name\u0026lt;\/code\u0026gt;\u0026lt;\/li\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;code\u0026gt;artist\u0026lt;\/code\u0026gt;\u0026lt;\/li\u0026gt;\n\u0026lt;\/ol\u0026gt;\n\u0026lt;p\u0026gt;We need to group for each user his most played artists, and we need to rank those top 3 artist per user.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;And each entry is a song or podcast that the user has litened to.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;We need to aggregate, group, and then rank, and then what?\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;How would you chunk out the top three?\nIt\u0026#39;s time to put your SQL glasses and gloves on, it\u0026#39;s getting colder!\u0026lt;\/p\u0026gt;\n\u0026lt;h3 id=\u0026#34;counting-artists-per-user\u0026#34;\u0026gt;Counting Artists Per User\u0026lt;\/h3\u0026gt;\n\u0026lt;p\u0026gt;Let\u0026#39;s take one step at a time, we need to first count how many times each artist has been played for that user.\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;SELECT\n    user_name,\n    artist,\n    COUNT(*) AS play_count\nFROM listening_logs\nGROUP BY user_name, artist\nORDER BY user_name, play_count DESC, artist;\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;OK, simple right?\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Select all the usernames, artist and then group by the username and the artist and count the number of times the user had played that artist. Simply then order by username, the playcount and the artist (if there is a tie in count, I think we can choose the artist name as the breaker)\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;But it gives all the artists, not just the top 3, it ranks them in the decreasing order of the number of plays, but we only want to list the top 3 per user.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;That\u0026#39;s tricky!\u0026lt;\/p\u0026gt;\n\u0026lt;h3 id=\u0026#34;with-self-join\u0026#34;\u0026gt;With SELF JOIN\u0026lt;\/h3\u0026gt;\n\u0026lt;p\u0026gt;What if we can join the table with itself?\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Then we can compare the number of times the user has played the artist, with the number of times the user has played another artist. Then we can remove the artist if it has played less than 3 times, this then will filter out the top 3 for us.\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;SELECT \n    a.user_name,\n    a.artist AS current_artist,\n    a.play_count AS current_plays,\n    b.artist AS other_artist,\n    b.play_count AS other_plays\nFROM (\n    SELECT user_name, artist, COUNT(*) AS play_count\n    FROM listening_logs\n    GROUP BY user_name, artist\n) a\nLEFT JOIN (\n    SELECT user_name, artist, COUNT(*) AS play_count\n    FROM listening_logs\n    GROUP BY user_name, artist\n) b ON a.user_name = b.user_name\nORDER BY a.user_name, a.play_count DESC, b.play_count DESC;\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;This would create a cross join of sorts between the same table.\u0026lt;\/p\u0026gt;\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;Select the required columns (user_name, artist and count)\nLook at this part\nThis is \u0026lt;code\u0026gt;a\u0026lt;\/code\u0026gt;\u0026lt;\/li\u0026gt;\n\u0026lt;\/ul\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;-- a\nSELECT user_name, artist, COUNT(*) AS play_count\nFROM listening_logs\nGROUP BY user_name, artist\nORDER BY user_name, play_count DESC, artist\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;Then we need to join this with itself\u0026lt;\/p\u0026gt;\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;Select the required columns from the same table (user_name, artist and count)\nThis is \u0026lt;code\u0026gt;b\u0026lt;\/code\u0026gt;\u0026lt;\/li\u0026gt;\n\u0026lt;\/ul\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;-- b\nSELECT user_name, artist, COUNT(*) AS play_count\nFROM listening_logs\nGROUP BY user_name, artist\nORDER BY user_name, play_count DESC, artist\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;Both \u0026lt;code\u0026gt;a\u0026lt;\/code\u0026gt; and \u0026lt;code\u0026gt;b\u0026lt;\/code\u0026gt; are the same, just that we want a cross join of sorts.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;And then we need to join \u0026lt;code\u0026gt;a\u0026lt;\/code\u0026gt; and \u0026lt;code\u0026gt;b\u0026lt;\/code\u0026gt;\u0026lt;\/p\u0026gt;\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;Join with itself on the user_name\u0026lt;\/li\u0026gt;\n\u0026lt;li\u0026gt;Order by user_name, play_count desc, artist\u0026lt;\/li\u0026gt;\n\u0026lt;\/ul\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;SELECT \n    a.user_name,\n    a.artist AS current_artist,\n    a.play_count AS current_plays,\n    b.artist AS other_artist,\n    b.play_count AS other_plays\nFROM (\n    SELECT user_name, artist, COUNT(*) AS play_count\n    FROM listening_logs\n    GROUP BY user_name, artist\n) a\nLEFT JOIN (\n    SELECT user_name, artist, COUNT(*) AS play_count\n    FROM listening_logs\n    GROUP BY user_name, artist\n) b ON a.user_name = b.user_name\nORDER BY a.user_name, a.play_count DESC, b.play_count DESC;\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;Now, we want to keep the rows where the \u0026lt;code\u0026gt;b\u0026lt;\/code\u0026gt; table has play count greater than \u0026lt;code\u0026gt;a\u0026lt;\/code\u0026gt; table, or if they are equal, then if the \u0026lt;code\u0026gt;b\u0026lt;\/code\u0026gt; table has artist less than \u0026lt;code\u0026gt;a\u0026lt;\/code\u0026gt; table.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;To do that we can continue the \u0026lt;code\u0026gt;JOIN\u0026lt;\/code\u0026gt; condition with \u0026lt;code\u0026gt;AND\u0026lt;\/code\u0026gt; and add \u0026lt;code\u0026gt;b.play_count \u0026amp;gt; a.play_count\u0026lt;\/code\u0026gt; and \u0026lt;code\u0026gt;b.artist \u0026amp;lt; a.artist\u0026lt;\/code\u0026gt; in case of a tie.\nThe idea here is subtle:\u0026lt;\/p\u0026gt;\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;For a given artist \u0026lt;code\u0026gt;a\u0026lt;\/code\u0026gt;, we count how many artists \u0026lt;code\u0026gt;b\u0026lt;\/code\u0026gt; (for the same user) have more plays, or the same plays but come earlier alphabetically.\u0026lt;\/li\u0026gt;\n\u0026lt;li\u0026gt;If fewer than 3 artists beat \u0026lt;code\u0026gt;a\u0026lt;\/code\u0026gt;, then \u0026lt;code\u0026gt;a\u0026lt;\/code\u0026gt; must be in the top 3.\u0026lt;\/li\u0026gt;\n\u0026lt;\/ul\u0026gt;\n\u0026lt;p\u0026gt;So the query becomes this:\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;SELECT \n    a.user_name,\n    a.artist,\n    a.play_count\nFROM (\n    SELECT user_name, artist, COUNT(*) AS play_count\n    FROM listening_logs\n    GROUP BY user_name, artist\n) a\nLEFT JOIN (\n    SELECT user_name, artist, COUNT(*) AS play_count\n    FROM listening_logs\n    GROUP BY user_name, artist\n) b ON a.user_name = b.user_name\n   AND (\n       b.play_count \u0026gt; a.play_count\n       OR (b.play_count = a.play_count AND b.artist \u0026lt; a.artist)\n   )\nGROUP BY a.user_name, a.artist, a.play_count\nHAVING COUNT(b.artist) \u0026lt; 3\nORDER BY a.user_name, a.play_count DESC, a.artist;\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;div class=\u0026#34;code-block\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;code-header\u0026#34;\u0026gt;\u0026lt;span class=\u0026#34;language-name\u0026#34;\u0026gt;\u0026lt;\/span\u0026gt;\u0026lt;button class=\u0026#34;copy-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-copy\u0026#34;\u0026gt;\u0026lt;rect x=\u0026#34;9\u0026#34; y=\u0026#34;9\u0026#34; width=\u0026#34;13\u0026#34; height=\u0026#34;13\u0026#34; rx=\u0026#34;2\u0026#34; ry=\u0026#34;2\u0026#34;\u0026gt;\u0026lt;\/rect\u0026gt;\u0026lt;path d=\u0026#34;M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code\u0026gt;sqlite\u0026gt; SELECT\n    a.user_name,\n    a.artist,\n    a.play_count\nFROM (\n    SELECT user_name, artist, COUNT(*) AS play_count\n    FROM listening_logs\n    GROUP BY user_name, artist\n) a\nLEFT JOIN (\n    SELECT user_name, artist, COUNT(*) AS play_count\n    FROM listening_logs\n    GROUP BY user_name, artist\n) b ON a.user_name = b.user_name\n   AND (\n       b.play_count \u0026gt; a.play_count\n       OR (b.play_count = a.play_count AND b.artist \u0026lt; a.artist)\n   )\nGROUP BY a.user_name, a.artist, a.play_count\nHAVING COUNT(b.artist) \u0026lt; 3\nORDER BY a.user_name, a.play_count DESC, a.artist;\n\u002b-------------------\u002b--------------------------------------------\u002b------------\u002b\n|     user_name     |                   artist                   | play_count |\n\u002b-------------------\u002b--------------------------------------------\u002b------------\u002b\n| Abigail Hernandez | Ed Sheeran                                 | 78         |\n| Abigail Hernandez | Rotten Mango                               | 15         |\n| Abigail Hernandez | Billie Eilish                              | 4          |\n| Adrian Cox        | Kendrick Lamar                             | 128        |\n| Adrian Cox        | Stuff You Should Know                      | 30         |\n| Adrian Cox        | Fuerza Regida                              | 6          |\n| Alex Rivera       | Ed Sheeran                                 | 274        |\n| Alex Rivera       | Call Her Daddy (Alex Cooper)               | 42         |\n| Alex Rivera       | Green Day                                  | 11         |\n| Anders Nilsson    | Snow Patrol                                | 101        |\n| Anders Nilsson    | SmartLess                                  | 29         |\n| Anders Nilsson    | Blink-182                                  | 5          |\n| Anthony King      | Pentatonix                                 | 114        |\n| Anthony King      | The Tucker Carlson Show                    | 14         |\n| Anthony King      | Angels \u0026amp; Airwaves                          | 5          |\n...\n...\n| Zara Sheikh       | Green Day                                  | 138        |\n| Zara Sheikh       | This Past Weekend w Theo Von               | 20         |\n| Zara Sheikh       | The Beatles                                | 7          |\n| Zoe Garcia        | Arijit Singh                               | 50         |\n| Zoe Garcia        | Huberman Lab                               | 14         |\n| Zoe Garcia        | Kendrick Lamar                             | 5          |\n| Zoe Wilson        | Pentatonix                                 | 65         |\n| Zoe Wilson        | The Mel Robbins Podcast                    | 14         |\n| Zoe Wilson        | Angels \u0026amp; Airwaves                          | 4          |\n| Zuri Okafor       | Kendrick Lamar                             | 96         |\n| Zuri Okafor       | The Tim Dillon Show                        | 14         |\n| Zuri Okafor       | Ed Sheeran                                 | 5          |\n\u002b-------------------\u002b--------------------------------------------\u002b------------\u002b\nRun Time: real 0.088 user 0.082510 sys 0.003999\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;This is the final query, it looks long, it might be not the best way to do it, but its definitely not the worst way to do it.\u0026lt;\/p\u0026gt;\n\u0026lt;h3 id=\u0026#34;with-window-functions\u0026#34;\u0026gt;With Window Functions\u0026lt;\/h3\u0026gt;\n\u0026lt;p\u0026gt;Ok! I don\u0026#39;t know window functions, but I searched and found that we could partition things before we group them or order them in the final result set. That\u0026#39;s what we want right?\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;We had grouped the logs for each username and artist and counted the number of plays. Now we want to rank the artists for each user in the decreasing order of number of plays.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;So, we start with the same thing:\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;SELECT\n    user_name,\n    artist,\n    COUNT(*) AS play_count\nFROM listening_logs\nGROUP BY user_name, artist\nORDER BY user_name, play_count DESC, artist;\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;You can see that we have \u0026lt;code\u0026gt;user_name\u0026lt;\/code\u0026gt; column, what if we could separate out the users, and then we could rank the artists for each user separately.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;For that we can use \u0026lt;code\u0026gt;ROW_NUMBER\u0026lt;\/code\u0026gt; window function. This function needs a \u0026lt;code\u0026gt;PARTITION BY\u0026lt;\/code\u0026gt; clause which lets us create separate partitions based on certain columns, and then we can rank them using the \u0026lt;code\u0026gt;ORDER BY\u0026lt;\/code\u0026gt; clause as we do with ordinary statement. That becomes the row_number, which we can use as a rank to rank each artist for a user based on the number of time the user has played him\/her.\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;SELECT \n    user_name,\n    artist,\n    COUNT(*) AS play_count,\n    ROW_NUMBER() OVER (\n        PARTITION BY user_name \n        ORDER BY COUNT(*) DESC, artist\n    ) AS ranks\nFROM listening_logs\nGROUP BY user_name, artist\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;Here, \u0026lt;code\u0026gt;ROW_NUMBER\u0026lt;\/code\u0026gt; is a window function that assigns a rank to each row in the result set. It partitions the result set by \u0026lt;code\u0026gt;user_name\u0026lt;\/code\u0026gt; and orders the rows in the decreasing order of \u0026lt;code\u0026gt;COUNT(*)\u0026lt;\/code\u0026gt; and \u0026lt;code\u0026gt;artist\u0026lt;\/code\u0026gt; name.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;So, imagine this table:\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;code-block\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;code-header\u0026#34;\u0026gt;\u0026lt;span class=\u0026#34;language-name\u0026#34;\u0026gt;\u0026lt;\/span\u0026gt;\u0026lt;button class=\u0026#34;copy-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-copy\u0026#34;\u0026gt;\u0026lt;rect x=\u0026#34;9\u0026#34; y=\u0026#34;9\u0026#34; width=\u0026#34;13\u0026#34; height=\u0026#34;13\u0026#34; rx=\u0026#34;2\u0026#34; ry=\u0026#34;2\u0026#34;\u0026gt;\u0026lt;\/rect\u0026gt;\u0026lt;path d=\u0026#34;M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code\u0026gt;\u002b-------------------\u002b-------------------------------------\u002b------------\u002b-------\u002b\n|     user_name     |               artist                | play_count | ranks |\n\u002b-------------------\u002b-------------------------------------\u002b------------\u002b-------\u002b\n| Abigail Hernandez | Ed Sheeran                          | 78         | 1     |\n| Abigail Hernandez | Rotten Mango                        | 15         | 2     |\n| Abigail Hernandez | Billie Eilish                       | 4          | 3     |\n| Abigail Hernandez | Hans Zimmer                         | 4          | 4     |\n| Abigail Hernandez | John Legend                         | 3          | 5     |\n| Abigail Hernandez | John Williams                       | 3          | 6     |\n| Abigail Hernandez | The Beatles                         | 3          | 7     |\n| Abigail Hernandez | The Rolling Stones                  | 3          | 8     |\n| Abigail Hernandez | Angels \u0026amp; Airwaves                   | 2          | 9     |\n| Abigail Hernandez | Bad Bunny                           | 2          | 10    |\n| Abigail Hernandez | Beyonce                             | 2          | 11    |\n| Abigail Hernandez | Coldplay                            | 2          | 12    |\n| Abigail Hernandez | Foo Fighters                        | 2          | 13    |\n| Abigail Hernandez | Fuerza Regida                       | 2          | 14    |\n| Abigail Hernandez | Kendrick Lamar                      | 2          | 15    |\n| Abigail Hernandez | Ludovico Einaudi                    | 2          | 16    |\n| Abigail Hernandez | Mariah Carey                        | 2          | 17    |\n| Abigail Hernandez | Pentatonix                          | 2          | 18    |\n| Abigail Hernandez | SmartLess                           | 2          | 19    |\n| Abigail Hernandez | The Weeknd                          | 2          | 20    |\n| Abigail Hernandez | Adele                               | 1          | 21    |\n| Abigail Hernandez | Ariana Grande                       | 1          | 22    |\n| Abigail Hernandez | Armchair Expert With Dax Shepard    | 1          | 23    |\n| Abigail Hernandez | Bruno Mars                          | 1          | 24    |\n| Abigail Hernandez | Candace                             | 1          | 25    |\n| Abigail Hernandez | Crime, Conspiracy, Cults and Murder | 1          | 26    |\n| Abigail Hernandez | Green Day                           | 1          | 27    |\n| Abigail Hernandez | Matt and Shanes Secret Podcast      | 1          | 28    |\n| Abigail Hernandez | On Purpose With Jay Shetty          | 1          | 29    |\n| Abigail Hernandez | Snow Patrol                         | 1          | 30    |\n| Abigail Hernandez | Sufjan Stevens                      | 1          | 31    |\n| Abigail Hernandez | Taylor Swift                        | 1          | 32    |\n| Abigail Hernandez | The Mel Robbins Podcast             | 1          | 33    |\n| Abigail Hernandez | Unseen                              | 1          | 34    |\n| Adrian Cox        | Kendrick Lamar                      | 128        | 1     |\n| Adrian Cox        | Stuff You Should Know               | 30         | 2     |\n| Adrian Cox        | Fuerza Regida                       | 6          | 3     |\n| Adrian Cox        | Pentatonix                          | 6          | 4     |\n| Adrian Cox        | Taylor Swift                        | 6          | 5     |\n| Adrian Cox        | Snow Patrol                         | 5          | 6     |\n\u002b-------------------\u002b-------------------------------------\u002b------------\u002b-------\u002b\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;Now, we have ranked the artist for each user, there are \u0026lt;code\u0026gt;34\u0026lt;\/code\u0026gt; artist played by \u0026lt;code\u0026gt;Abigail Hernandez\u0026lt;\/code\u0026gt; so there are \u0026lt;code\u0026gt;34\u0026lt;\/code\u0026gt; ranks. Now, we need to filter out the top 3 artist for each user. That would be simple right?\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Just add the \u0026lt;code\u0026gt;WHERE\u0026lt;\/code\u0026gt; clause:\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;SELECT\n    user_name,\n    artist,\n    COUNT(*) AS play_count,\n    ROW_NUMBER() OVER (\n        PARTITION BY user_name \n        ORDER BY COUNT(*) DESC, artist\n    ) AS ranks\nFROM listening_logs\nWHERE ranks \u0026lt;= 3\nGROUP BY user_name, artist\nORDER BY user_name, play_count DESC, artist;\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;Well not really!\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;code-block\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;code-header\u0026#34;\u0026gt;\u0026lt;span class=\u0026#34;language-name\u0026#34;\u0026gt;\u0026lt;\/span\u0026gt;\u0026lt;button class=\u0026#34;copy-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-copy\u0026#34;\u0026gt;\u0026lt;rect x=\u0026#34;9\u0026#34; y=\u0026#34;9\u0026#34; width=\u0026#34;13\u0026#34; height=\u0026#34;13\u0026#34; rx=\u0026#34;2\u0026#34; ry=\u0026#34;2\u0026#34;\u0026gt;\u0026lt;\/rect\u0026gt;\u0026lt;path d=\u0026#34;M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code\u0026gt;sqlite\u0026gt; SELECT\n    user_name,\n    artist,\n    COUNT(*) AS play_count,\n    ROW_NUMBER() OVER (\n        PARTITION BY user_name \n        ORDER BY COUNT(*) DESC, artist\n    )\nFROM listening_logs\nWHERE ranks \u0026lt;= 3\nGROUP BY user_name, artist\nORDER BY user_name, play_count DESC, artist;\nRun Time: real 0.000 user 0.000110 sys 0.000000\nParse error: misuse of aliased window function ranks\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;We can\u0026#39;t filter the window function column with a \u0026lt;code\u0026gt;WHERE\u0026lt;\/code\u0026gt; clause. At the time the \u0026lt;code\u0026gt;WHERE\u0026lt;\/code\u0026gt; clause is evaluated, the \u0026lt;code\u0026gt;SELECT\u0026lt;\/code\u0026gt; list (including ranks) has not been computed yet. So ranks doesn\u0026#39;t exist yet!\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;So, now what, so close yet so far!\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Let\u0026#39;s wrap the \u0026lt;code\u0026gt;SELECT\u0026lt;\/code\u0026gt; in a subquery:\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;SELECT user_name, artist, play_count\nFROM (\n    SELECT \n        user_name,\n        artist,\n        COUNT(*) AS play_count,\n        ROW_NUMBER() OVER (\n            PARTITION BY user_name\n            ORDER BY COUNT(*) DESC, artist\n        ) AS ranks\n    FROM listening_logs\n    GROUP BY user_name, artist\n) ranked\nWHERE ranks \u0026lt;= 3\nORDER BY user_name, play_count DESC, artist;\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;And there we have it!\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;We wrapped the \u0026lt;code\u0026gt;SELECT\u0026lt;\/code\u0026gt; in a subquery, and now we can filter the window function column with a \u0026lt;code\u0026gt;WHERE\u0026lt;\/code\u0026gt; clause.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;We can even do it with a \u0026lt;code\u0026gt;CTE\u0026lt;\/code\u0026gt; i.e. common table expression. That\u0026#39;s just a subquery with a name.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Not sure when it could be handy, but here it is.\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;WITH ranked AS (\n    SELECT\n        user_name,\n        artist,\n        COUNT(*) AS play_count,\n        ROW_NUMBER() OVER (\n            PARTITION BY user_name\n            ORDER BY COUNT(*) DESC, artist\n        ) AS ranks\n    FROM listening_logs\n    GROUP BY user_name, artist\n)\nSELECT user_name, artist, play_count\nFROM ranked\nWHERE ranks \u0026lt;= 3\nORDER BY user_name, play_count DESC, artist;\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;So, that is day 5, ok that is getting a little tricky now!\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Off to day 6.\u0026lt;\/p\u0026gt;\n"
    }
    </script>
    
    
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="/code-block.css">
    <link rel="stylesheet" href="/post-navigation.css">
    
    <link rel="icon" href="/tbicon.png" type="image/png">
    <link rel="apple-touch-icon" href="/tbicon.png">
    
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <link id="syntax-theme" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/go.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.13.0/sql-wasm.js"></script>
    <link rel="stylesheet" href="/sql-playground.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/monokai.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/sql/sql.min.js"></script>
    <script src="/sql-playground.js"></script>
    
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script>
    document.addEventListener("DOMContentLoaded", () => {
        const body = document.body;
        const stylesheet = document.getElementById("syntax-theme");
        const themeToggle = document.getElementById('theme-toggle');

        function setSyntaxTheme(theme) {
            if (theme === "secondary") {
                stylesheet.href = "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css";
            } else {
                stylesheet.href = "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css";
            }
        }

        
        document.querySelectorAll("pre code").forEach((block) => {
            hljs.highlightElement(block);
        });

        
        const currentTheme = localStorage.getItem("theme") || "default";
        if (currentTheme === "secondary") {
            body.classList.add("secondary-theme");
            if (themeToggle) themeToggle.checked = true;
        }
        setSyntaxTheme(currentTheme);

        
        if (themeToggle) {
            themeToggle.addEventListener('change', () => {
                const newTheme = themeToggle.checked ? 'secondary' : 'default';
                if (themeToggle.checked) {
                    body.classList.add('secondary-theme');
                } else {
                    body.classList.remove('secondary-theme');
                }
                localStorage.setItem('theme', newTheme);
                setSyntaxTheme(newTheme);
            });
        }
        
        
        const editBtn = document.getElementById('editor-edit');
        if (editBtn) {
            editBtn.addEventListener('click', async function () {
                const slug = "sqlog\/advent-of-sql-2025-day-5";
                const type = "sqlog";
                console.log("Editing post:", slug, type);
                const url = "https:\/\/devmeetgor.netlify.app/.netlify/functions/api?slug=" + slug + "&method=edit&type=" + type;
                
                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error("Failed to fetch edit content");
                    const html = await res.text();
                    document.querySelector('.post-content').innerHTML = html;
                } catch (err) {
                    console.error(err);
                    alert("Error loading editor content");
                }
            });
        }
    });
    </script>
    
    
    <script src="/seasonal-effects.js" defer></script>
    
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EET2ZX4QY1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-EET2ZX4QY1');
    </script>
</head>
<body>
    <header class="header">
  <a class="site-title" href="/" aria-label="Meet Gor - Home">Meet Gor</a>
  <nav>
    <ul>
      <li><a href="/" aria-label="Home">Home</a></li>
      <li><a href="/posts" aria-label="Posts">Posts</a></li>
      <li><a href="/all-content" aria-label="All Content">All Content</a></li>
      <li><a href="/about" aria-label="About">About</a></li>
      <li><a href="/contact" aria-label="Contact">Contact</a></li>
    </ul>
  </nav>
  <div class="theme-switch">
    <input type="checkbox" id="theme-toggle" aria-label="Toggle Theme">
    <label for="theme-toggle"></label>
  </div>
  
</header>
    
    <main class="container">
        <article class="blog-post">
            <h1>Advent of SQL 2025 Day 5: EchoTrack Wrapped</h1>
            
            <div class="post-meta">
                Published on  <time datetime="2025-12-20 15:30 &#43;0530">2025-12-20 15:30 &#43;0530</time>
            </div>
            
            <div class="post-meta">
                Type: <a href="/sqlog">sqlog</a>
            </div>
            
            <div class="post-meta tags">
                <span class="post-series-label"> Tags:</span>
                
                <a href="/tags/sqlite">#sqlite</a>
                
                <a href="/tags/sql">#sql</a>
                
                <a href="/tags/advent-of-sql">#advent-of-sql</a>
                
            </div>
            
            
            <div class="post-series">
                <span class="series-label">Part of the
                <span class="series-list">
                    
                    <a href="/series/advent-of-sql-2025" class="series-link"> advent-of-sql-2025</a>
                    
                </span></span>
                <span class="series-label">series</span>
            </div>
            
            
            
            
            <hr>
            
            <div class="post-content">
                <h2 id="advent-of-sql-day-5---echotrack-wrapped">Advent of SQL Day 5 - EchoTrack Wrapped</h2>
<p>It is day 5 of advent of SQL.</p>
<p>Let's get rollin. It looks like a good problem. I am excited!</p>
<p>Here's the SQL to get started.</p>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">DROP TABLE IF EXISTS listening_logs;

CREATE TABLE listening_logs (
    id INTEGER PRIMARY KEY,
    user_name TEXT,
    artist TEXT,
    played_at TIMESTAMP,
    content_type TEXT
);

INSERT INTO listening_logs (id, user_name, artist, played_at, content_type) VALUES
    (1, 'Zoe Garcia', 'Arijit Singh', '2025-04-08 00:21:53', 'song'),
    (2, 'Zoe Garcia', 'Huberman Lab', '2025-11-10 19:18:47', 'podcast'),
    (3, 'Zoe Garcia', 'Huberman Lab', '2025-01-20 15:31:02', 'podcast'),
    (4, 'Zoe Garcia', 'Arijit Singh', '2025-01-06 17:33:11', 'song'),
    (5, 'Zoe Garcia', 'Candace', '2025-03-06 14:07:54', 'podcast'),
    (6, 'Zoe Garcia', 'Arijit Singh', '2025-06-05 17:57:59', 'song'),
    (7, 'Zoe Garcia', 'Huberman Lab', '2025-01-01 20:05:22', 'podcast'),
    (8, 'Zoe Garcia', 'Huberman Lab', '2025-11-01 12:04:03', 'podcast'),
    (9, 'Zoe Garcia', 'Arijit Singh', '2025-09-28 12:42:12', 'song'),
    (10, 'Zoe Garcia', 'The Ben Shapiro Show', '2025-09-15 01:05:15', 'podcast'),
    (11, 'Zoe Garcia', 'Arijit Singh', '2025-04-26 05:31:02', 'song'),
    (12, 'Zoe Garcia', 'Arijit Singh', '2025-10-13 17:34:03', 'song'),
    (13, 'Zoe Garcia', 'Mariah Carey', '2025-01-20 11:21:37', 'song'),
    (14, 'Zoe Garcia', 'Arijit Singh', '2025-11-28 03:55:31', 'song'),
    (15, 'Zoe Garcia', 'Arijit Singh', '2025-07-17 05:18:16', 'song'),
    (16, 'Zoe Garcia', 'Arijit Singh', '2025-08-20 02:07:45', 'song'),
    (17, 'Zoe Garcia', 'Kendrick Lamar', '2025-02-16 13:25:27', 'song'),
    (18, 'Zoe Garcia', 'Huberman Lab', '2025-08-13 19:55:00', 'podcast'),
    (19, 'Zoe Garcia', 'Bruno Mars', '2025-09-13 07:09:43', 'song'),
    (20, 'Zoe Garcia', 'Arijit Singh', '2025-04-12 06:30:44', 'song');
</code></pre><div class="output"></div></div><p>Let's open a SQLite shell and get started.</p>
<div class="code-block"><div class="code-header"><span class="language-name"></span><button class="copy-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button></div><pre><code>$ sqlite3
SQLite version 3.50.4 2025-07-30 19:33:53
Enter ".help" for usage hints.
Connected to a transient in-memory database.
Use ".open FILENAME" to reopen on a persistent database.
sqlite> .read day5-inserts.sql
sqlite> .schema
CREATE TABLE listening_logs (
    id INTEGER PRIMARY KEY,
    user_name TEXT,
    artist TEXT,
    played_at TIMESTAMP,
    content_type TEXT
);
sqlite> .mode table
sqlite> SELECT * FROM listening_logs LIMIT 20;
+----+------------+----------------------+---------------------+--------------+
| id | user_name  |        artist        |      played_at      | content_type |
+----+------------+----------------------+---------------------+--------------+
| 1  | Zoe Garcia | Arijit Singh         | 2025-04-08 00:21:53 | song         |
| 2  | Zoe Garcia | Huberman Lab         | 2025-11-10 19:18:47 | podcast      |
| 3  | Zoe Garcia | Huberman Lab         | 2025-01-20 15:31:02 | podcast      |
| 4  | Zoe Garcia | Arijit Singh         | 2025-01-06 17:33:11 | song         |
| 5  | Zoe Garcia | Candace              | 2025-03-06 14:07:54 | podcast      |
| 6  | Zoe Garcia | Arijit Singh         | 2025-06-05 17:57:59 | song         |
| 7  | Zoe Garcia | Huberman Lab         | 2025-01-01 20:05:22 | podcast      |
| 8  | Zoe Garcia | Huberman Lab         | 2025-11-01 12:04:03 | podcast      |
| 9  | Zoe Garcia | Arijit Singh         | 2025-09-28 12:42:12 | song         |
| 10 | Zoe Garcia | The Ben Shapiro Show | 2025-09-15 01:05:15 | podcast      |
| 11 | Zoe Garcia | Arijit Singh         | 2025-04-26 05:31:02 | song         |
| 12 | Zoe Garcia | Arijit Singh         | 2025-10-13 17:34:03 | song         |
| 13 | Zoe Garcia | Mariah Carey         | 2025-01-20 11:21:37 | song         |
| 14 | Zoe Garcia | Arijit Singh         | 2025-11-28 03:55:31 | song         |
| 15 | Zoe Garcia | Arijit Singh         | 2025-07-17 05:18:16 | song         |
| 16 | Zoe Garcia | Arijit Singh         | 2025-08-20 02:07:45 | song         |
| 17 | Zoe Garcia | Kendrick Lamar       | 2025-02-16 13:25:27 | song         |
| 18 | Zoe Garcia | Huberman Lab         | 2025-08-13 19:55:00 | podcast      |
| 19 | Zoe Garcia | Bruno Mars           | 2025-09-13 07:09:43 | song         |
| 20 | Zoe Garcia | Arijit Singh         | 2025-04-12 06:30:44 | song         |
+----+------------+----------------------+---------------------+--------------+
sqlite>
sqlite> SELECT COUNT(*) FROM listening_logs;
+----------+
| COUNT(*) |
+----------+
| 18174    |
+----------+
sqlite>
</code></pre></div><p>OK! We have around 18k records in a single table! That's a lot but not not much!</p>
<p>Let's see what we have to do</p>
<h2 id="problem">Problem</h2>
<blockquote>
<p>Write a query that returns the top 3 artists per user. Order the results by the most played</p>
</blockquote>
<p>Alright, this is quite a problem to solve, if you are thinking, it easy peasy, then hold on!</p>
<p>We clearly see, that we have 2 columns of our interest.</p>
<ol>
<li><code>user_name</code></li>
<li><code>artist</code></li>
</ol>
<p>We need to group for each user his most played artists, and we need to rank those top 3 artist per user.</p>
<p>And each entry is a song or podcast that the user has litened to.</p>
<p>We need to aggregate, group, and then rank, and then what?</p>
<p>How would you chunk out the top three?
It's time to put your SQL glasses and gloves on, it's getting colder!</p>
<h3 id="counting-artists-per-user">Counting Artists Per User</h3>
<p>Let's take one step at a time, we need to first count how many times each artist has been played for that user.</p>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">SELECT
    user_name,
    artist,
    COUNT(*) AS play_count
FROM listening_logs
GROUP BY user_name, artist
ORDER BY user_name, play_count DESC, artist;
</code></pre><div class="output"></div></div><p>OK, simple right?</p>
<p>Select all the usernames, artist and then group by the username and the artist and count the number of times the user had played that artist. Simply then order by username, the playcount and the artist (if there is a tie in count, I think we can choose the artist name as the breaker)</p>
<p>But it gives all the artists, not just the top 3, it ranks them in the decreasing order of the number of plays, but we only want to list the top 3 per user.</p>
<p>That's tricky!</p>
<h3 id="with-self-join">With SELF JOIN</h3>
<p>What if we can join the table with itself?</p>
<p>Then we can compare the number of times the user has played the artist, with the number of times the user has played another artist. Then we can remove the artist if it has played less than 3 times, this then will filter out the top 3 for us.</p>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">SELECT 
    a.user_name,
    a.artist AS current_artist,
    a.play_count AS current_plays,
    b.artist AS other_artist,
    b.play_count AS other_plays
FROM (
    SELECT user_name, artist, COUNT(*) AS play_count
    FROM listening_logs
    GROUP BY user_name, artist
) a
LEFT JOIN (
    SELECT user_name, artist, COUNT(*) AS play_count
    FROM listening_logs
    GROUP BY user_name, artist
) b ON a.user_name = b.user_name
ORDER BY a.user_name, a.play_count DESC, b.play_count DESC;
</code></pre><div class="output"></div></div><p>This would create a cross join of sorts between the same table.</p>
<ul>
<li>Select the required columns (user_name, artist and count)
Look at this part
This is <code>a</code></li>
</ul>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">-- a
SELECT user_name, artist, COUNT(*) AS play_count
FROM listening_logs
GROUP BY user_name, artist
ORDER BY user_name, play_count DESC, artist
</code></pre><div class="output"></div></div><p>Then we need to join this with itself</p>
<ul>
<li>Select the required columns from the same table (user_name, artist and count)
This is <code>b</code></li>
</ul>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">-- b
SELECT user_name, artist, COUNT(*) AS play_count
FROM listening_logs
GROUP BY user_name, artist
ORDER BY user_name, play_count DESC, artist
</code></pre><div class="output"></div></div><p>Both <code>a</code> and <code>b</code> are the same, just that we want a cross join of sorts.</p>
<p>And then we need to join <code>a</code> and <code>b</code></p>
<ul>
<li>Join with itself on the user_name</li>
<li>Order by user_name, play_count desc, artist</li>
</ul>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">SELECT 
    a.user_name,
    a.artist AS current_artist,
    a.play_count AS current_plays,
    b.artist AS other_artist,
    b.play_count AS other_plays
FROM (
    SELECT user_name, artist, COUNT(*) AS play_count
    FROM listening_logs
    GROUP BY user_name, artist
) a
LEFT JOIN (
    SELECT user_name, artist, COUNT(*) AS play_count
    FROM listening_logs
    GROUP BY user_name, artist
) b ON a.user_name = b.user_name
ORDER BY a.user_name, a.play_count DESC, b.play_count DESC;
</code></pre><div class="output"></div></div><p>Now, we want to keep the rows where the <code>b</code> table has play count greater than <code>a</code> table, or if they are equal, then if the <code>b</code> table has artist less than <code>a</code> table.</p>
<p>To do that we can continue the <code>JOIN</code> condition with <code>AND</code> and add <code>b.play_count &gt; a.play_count</code> and <code>b.artist &lt; a.artist</code> in case of a tie.
The idea here is subtle:</p>
<ul>
<li>For a given artist <code>a</code>, we count how many artists <code>b</code> (for the same user) have more plays, or the same plays but come earlier alphabetically.</li>
<li>If fewer than 3 artists beat <code>a</code>, then <code>a</code> must be in the top 3.</li>
</ul>
<p>So the query becomes this:</p>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">SELECT 
    a.user_name,
    a.artist,
    a.play_count
FROM (
    SELECT user_name, artist, COUNT(*) AS play_count
    FROM listening_logs
    GROUP BY user_name, artist
) a
LEFT JOIN (
    SELECT user_name, artist, COUNT(*) AS play_count
    FROM listening_logs
    GROUP BY user_name, artist
) b ON a.user_name = b.user_name
   AND (
       b.play_count > a.play_count
       OR (b.play_count = a.play_count AND b.artist < a.artist)
   )
GROUP BY a.user_name, a.artist, a.play_count
HAVING COUNT(b.artist) < 3
ORDER BY a.user_name, a.play_count DESC, a.artist;
</code></pre><div class="output"></div></div><div class="code-block"><div class="code-header"><span class="language-name"></span><button class="copy-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button></div><pre><code>sqlite> SELECT
    a.user_name,
    a.artist,
    a.play_count
FROM (
    SELECT user_name, artist, COUNT(*) AS play_count
    FROM listening_logs
    GROUP BY user_name, artist
) a
LEFT JOIN (
    SELECT user_name, artist, COUNT(*) AS play_count
    FROM listening_logs
    GROUP BY user_name, artist
) b ON a.user_name = b.user_name
   AND (
       b.play_count > a.play_count
       OR (b.play_count = a.play_count AND b.artist < a.artist)
   )
GROUP BY a.user_name, a.artist, a.play_count
HAVING COUNT(b.artist) < 3
ORDER BY a.user_name, a.play_count DESC, a.artist;
+-------------------+--------------------------------------------+------------+
|     user_name     |                   artist                   | play_count |
+-------------------+--------------------------------------------+------------+
| Abigail Hernandez | Ed Sheeran                                 | 78         |
| Abigail Hernandez | Rotten Mango                               | 15         |
| Abigail Hernandez | Billie Eilish                              | 4          |
| Adrian Cox        | Kendrick Lamar                             | 128        |
| Adrian Cox        | Stuff You Should Know                      | 30         |
| Adrian Cox        | Fuerza Regida                              | 6          |
| Alex Rivera       | Ed Sheeran                                 | 274        |
| Alex Rivera       | Call Her Daddy (Alex Cooper)               | 42         |
| Alex Rivera       | Green Day                                  | 11         |
| Anders Nilsson    | Snow Patrol                                | 101        |
| Anders Nilsson    | SmartLess                                  | 29         |
| Anders Nilsson    | Blink-182                                  | 5          |
| Anthony King      | Pentatonix                                 | 114        |
| Anthony King      | The Tucker Carlson Show                    | 14         |
| Anthony King      | Angels & Airwaves                          | 5          |
...
...
| Zara Sheikh       | Green Day                                  | 138        |
| Zara Sheikh       | This Past Weekend w Theo Von               | 20         |
| Zara Sheikh       | The Beatles                                | 7          |
| Zoe Garcia        | Arijit Singh                               | 50         |
| Zoe Garcia        | Huberman Lab                               | 14         |
| Zoe Garcia        | Kendrick Lamar                             | 5          |
| Zoe Wilson        | Pentatonix                                 | 65         |
| Zoe Wilson        | The Mel Robbins Podcast                    | 14         |
| Zoe Wilson        | Angels & Airwaves                          | 4          |
| Zuri Okafor       | Kendrick Lamar                             | 96         |
| Zuri Okafor       | The Tim Dillon Show                        | 14         |
| Zuri Okafor       | Ed Sheeran                                 | 5          |
+-------------------+--------------------------------------------+------------+
Run Time: real 0.088 user 0.082510 sys 0.003999
</code></pre></div><p>This is the final query, it looks long, it might be not the best way to do it, but its definitely not the worst way to do it.</p>
<h3 id="with-window-functions">With Window Functions</h3>
<p>Ok! I don't know window functions, but I searched and found that we could partition things before we group them or order them in the final result set. That's what we want right?</p>
<p>We had grouped the logs for each username and artist and counted the number of plays. Now we want to rank the artists for each user in the decreasing order of number of plays.</p>
<p>So, we start with the same thing:</p>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">SELECT
    user_name,
    artist,
    COUNT(*) AS play_count
FROM listening_logs
GROUP BY user_name, artist
ORDER BY user_name, play_count DESC, artist;
</code></pre><div class="output"></div></div><p>You can see that we have <code>user_name</code> column, what if we could separate out the users, and then we could rank the artists for each user separately.</p>
<p>For that we can use <code>ROW_NUMBER</code> window function. This function needs a <code>PARTITION BY</code> clause which lets us create separate partitions based on certain columns, and then we can rank them using the <code>ORDER BY</code> clause as we do with ordinary statement. That becomes the row_number, which we can use as a rank to rank each artist for a user based on the number of time the user has played him/her.</p>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">SELECT 
    user_name,
    artist,
    COUNT(*) AS play_count,
    ROW_NUMBER() OVER (
        PARTITION BY user_name 
        ORDER BY COUNT(*) DESC, artist
    ) AS ranks
FROM listening_logs
GROUP BY user_name, artist
</code></pre><div class="output"></div></div><p>Here, <code>ROW_NUMBER</code> is a window function that assigns a rank to each row in the result set. It partitions the result set by <code>user_name</code> and orders the rows in the decreasing order of <code>COUNT(*)</code> and <code>artist</code> name.</p>
<p>So, imagine this table:</p>
<div class="code-block"><div class="code-header"><span class="language-name"></span><button class="copy-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button></div><pre><code>+-------------------+-------------------------------------+------------+-------+
|     user_name     |               artist                | play_count | ranks |
+-------------------+-------------------------------------+------------+-------+
| Abigail Hernandez | Ed Sheeran                          | 78         | 1     |
| Abigail Hernandez | Rotten Mango                        | 15         | 2     |
| Abigail Hernandez | Billie Eilish                       | 4          | 3     |
| Abigail Hernandez | Hans Zimmer                         | 4          | 4     |
| Abigail Hernandez | John Legend                         | 3          | 5     |
| Abigail Hernandez | John Williams                       | 3          | 6     |
| Abigail Hernandez | The Beatles                         | 3          | 7     |
| Abigail Hernandez | The Rolling Stones                  | 3          | 8     |
| Abigail Hernandez | Angels & Airwaves                   | 2          | 9     |
| Abigail Hernandez | Bad Bunny                           | 2          | 10    |
| Abigail Hernandez | Beyonce                             | 2          | 11    |
| Abigail Hernandez | Coldplay                            | 2          | 12    |
| Abigail Hernandez | Foo Fighters                        | 2          | 13    |
| Abigail Hernandez | Fuerza Regida                       | 2          | 14    |
| Abigail Hernandez | Kendrick Lamar                      | 2          | 15    |
| Abigail Hernandez | Ludovico Einaudi                    | 2          | 16    |
| Abigail Hernandez | Mariah Carey                        | 2          | 17    |
| Abigail Hernandez | Pentatonix                          | 2          | 18    |
| Abigail Hernandez | SmartLess                           | 2          | 19    |
| Abigail Hernandez | The Weeknd                          | 2          | 20    |
| Abigail Hernandez | Adele                               | 1          | 21    |
| Abigail Hernandez | Ariana Grande                       | 1          | 22    |
| Abigail Hernandez | Armchair Expert With Dax Shepard    | 1          | 23    |
| Abigail Hernandez | Bruno Mars                          | 1          | 24    |
| Abigail Hernandez | Candace                             | 1          | 25    |
| Abigail Hernandez | Crime, Conspiracy, Cults and Murder | 1          | 26    |
| Abigail Hernandez | Green Day                           | 1          | 27    |
| Abigail Hernandez | Matt and Shanes Secret Podcast      | 1          | 28    |
| Abigail Hernandez | On Purpose With Jay Shetty          | 1          | 29    |
| Abigail Hernandez | Snow Patrol                         | 1          | 30    |
| Abigail Hernandez | Sufjan Stevens                      | 1          | 31    |
| Abigail Hernandez | Taylor Swift                        | 1          | 32    |
| Abigail Hernandez | The Mel Robbins Podcast             | 1          | 33    |
| Abigail Hernandez | Unseen                              | 1          | 34    |
| Adrian Cox        | Kendrick Lamar                      | 128        | 1     |
| Adrian Cox        | Stuff You Should Know               | 30         | 2     |
| Adrian Cox        | Fuerza Regida                       | 6          | 3     |
| Adrian Cox        | Pentatonix                          | 6          | 4     |
| Adrian Cox        | Taylor Swift                        | 6          | 5     |
| Adrian Cox        | Snow Patrol                         | 5          | 6     |
+-------------------+-------------------------------------+------------+-------+
</code></pre></div><p>Now, we have ranked the artist for each user, there are <code>34</code> artist played by <code>Abigail Hernandez</code> so there are <code>34</code> ranks. Now, we need to filter out the top 3 artist for each user. That would be simple right?</p>
<p>Just add the <code>WHERE</code> clause:</p>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">SELECT
    user_name,
    artist,
    COUNT(*) AS play_count,
    ROW_NUMBER() OVER (
        PARTITION BY user_name 
        ORDER BY COUNT(*) DESC, artist
    ) AS ranks
FROM listening_logs
WHERE ranks <= 3
GROUP BY user_name, artist
ORDER BY user_name, play_count DESC, artist;
</code></pre><div class="output"></div></div><p>Well not really!</p>
<div class="code-block"><div class="code-header"><span class="language-name"></span><button class="copy-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button></div><pre><code>sqlite> SELECT
    user_name,
    artist,
    COUNT(*) AS play_count,
    ROW_NUMBER() OVER (
        PARTITION BY user_name 
        ORDER BY COUNT(*) DESC, artist
    )
FROM listening_logs
WHERE ranks <= 3
GROUP BY user_name, artist
ORDER BY user_name, play_count DESC, artist;
Run Time: real 0.000 user 0.000110 sys 0.000000
Parse error: misuse of aliased window function ranks
</code></pre></div><p>We can't filter the window function column with a <code>WHERE</code> clause. At the time the <code>WHERE</code> clause is evaluated, the <code>SELECT</code> list (including ranks) has not been computed yet. So ranks doesn't exist yet!</p>
<p>So, now what, so close yet so far!</p>
<p>Let's wrap the <code>SELECT</code> in a subquery:</p>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">SELECT user_name, artist, play_count
FROM (
    SELECT 
        user_name,
        artist,
        COUNT(*) AS play_count,
        ROW_NUMBER() OVER (
            PARTITION BY user_name
            ORDER BY COUNT(*) DESC, artist
        ) AS ranks
    FROM listening_logs
    GROUP BY user_name, artist
) ranked
WHERE ranks <= 3
ORDER BY user_name, play_count DESC, artist;
</code></pre><div class="output"></div></div><p>And there we have it!</p>
<p>We wrapped the <code>SELECT</code> in a subquery, and now we can filter the window function column with a <code>WHERE</code> clause.</p>
<p>We can even do it with a <code>CTE</code> i.e. common table expression. That's just a subquery with a name.</p>
<p>Not sure when it could be handy, but here it is.</p>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">WITH ranked AS (
    SELECT
        user_name,
        artist,
        COUNT(*) AS play_count,
        ROW_NUMBER() OVER (
            PARTITION BY user_name
            ORDER BY COUNT(*) DESC, artist
        ) AS ranks
    FROM listening_logs
    GROUP BY user_name, artist
)
SELECT user_name, artist, play_count
FROM ranked
WHERE ranks <= 3
ORDER BY user_name, play_count DESC, artist;
</code></pre><div class="output"></div></div><p>So, that is day 5, ok that is getting a little tricky now!</p>
<p>Off to day 6.</p>

            </div>
        </article>
        
        
        

<nav class="post-navigation" aria-label="Post Navigation">
    <div class="nav-container">
        
        
        <a href="/sqlog/advent-of-sql-2025-day-4" class="nav-link nav-prev" title="Previous Post">
            <span class="nav-arrow"></span>
            <span class="nav-label">Previous</span>
            <span class="nav-title">Advent of SQL 2025 Day 4: WinterFest Volunteers</span>
        </a>
        

        
        
        <a href="/sqlog/advent-of-sql-2025-day-6" class="nav-link nav-next" title="Next Post">
            <span class="nav-label">Next</span>
            <span class="nav-title">Advent of SQL 2025 Day 6: Days of Delight</span>
            <span class="nav-arrow"></span>
        </a>
        
    </div>
</nav>


        
        
        


<aside class="related-reading" aria-labelledby="related-reading-title">
    <h3 id="related-reading-title" class="related-title"> Related Reading</h3>
    <ul class="related-list">
        
        
        <li class="related-item">
            <a href="/sqlog/advent-of-sql-2025-day-15" class="related-link">
                <span class="related-post-title">Advent of SQL 2025 Day 15: Confirmation Phrase Dispatches</span>
                <span class="related-post-date">2025-12-28 20:30 &#43;0530</span>
            </a>
        </li>
        
        
        
        <li class="related-item">
            <a href="/sqlog/advent-of-sql-2025-day-14" class="related-link">
                <span class="related-post-title">Advent of SQL 2025 Day 14: Ski Resort Paths</span>
                <span class="related-post-date">2025-12-28 15:30 &#43;0530</span>
            </a>
        </li>
        
        
        
        <li class="related-item">
            <a href="/sqlog/advent-of-sql-2025-day-13" class="related-link">
                <span class="related-post-title">Advent of SQL 2025 Day 13: XML Travel Manifests</span>
                <span class="related-post-date">2025-12-27 20:30 &#43;0530</span>
            </a>
        </li>
        
        
        
        <li class="related-item">
            <a href="/sqlog/advent-of-sql-2025-day-12" class="related-link">
                <span class="related-post-title">Advent of SQL 2025 Day 12: Archive Flight Records</span>
                <span class="related-post-date">2025-12-27 15:30 &#43;0530</span>
            </a>
        </li>
        
        
        
        <li class="related-item">
            <a href="/sqlog/advent-of-sql-2025-day-11" class="related-link">
                <span class="related-post-title">Advent of SQL 2025 Day 11: Behavior Score</span>
                <span class="related-post-date">2025-12-26 15:30 &#43;0530</span>
            </a>
        </li>
        
        
    </ul>
</aside>


    </main>
    
    <div id="comments">
        <script src="https://giscus.app/client.js"
            data-repo="Mr-Destructive/meetgor.com"
            data-repo-id="R_kgDOHZ6V_g"
            data-category="Q&A"
            data-category-id="DIC_kwDOHZ6V_s4CRfn4"
            data-mapping="pathname"
            data-strict="0"
            data-reactions-enabled="1"
            data-emit-metadata="0"
            data-input-position="bottom"
            data-theme="dark_high_contrast"
            data-lang="en"
            crossorigin="anonymous"
            async>
        </script>
    </div>
    
    <footer class="site-footer" role="contentinfo">
  <div class="footer-content">
    <p>&copy; Meet Gor. All rights reserved.</p>
    <div class="social-links">
      <a href="/contact" aria-label="Connect with me">Connect with me</a>
    </div>
  </div>
</footer>
    
</body>
</html>
