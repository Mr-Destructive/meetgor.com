<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <title>Advent of SQL 2025 Day 10: Misdelivered Presents | Meet Gor</title>
    <meta name="title" content="Advent of SQL 2025 Day 10: Misdelivered Presents | Meet Gor">
    <meta name="description" content="">
    <meta name="author" content="Meet Gor">
    <meta name="keywords" content="sqlite, sql, advent-of-sql">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://meetgor.com/sqlog/advent-of-sql-2025-day-10">
    
    
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://meetgor.com/sqlog/advent-of-sql-2025-day-10">
    <meta property="og:title" content="Advent of SQL 2025 Day 10: Misdelivered Presents">
    <meta property="og:description" content="">
    <meta property="og:image" content="https://meetgor.com/tbicon.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="Advent of SQL 2025 Day 10: Misdelivered Presents">
    <meta property="og:locale" content="en_US">
    <meta property="og:site_name" content="Meet Gor">
    <meta property="article:published_time" content="2025-12-25 15:30 &#43;0530">
    <meta property="article:modified_time" content="2025-12-25 15:30 &#43;0530">
    <meta property="article:author" content="Meet Gor">
    
    <meta property="article:tag" content="sqlite">
    
    <meta property="article:tag" content="sql">
    
    <meta property="article:tag" content="advent-of-sql">
    
    
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@meetgor711">
    <meta name="twitter:creator" content="@meetgor711">
    <meta name="twitter:url" content="https://meetgor.com/sqlog/advent-of-sql-2025-day-10">
    <meta name="twitter:title" content="Advent of SQL 2025 Day 10: Misdelivered Presents">
    <meta name="twitter:description" content="">
    <meta name="twitter:image" content="https://meetgor.com/tbicon.png">
    <meta name="twitter:image:alt" content="Advent of SQL 2025 Day 10: Misdelivered Presents">
    
    
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/meetgor.com/sqlog\/advent-of-sql-2025-day-10"
        },
        "headline": "Advent of SQL 2025 Day 10: Misdelivered Presents",
        "description": "",
        "datePublished": "2025-12-25 15:30 \u002b0530",
        "dateModified": "2025-12-25 15:30 \u002b0530",
        "author": {
            "@type": "Person",
            "name": "Meet Gor"
        },
        "publisher": {
            "@type": "Organization",
            "name": "Meet Gor",
            "logo": {
                "@type": "ImageObject",
                "url": "https:\/\/meetgor.com/tbicon.png"
            }
        },
        
        "keywords": "sqlite, sql, advent-of-sql",
        "articleBody": "\u0026lt;h2 id=\u0026#34;advent-of-sql-day-10---misdelivered-presents\u0026#34;\u0026gt;Advent of SQL, Day 10 - Misdelivered Presents\u0026lt;\/h2\u0026gt;\n\u0026lt;p\u0026gt;It\u0026#39;s already day 10? We just need 5 more days now! Whoa! that flew by swiftly.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Let\u0026#39;s pull in the data.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;This is the SQL for day 10 in SQLite.\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;DROP TABLE IF EXISTS misdelivered_presents;\nDROP TABLE IF EXISTS deliveries;\n\nCREATE TABLE deliveries (\n    id INT PRIMARY KEY,\n    child_name TEXT,\n    delivery_location TEXT,\n    gift_name TEXT,\n    scheduled_at TIMESTAMP\n);\n\nCREATE TABLE misdelivered_presents (\n    id INT PRIMARY KEY,\n    child_name TEXT,\n    delivery_location TEXT,\n    gift_name TEXT,\n    scheduled_at TIMESTAMP,\n    flagged_at TIMESTAMP,\n    reason TEXT\n);\n\nINSERT INTO deliveries (id, child_name, delivery_location, gift_name, scheduled_at) VALUES\n    (1, \u0026#39;Omar Q.\u0026#39;, \u0026#39;45 Maple Street\u0026#39;, \u0026#39;storybook collection\u0026#39;, \u0026#39;2025-12-24 21:09:00\u0026#39;),\n    (2, \u0026#39;Sofia K.\u0026#39;, \u0026#39;77 Snowflake Road\u0026#39;, \u0026#39;plush reindeer\u0026#39;, \u0026#39;2025-12-24 18:35:00\u0026#39;),\n    (3, \u0026#39;Mila N.\u0026#39;, \u0026#39;The Vibes\u0026#39;, \u0026#39;storybook collection\u0026#39;, \u0026#39;2025-12-24 21:09:00\u0026#39;),\n    (4, \u0026#39;Elias M.\u0026#39;, \u0026#39;Frost Hollow Cabin\u0026#39;, \u0026#39;board game\u0026#39;, \u0026#39;2025-12-24 20:31:00\u0026#39;),\n    (5, \u0026#39;Ravi P.\u0026#39;, \u0026#39;45 Maple Street\u0026#39;, \u0026#39;wooden train set\u0026#39;, \u0026#39;2025-12-24 18:23:00\u0026#39;),\n    (6, \u0026#39;Jonah W.\u0026#39;, \u0026#39;77 Snowflake Road\u0026#39;, \u0026#39;plush reindeer\u0026#39;, \u0026#39;2025-12-24 20:34:00\u0026#39;),\n    (7, \u0026#39;Ava J.\u0026#39;, \u0026#39;123 Evergreen Lane\u0026#39;, \u0026#39;board game\u0026#39;, \u0026#39;2025-12-24 21:03:00\u0026#39;),\n    (8, \u0026#39;Omar Q.\u0026#39;, \u0026#39;77 Snowflake Road\u0026#39;, \u0026#39;board game\u0026#39;, \u0026#39;2025-12-24 18:56:00\u0026#39;),\n    (9, \u0026#39;Nia G.\u0026#39;, \u0026#39;Frost Hollow Cabin\u0026#39;, \u0026#39;teddy bear\u0026#39;, \u0026#39;2025-12-24 21:27:00\u0026#39;),\n    (10, \u0026#39;Zara S.\u0026#39;, \u0026#39;North Pole Annex\u0026#39;, \u0026#39;wooden train set\u0026#39;, \u0026#39;2025-12-24 20:58:00\u0026#39;),\n    (11, \u0026#39;Ravi P.\u0026#39;, \u0026#39;Frost Hollow Cabin\u0026#39;, \u0026#39;puzzle box\u0026#39;, \u0026#39;2025-12-24 18:39:00\u0026#39;),\n    (12, \u0026#39;Jonah W.\u0026#39;, \u0026#39;123 Evergreen Lane\u0026#39;, \u0026#39;puzzle box\u0026#39;, \u0026#39;2025-12-24 18:23:00\u0026#39;),\n    (13, \u0026#39;Ravi P.\u0026#39;, \u0026#39;North Pole Annex\u0026#39;, \u0026#39;storybook collection\u0026#39;, \u0026#39;2025-12-24 21:36:00\u0026#39;),\n    (14, \u0026#39;Lena F.\u0026#39;, \u0026#39;North Pole Annex\u0026#39;, \u0026#39;teddy bear\u0026#39;, \u0026#39;2025-12-24 21:26:00\u0026#39;),\n    (15, \u0026#39;Ava J.\u0026#39;, \u0026#39;North Pole Annex\u0026#39;, \u0026#39;snow globe\u0026#39;, \u0026#39;2025-12-24 18:31:00\u0026#39;),\n    (16, \u0026#39;Elias M.\u0026#39;, \u0026#39;Frost Hollow Cabin\u0026#39;, \u0026#39;robot toy\u0026#39;, \u0026#39;2025-12-24 20:21:00\u0026#39;),\n    (17, \u0026#39;Sofia K.\u0026#39;, \u0026#39;Frost Hollow Cabin\u0026#39;, \u0026#39;teddy bear\u0026#39;, \u0026#39;2025-12-24 20:27:00\u0026#39;),\n    (18, \u0026#39;Jonah W.\u0026#39;, \u0026#39;77 Snowflake Road\u0026#39;, \u0026#39;storybook collection\u0026#39;, \u0026#39;2025-12-24 20:49:00\u0026#39;),\n    (19, \u0026#39;Jonah W.\u0026#39;, \u0026#39;Frost Hollow Cabin\u0026#39;, \u0026#39;art supplies\u0026#39;, \u0026#39;2025-12-24 21:38:00\u0026#39;),\n    (20, \u0026#39;Jonah W.\u0026#39;, \u0026#39;123 Evergreen Lane\u0026#39;, \u0026#39;storybook collection\u0026#39;, \u0026#39;2025-12-24 19:11:00\u0026#39;);\n\nINSERT INTO misdelivered_presents\n(id, child_name, delivery_location, gift_name, scheduled_at, flagged_at, reason)\nVALUES\n    (601, \u0026#39;Priya D.\u0026#39;, \u0026#39;The Vibes\u0026#39;, \u0026#39;plush reindeer\u0026#39;, \u0026#39;2025-12-24 14:00:00\u0026#39;, \u0026#39;2025-12-24 14:05:00\u0026#39;, \u0026#39;Invalid delivery location\u0026#39;),\n    (602, \u0026#39;Lena F.\u0026#39;, \u0026#39;Abandoned Lighthouse\u0026#39;, \u0026#39;board game\u0026#39;, \u0026#39;2025-12-22 06:00:00\u0026#39;, \u0026#39;2025-12-22 06:05:00\u0026#39;, \u0026#39;Invalid delivery location\u0026#39;),\n    (603, \u0026#39;Caleb O.\u0026#39;, \u0026#39;Drifting Igloo\u0026#39;, \u0026#39;board game\u0026#39;, \u0026#39;2025-12-24 06:00:00\u0026#39;, \u0026#39;2025-12-24 06:05:00\u0026#39;, \u0026#39;Invalid delivery location\u0026#39;),\n    (604, \u0026#39;Mateo C.\u0026#39;, \u0026#39;The Vibes\u0026#39;, \u0026#39;art supplies\u0026#39;, \u0026#39;2025-12-22 04:00:00\u0026#39;, \u0026#39;2025-12-22 04:05:00\u0026#39;, \u0026#39;Invalid delivery location\u0026#39;),\n    (605, \u0026#39;Hiro T.\u0026#39;, \u0026#39;The Vibes\u0026#39;, \u0026#39;robot toy\u0026#39;, \u0026#39;2025-12-24 08:00:00\u0026#39;, \u0026#39;2025-12-24 08:05:00\u0026#39;, \u0026#39;Invalid delivery location\u0026#39;),\n    (606, \u0026#39;Priya D.\u0026#39;, \u0026#39;Volcano Rim\u0026#39;, \u0026#39;puzzle box\u0026#39;, \u0026#39;2025-12-22 08:00:00\u0026#39;, \u0026#39;2025-12-22 08:05:00\u0026#39;, \u0026#39;Invalid delivery location\u0026#39;),\n    (607, \u0026#39;Nia G.\u0026#39;, \u0026#39;Abandoned Lighthouse\u0026#39;, \u0026#39;board game\u0026#39;, \u0026#39;2025-12-24 01:00:00\u0026#39;, \u0026#39;2025-12-24 01:05:00\u0026#39;, \u0026#39;Invalid delivery location\u0026#39;),\n    (608, \u0026#39;Elias M.\u0026#39;, \u0026#39;Drifting Igloo\u0026#39;, \u0026#39;board game\u0026#39;, \u0026#39;2025-12-24 01:00:00\u0026#39;, \u0026#39;2025-12-24 01:05:00\u0026#39;, \u0026#39;Invalid delivery location\u0026#39;),\n    (609, \u0026#39;Ravi P.\u0026#39;, \u0026#39;Volcano Rim\u0026#39;, \u0026#39;board game\u0026#39;, \u0026#39;2025-12-24 02:00:00\u0026#39;, \u0026#39;2025-12-24 02:05:00\u0026#39;, \u0026#39;Invalid delivery location\u0026#39;),\n    (610, \u0026#39;Hiro T.\u0026#39;, \u0026#39;Abandoned Lighthouse\u0026#39;, \u0026#39;science kit\u0026#39;, \u0026#39;2025-12-23 20:00:00\u0026#39;, \u0026#39;2025-12-23 20:05:00\u0026#39;, \u0026#39;Invalid delivery location\u0026#39;),\n    (611, \u0026#39;Priya D.\u0026#39;, \u0026#39;Drifting Igloo\u0026#39;, \u0026#39;puzzle box\u0026#39;, \u0026#39;2025-12-22 21:00:00\u0026#39;, \u0026#39;2025-12-22 21:05:00\u0026#39;, \u0026#39;Invalid delivery location\u0026#39;),\n    (612, \u0026#39;Hiro T.\u0026#39;, \u0026#39;Volcano Rim\u0026#39;, \u0026#39;art supplies\u0026#39;, \u0026#39;2025-12-23 09:00:00\u0026#39;, \u0026#39;2025-12-23 09:05:00\u0026#39;, \u0026#39;Invalid delivery location\u0026#39;),\n    (613, \u0026#39;Jonah W.\u0026#39;, \u0026#39;Abandoned Lighthouse\u0026#39;, \u0026#39;board game\u0026#39;, \u0026#39;2025-12-24 01:00:00\u0026#39;, \u0026#39;2025-12-24 01:05:00\u0026#39;, \u0026#39;Invalid delivery location\u0026#39;),\n    (614, \u0026#39;Omar Q.\u0026#39;, \u0026#39;Volcano Rim\u0026#39;, \u0026#39;art supplies\u0026#39;, \u0026#39;2025-12-22 01:00:00\u0026#39;, \u0026#39;2025-12-22 01:05:00\u0026#39;, \u0026#39;Invalid delivery location\u0026#39;),\n    (615, \u0026#39;Omar Q.\u0026#39;, \u0026#39;Drifting Igloo\u0026#39;, \u0026#39;science kit\u0026#39;, \u0026#39;2025-12-23 20:00:00\u0026#39;, \u0026#39;2025-12-23 20:05:00\u0026#39;, \u0026#39;Invalid delivery location\u0026#39;),\n    (616, \u0026#39;Omar Q.\u0026#39;, \u0026#39;Abandoned Lighthouse\u0026#39;, \u0026#39;teddy bear\u0026#39;, \u0026#39;2025-12-24 12:00:00\u0026#39;, \u0026#39;2025-12-24 12:05:00\u0026#39;, \u0026#39;Invalid delivery location\u0026#39;),\n    (617, \u0026#39;Zara S.\u0026#39;, \u0026#39;Volcano Rim\u0026#39;, \u0026#39;wooden train set\u0026#39;, \u0026#39;2025-12-24 12:00:00\u0026#39;, \u0026#39;2025-12-24 12:05:00\u0026#39;, \u0026#39;Invalid delivery location\u0026#39;),\n    (618, \u0026#39;Omar Q.\u0026#39;, \u0026#39;Abandoned Lighthouse\u0026#39;, \u0026#39;teddy bear\u0026#39;, \u0026#39;2025-12-23 15:00:00\u0026#39;, \u0026#39;2025-12-23 15:05:00\u0026#39;, \u0026#39;Invalid delivery location\u0026#39;),\n    (619, \u0026#39;Caleb O.\u0026#39;, \u0026#39;The Vibes\u0026#39;, \u0026#39;teddy bear\u0026#39;, \u0026#39;2025-12-24 14:00:00\u0026#39;, \u0026#39;2025-12-24 14:05:00\u0026#39;, \u0026#39;Invalid delivery location\u0026#39;),\n    (620, \u0026#39;Nia G.\u0026#39;, \u0026#39;Abandoned Lighthouse\u0026#39;, \u0026#39;board game\u0026#39;, \u0026#39;2025-12-23 03:00:00\u0026#39;, \u0026#39;2025-12-23 03:05:00\u0026#39;, \u0026#39;Invalid delivery location\u0026#39;);\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;SELECT * FROM deliveries;\nSELECT * FROM misdelivered_presents;\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;We have two tables. Almost the same with critical logical distinction among them and one extra column.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Let\u0026#39;s see the problem to check it.\u0026lt;\/p\u0026gt;\n\u0026lt;h2 id=\u0026#34;problem\u0026#34;\u0026gt;Problem\u0026lt;\/h2\u0026gt;\n\u0026lt;blockquote\u0026gt;\n\u0026lt;p\u0026gt;Clean-up the deliveries table to remove any records where the delivery_location is \u0026#39;Volcano Rim\u0026#39;, \u0026#39;Drifting Igloo\u0026#39;, \u0026#39;Abandoned Lighthouse\u0026#39;, \u0026#39;The Vibes\u0026#39;.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Move those records to the misdelivered_presents with all the same columns as deliveries plus a flagged_at column with the current time and a reason column with \u0026amp;quot;Invalid delivery location\u0026amp;quot; listed as the reason for each moved record.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Make sure your final step shows the misdelivered_presents records that you just moved (i.e. don\u0026#39;t include any existing records from the misdelivered_presents table).\u0026lt;\/p\u0026gt;\n\u0026lt;\/blockquote\u0026gt;\n\u0026lt;p\u0026gt;Ok, this looks some easy problem.\u0026lt;\/p\u0026gt;\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;SELECT some data\u0026lt;\/li\u0026gt;\n\u0026lt;li\u0026gt;INSERT that data into other table\u0026lt;\/li\u0026gt;\n\u0026lt;li\u0026gt;DELETE that data from the original table\u0026lt;\/li\u0026gt;\n\u0026lt;li\u0026gt;SELECT the newly inserted data in the other table\u0026lt;\/li\u0026gt;\n\u0026lt;\/ul\u0026gt;\n\u0026lt;p\u0026gt;Right?\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Unless!\u0026lt;\/p\u0026gt;\n\u0026lt;blockquote\u0026gt;\n\u0026lt;p\u0026gt;Santa turned to you.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;“I don’t want this done in five steps,” he said. “And I don’t want any re-selecting. Move the problem presents out of the delivery system, log them in the vault, and show me exactly what you moved.”\u0026lt;\/p\u0026gt;\n\u0026lt;\/blockquote\u0026gt;\n\u0026lt;p\u0026gt;Ouch Santa! Don\u0026#39;t be lazy! Be smart he says! Huhh!\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Ok, at least let\u0026#39;s check both the tables, how many rows they have, and the rows that we want to move around.\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;SELECT COUNT(*) AS delivery_count FROM deliveries;\nSELECT COUNT(*) AS misdelivered_present_count FROM misdelivered_presents;\n\nSELECT \n    COUNT(*) AS misdelivered_deliveries_count\nFROM deliveries \nWHERE \n    delivery_location IN (\n        \u0026#39;Volcano Rim\u0026#39;,\n        \u0026#39;Drifting Igloo\u0026#39;,\n        \u0026#39;Abandoned Lighthouse\u0026#39;,\n        \u0026#39;The Vibes\u0026#39;\n    );\n\nSELECT \n    COUNT(*) AS misdelivered_present_count\nFROM misdelivered_presents\nWHERE \n    delivery_location IN (\n        \u0026#39;Volcano Rim\u0026#39;,\n        \u0026#39;Drifting Igloo\u0026#39;,\n        \u0026#39;Abandoned Lighthouse\u0026#39;,\n        \u0026#39;The Vibes\u0026#39;\n    );\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;div class=\u0026#34;code-block\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;code-header\u0026#34;\u0026gt;\u0026lt;span class=\u0026#34;language-name\u0026#34;\u0026gt;\u0026lt;\/span\u0026gt;\u0026lt;button class=\u0026#34;copy-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-copy\u0026#34;\u0026gt;\u0026lt;rect x=\u0026#34;9\u0026#34; y=\u0026#34;9\u0026#34; width=\u0026#34;13\u0026#34; height=\u0026#34;13\u0026#34; rx=\u0026#34;2\u0026#34; ry=\u0026#34;2\u0026#34;\u0026gt;\u0026lt;\/rect\u0026gt;\u0026lt;path d=\u0026#34;M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code\u0026gt;sqlite\u0026gt; SELECT COUNT(*) FROM deliveries;\n\u002b----------\u002b\n| COUNT(*) |\n\u002b----------\u002b\n| 600      |\n\u002b----------\u002b\nsqlite\u0026gt; SELECT COUNT(*) FROM misdelivered_presents;\n\u002b----------\u002b\n| COUNT(*) |\n\u002b----------\u002b\n| 50       |\n\u002b----------\u002b\nsqlite\u0026gt; SELECT COUNT(*) FROM deliveries WHERE delivery_location IN (\u0026#39;Volcano Rim\u0026#39;, \u0026#39;Drifting Igloo\u0026#39;, \u0026#39;Abandoned Lighthouse\u0026#39;, \u0026#39;The Vibes\u0026#39;);\n\u002b----------\u002b\n| COUNT(*) |\n\u002b----------\u002b\n| 103      |\n\u002b----------\u002b\nsqlite\u0026gt; SELECT COUNT(*) FROM misdelivered_presents WHERE delivery_location  IN (\u0026#39;Volcano Rim\u0026#39;, \u0026#39;Drifting Igloo\u0026#39;, \u0026#39;Abandoned Lighthouse\u0026#39;, \u0026#39;The Vibes\u0026#39;);\n\u002b----------\u002b\n| COUNT(*) |\n\u002b----------\u002b\n| 50       |\n\u002b----------\u002b\nsqlite\u0026gt; \n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;OK, so we need to delete the \u0026lt;code\u0026gt;103\u0026lt;\/code\u0026gt; records from the \u0026lt;code\u0026gt;deliveries\u0026lt;\/code\u0026gt; table and move them into the \u0026lt;code\u0026gt;misdelivered_presents\u0026lt;\/code\u0026gt; at the same time.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;How are we going to do that in SQLite.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;We can try\u0026lt;\/p\u0026gt;\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;DELETE FROM deliveries with a SELECT from deliveries\u0026lt;\/li\u0026gt;\n\u0026lt;li\u0026gt;Then INSERT the deleted data into misdelivered_presents\u0026lt;\/li\u0026gt;\n\u0026lt;\/ul\u0026gt;\n\u0026lt;p\u0026gt;Could that work?\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Let\u0026#39;s see\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;WITH moved AS (\n    DELETE \n        FROM deliveries\n        WHERE delivery_location IN (\n            \u0026#39;Volcano Rim\u0026#39;,\n            \u0026#39;Drifting Igloo\u0026#39;,\n            \u0026#39;Abandoned Lighthouse\u0026#39;,\n            \u0026#39;The Vibes\u0026#39;\n        )\n    RETURNING \n        id, \n        child_name, \n        delivery_location, \n        gift_name, \n        scheduled_at, \n        datetime(\u0026#39;now\u0026#39;) AS flagged_at, \n        \u0026#39;Invalid delivery location\u0026#39; AS reason\n)\nSELECT * FROM moved;\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;div class=\u0026#34;code-block\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;code-header\u0026#34;\u0026gt;\u0026lt;span class=\u0026#34;language-name\u0026#34;\u0026gt;\u0026lt;\/span\u0026gt;\u0026lt;button class=\u0026#34;copy-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-copy\u0026#34;\u0026gt;\u0026lt;rect x=\u0026#34;9\u0026#34; y=\u0026#34;9\u0026#34; width=\u0026#34;13\u0026#34; height=\u0026#34;13\u0026#34; rx=\u0026#34;2\u0026#34; ry=\u0026#34;2\u0026#34;\u0026gt;\u0026lt;\/rect\u0026gt;\u0026lt;path d=\u0026#34;M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code\u0026gt;\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;Ops! Can\u0026#39;t generate a CTE with delete in it.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;That\u0026#39;s nasty. Thought that could shove it in the insert into the misdelivered table.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;But it should be other way then?\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Insert first and then use the data to delete?\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;WITH inserted_data AS (\n  INSERT INTO misdelivered_presents (id, child_name, delivery_location, gift_name, scheduled_at)\n  SELECT id, child_name, delivery_location, gift_name, scheduled_at\n  FROM deliveries\n  WHERE delivery_location IN (\u0026#39;Volcano Rim\u0026#39;, \u0026#39;Drifting Igloo\u0026#39;, \u0026#39;Abandoned Lighthouse\u0026#39;, \u0026#39;The Vibes\u0026#39;)\n)\nDELETE FROM deliveries\nWHERE delivery_location IN (\u0026#39;Volcano Rim\u0026#39;, \u0026#39;Drifting Igloo\u0026#39;, \u0026#39;Abandoned Lighthouse\u0026#39;, \u0026#39;The Vibes\u0026#39;);\n\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;div class=\u0026#34;code-block\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;code-header\u0026#34;\u0026gt;\u0026lt;span class=\u0026#34;language-name\u0026#34;\u0026gt;\u0026lt;\/span\u0026gt;\u0026lt;button class=\u0026#34;copy-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-copy\u0026#34;\u0026gt;\u0026lt;rect x=\u0026#34;9\u0026#34; y=\u0026#34;9\u0026#34; width=\u0026#34;13\u0026#34; height=\u0026#34;13\u0026#34; rx=\u0026#34;2\u0026#34; ry=\u0026#34;2\u0026#34;\u0026gt;\u0026lt;\/rect\u0026gt;\u0026lt;path d=\u0026#34;M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code\u0026gt;sqlite\u0026gt; WITH inserted_data AS (\n  INSERT INTO misdelivered_presents (id, child_name, delivery_location, gift_name, scheduled_at)\n  SELECT id, child_name, delivery_location, gift_name, scheduled_at\n  FROM deliveries\n  WHERE delivery_location IN (\u0026#39;Volcano Rim\u0026#39;, \u0026#39;Drifting Igloo\u0026#39;, \u0026#39;Abandoned Lighthouse\u0026#39;, \u0026#39;The Vibes\u0026#39;)\n)\nDELETE FROM deliveries\nWHERE delivery_location IN (\u0026#39;Volcano Rim\u0026#39;, \u0026#39;Drifting Igloo\u0026#39;, \u0026#39;Abandoned Lighthouse\u0026#39;, \u0026#39;The Vibes\u0026#39;);\nParse error: near \u0026#34;INSERT\u0026#34;: syntax error\n  rt the selected rows into misdelivered_presents   INSERT INTO misdelivered_pre\n                                      error here ---^\nsqlite\u0026gt; \n\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;Tried it, didn\u0026#39;t work\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Quoting the documentation here.\u0026lt;\/p\u0026gt;\n\u0026lt;blockquote\u0026gt;\n\u0026lt;p\u0026gt;Common Table Expressions or CTEs act like temporary views that exist only for the duration of a single SQL statement. There are two kinds of common table expressions: \u0026amp;quot;ordinary\u0026amp;quot; and \u0026amp;quot;recursive\u0026amp;quot;. Ordinary common table expressions are helpful for making queries easier to understand by factoring subqueries out of the main SQL statement. Recursive common table expressions provide the ability to do hierarchical or recursive queries of trees and graphs, a capability that is not otherwise available in the SQL language.\u0026lt;\/p\u0026gt;\n\u0026lt;\/blockquote\u0026gt;\n\u0026lt;p\u0026gt;I think it doesn\u0026#39;t support CTEs with delete or insert! Sigh!\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Now?\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;BEGIN COMMIT? Atomic Transactions?\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Yeah!\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Santa wanted it in one go right? That\u0026#39;s not possible in SQLite but at least everything will happen or nothing will.\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;BEGIN;\n\nWITH misdelivered_deliveries AS (\n    SELECT * FROM deliveries \n    WHERE delivery_location IN (\n        \u0026#39;Volcano Rim\u0026#39;, \n        \u0026#39;Drifting Igloo\u0026#39;, \n        \u0026#39;Abandoned Lighthouse\u0026#39;, \n        \u0026#39;The Vibes\u0026#39;)\n)\nINSERT INTO misdelivered_presents (\n    id, \n    child_name,\n    delivery_location, \n    gift_name, \n    scheduled_at, \n    flagged_at, \n    reason\n)\nSELECT \n    id,\n    child_name,\n    delivery_location,\n    gift_name,\n    scheduled_at,\n    DATETIME(\u0026#39;now\u0026#39;),\n    \u0026#39;Invalid delivery location\u0026#39;\nFROM misdelivered_deliveries\nRETURNING *;\n\nDELETE FROM deliveries \nWHERE id IN (\n    SELECT id FROM deliveries \n    WHERE delivery_location IN (\u0026#39;Volcano Rim\u0026#39;, \u0026#39;Drifting Igloo\u0026#39;, \u0026#39;Abandoned Lighthouse\u0026#39;, \u0026#39;The Vibes\u0026#39;)\n);\n\nCOMMIT;\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;So here, we defined the CTE that selects data from \u0026lt;code\u0026gt;deliveries\u0026lt;\/code\u0026gt; and uses it to insert into the \u0026lt;code\u0026gt;misdelivered_deliveries\u0026lt;\/code\u0026gt; table. Then a separate query to delete that data from the \u0026lt;code\u0026gt;deliveries\u0026lt;\/code\u0026gt; table.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Yeah! I mean I don\u0026#39;t think there could be other way to it!\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;We might or can use triggers to insert into one table when inserted in one table. But I think that is too much of a farfetched solution. We might create a trigger and instantly delete it as it could populate unwanted data if kept in the database.\u0026lt;\/p\u0026gt;\n\u0026lt;h3 id=\u0026#34;trigger-to-insert-when-deleted\u0026#34;\u0026gt;Trigger to insert when deleted\u0026lt;\/h3\u0026gt;\n\u0026lt;p\u0026gt;We can create a \u0026lt;code\u0026gt;TRIGGER\u0026lt;\/code\u0026gt; to insert into \u0026lt;code\u0026gt;misdelivered_presents\u0026lt;\/code\u0026gt; when something is deleted from \u0026lt;code\u0026gt;deliveries\u0026lt;\/code\u0026gt; table. We will separately have to delete the  records from the \u0026lt;code\u0026gt;deliveries\u0026lt;\/code\u0026gt; table. But the insert will happen automatically after the deletion.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Opening a fresh instance of the database!\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;CREATE TRIGGER move_misdelivered_presents\nBEFORE DELETE ON deliveries\nFOR EACH ROW\nWHEN OLD.delivery_location IN (\u0026#39;Volcano Rim\u0026#39;, \u0026#39;Drifting Igloo\u0026#39;, \u0026#39;Abandoned Lighthouse\u0026#39;, \u0026#39;The Vibes\u0026#39;)\nBEGIN\n    INSERT INTO misdelivered_presents (\n        id, child_name, delivery_location, gift_name, \n        scheduled_at, flagged_at, reason\n    )\n    VALUES (\n        OLD.id, OLD.child_name, OLD.delivery_location, OLD.gift_name, \n        OLD.scheduled_at, DATETIME(\u0026#39;now\u0026#39;), \u0026#39;Invalid delivery location\u0026#39;\n    );\nEND;\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;This will create the trigger to insert the row into \u0026lt;code\u0026gt;misdelivered_presents\u0026lt;\/code\u0026gt; table when deleted from the \u0026lt;code\u0026gt;deliveries\u0026lt;\/code\u0026gt; table.\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;sql-playground\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt;\u0026lt;button class=\u0026#34;run-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-play\u0026#34;\u0026gt;\u0026lt;polygon points=\u0026#34;5 3 19 12 5 21 5 3\u0026#34;\u0026gt;\u0026lt;\/polygon\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;edit-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-edit\u0026#34;\u0026gt;\u0026lt;path d=\u0026#34;M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;path d=\u0026#34;M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;button class=\u0026#34;reset-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-refresh-cw\u0026#34;\u0026gt;\u0026lt;polyline points=\u0026#34;23 4 23 10 17 10\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;polyline points=\u0026#34;1 20 1 14 7 14\u0026#34;\u0026gt;\u0026lt;\/polyline\u0026gt;\u0026lt;path d=\u0026#34;M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code class=\u0026#34;language-sql\u0026#34;\u0026gt;DELETE FROM deliveries \nWHERE delivery_location IN (\u0026#39;Volcano Rim\u0026#39;, \u0026#39;Drifting Igloo\u0026#39;, \u0026#39;Abandoned Lighthouse\u0026#39;, \u0026#39;The Vibes\u0026#39;)\nRETURNING *;\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;Ops! We are returning from the DELETE statement which is wrong as the problem stated to select from the \u0026lt;code\u0026gt;misdelivered_presents\u0026lt;\/code\u0026gt; table.\u0026lt;\/p\u0026gt;\n\u0026lt;blockquote\u0026gt;\n\u0026lt;p\u0026gt;Make sure your final step shows the misdelivered_presents records that you just moved (i.e. don\u0026#39;t include any existing records from the misdelivered_presents table).\u0026lt;\/p\u0026gt;\n\u0026lt;\/blockquote\u0026gt;\n\u0026lt;p\u0026gt;This is invalid then!\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Though its not technically atomic. It happens before the delete, so it can mess up things.\u0026lt;\/p\u0026gt;\n\u0026lt;div class=\u0026#34;code-block\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;code-header\u0026#34;\u0026gt;\u0026lt;span class=\u0026#34;language-name\u0026#34;\u0026gt;\u0026lt;\/span\u0026gt;\u0026lt;button class=\u0026#34;copy-button\u0026#34;\u0026gt;\u0026lt;svg xmlns=\u0026#34;http:\/\/www.w3.org\/2000\/svg\u0026#34; width=\u0026#34;24\u0026#34; height=\u0026#34;24\u0026#34; viewBox=\u0026#34;0 0 24 24\u0026#34; fill=\u0026#34;none\u0026#34; stroke=\u0026#34;currentColor\u0026#34; stroke-width=\u0026#34;2\u0026#34; stroke-linecap=\u0026#34;round\u0026#34; stroke-linejoin=\u0026#34;round\u0026#34; class=\u0026#34;feather feather-copy\u0026#34;\u0026gt;\u0026lt;rect x=\u0026#34;9\u0026#34; y=\u0026#34;9\u0026#34; width=\u0026#34;13\u0026#34; height=\u0026#34;13\u0026#34; rx=\u0026#34;2\u0026#34; ry=\u0026#34;2\u0026#34;\u0026gt;\u0026lt;\/rect\u0026gt;\u0026lt;path d=\u0026#34;M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1\u0026#34;\u0026gt;\u0026lt;\/path\u0026gt;\u0026lt;\/svg\u0026gt;\u0026lt;\/button\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;pre\u0026gt;\u0026lt;code\u0026gt;sqlite\u0026gt; .read day10-inserts.sql\nsqlite\u0026gt; .mode table \nsqlite\u0026gt; CREATE TRIGGER move_misdelivered_presents\nBEFORE DELETE ON deliveries\nFOR EACH ROW\nWHEN OLD.delivery_location IN (\u0026#39;Volcano Rim\u0026#39;, \u0026#39;Drifting Igloo\u0026#39;, \u0026#39;Abandoned Lighthouse\u0026#39;, \u0026#39;The Vibes\u0026#39;)\nBEGIN\n    INSERT INTO misdelivered_presents (\n        id, child_name, delivery_location, gift_name, \n        scheduled_at, flagged_at, reason\n    )\n    VALUES (\n        OLD.id, OLD.child_name, OLD.delivery_location, OLD.gift_name, \n        OLD.scheduled_at, DATETIME(\u0026#39;now\u0026#39;), \u0026#39;Invalid delivery location\u0026#39;\n    );\nEND;\nsqlite\u0026gt; DELETE FROM deliveries \nWHERE delivery_location IN (\u0026#39;Volcano Rim\u0026#39;, \u0026#39;Drifting Igloo\u0026#39;, \u0026#39;Abandoned Lighthouse\u0026#39;, \u0026#39;The Vibes\u0026#39;)\nRETURNING *;\n\u002b-----\u002b------------\u002b----------------------\u002b----------------------\u002b---------------------\u002b\n| id  | child_name |  delivery_location   |      gift_name       |    scheduled_at     |\n\u002b-----\u002b------------\u002b----------------------\u002b----------------------\u002b---------------------\u002b\n| 3   | Mila N.    | The Vibes            | storybook collection | 2025-12-24 21:09:00 |\n| 22  | Lena F.    | Abandoned Lighthouse | plush reindeer       | 2025-12-24 19:08:00 |\n| 23  | Mila N.    | Abandoned Lighthouse | storybook collection | 2025-12-24 20:42:00 |\n| 29  | Mateo C.   | Volcano Rim          | plush reindeer       | 2025-12-24 21:44:00 |\n| 31  | Nia G.     | Drifting Igloo       | robot toy            | 2025-12-24 19:57:00 |\n...\n...\n| 582 | Zara S.    | The Vibes            | teddy bear           | 2025-12-24 21:20:00 |\n| 585 | Layla B.   | Abandoned Lighthouse | wooden train set     | 2025-12-24 18:39:00 |\n| 587 | Nia G.     | Volcano Rim          | storybook collection | 2025-12-24 18:35:00 |\n| 596 | Omar Q.    | Abandoned Lighthouse | puzzle box           | 2025-12-24 19:28:00 |\n\u002b-----\u002b------------\u002b----------------------\u002b----------------------\u002b---------------------\u002b\nsqlite\u0026gt; DROP TRIGGER move_misdelivered_presents;\nsqlite\u0026gt; SELECT COUNT(*) FROM deliveries;\n\u002b----------\u002b\n| COUNT(*) |\n\u002b----------\u002b\n| 497      |\n\u002b----------\u002b\nsqlite\u0026gt; SELECT COUNT(*) FROM misdelivered_presents;\n\u002b----------\u002b\n| COUNT(*) |\n\u002b----------\u002b\n| 153      |\n\u002b----------\u002b\nsqlite\u0026gt; \n\n\u0026lt;\/code\u0026gt;\u0026lt;\/pre\u0026gt;\u0026lt;\/div\u0026gt;\u0026lt;p\u0026gt;So, it gets the result but I don\u0026#39;t think the \u0026lt;code\u0026gt;TRIGGER\u0026lt;\/code\u0026gt; is a solution to this.\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;In SQLite, Atomic transaction using begin and end is the only thing to go for right?\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Some one prove Santa that it can\u0026#39;t be done in SQLite in one query? Please!\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;That\u0026#39;s it from day 10, I have spent enough time on this, banging my head on the sqlite shell!\u0026lt;\/p\u0026gt;\n\u0026lt;p\u0026gt;Off to day 11 tomorrow!\u0026lt;\/p\u0026gt;\n"
    }
    </script>
    
    
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="/code-block.css">
    <link rel="stylesheet" href="/post-navigation.css">
    
    <link rel="icon" href="/tbicon.png" type="image/png">
    <link rel="apple-touch-icon" href="/tbicon.png">
    
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <link id="syntax-theme" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/go.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.13.0/sql-wasm.js"></script>
    <link rel="stylesheet" href="/sql-playground.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/monokai.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/sql/sql.min.js"></script>
    <script src="/sql-playground.js"></script>
    
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script>
    document.addEventListener("DOMContentLoaded", () => {
        const body = document.body;
        const stylesheet = document.getElementById("syntax-theme");
        const themeToggle = document.getElementById('theme-toggle');

        function setSyntaxTheme(theme) {
            if (theme === "secondary") {
                stylesheet.href = "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css";
            } else {
                stylesheet.href = "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css";
            }
        }

        
        document.querySelectorAll("pre code").forEach((block) => {
            hljs.highlightElement(block);
        });

        
        const currentTheme = localStorage.getItem("theme") || "default";
        if (currentTheme === "secondary") {
            body.classList.add("secondary-theme");
            if (themeToggle) themeToggle.checked = true;
        }
        setSyntaxTheme(currentTheme);

        
        if (themeToggle) {
            themeToggle.addEventListener('change', () => {
                const newTheme = themeToggle.checked ? 'secondary' : 'default';
                if (themeToggle.checked) {
                    body.classList.add('secondary-theme');
                } else {
                    body.classList.remove('secondary-theme');
                }
                localStorage.setItem('theme', newTheme);
                setSyntaxTheme(newTheme);
            });
        }
        
        
        const editBtn = document.getElementById('editor-edit');
        if (editBtn) {
            editBtn.addEventListener('click', async function () {
                const slug = "sqlog\/advent-of-sql-2025-day-10";
                const type = "sqlog";
                console.log("Editing post:", slug, type);
                const url = "https:\/\/devmeetgor.netlify.app/.netlify/functions/api?slug=" + slug + "&method=edit&type=" + type;
                
                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error("Failed to fetch edit content");
                    const html = await res.text();
                    document.querySelector('.post-content').innerHTML = html;
                } catch (err) {
                    console.error(err);
                    alert("Error loading editor content");
                }
            });
        }
    });
    </script>
    
    
    <script src="/seasonal-effects.js" defer></script>
    
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EET2ZX4QY1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-EET2ZX4QY1');
    </script>
</head>
<body>
    <header class="header">
  <a class="site-title" href="/" aria-label="Meet Gor - Home">Meet Gor</a>
  <nav>
    <ul>
      <li><a href="/" aria-label="Home">Home</a></li>
      <li><a href="/posts" aria-label="Posts">Posts</a></li>
      <li><a href="/all-content" aria-label="All Content">All Content</a></li>
      <li><a href="/about" aria-label="About">About</a></li>
      <li><a href="/contact" aria-label="Contact">Contact</a></li>
    </ul>
  </nav>
  <div class="theme-switch">
    <input type="checkbox" id="theme-toggle" aria-label="Toggle Theme">
    <label for="theme-toggle"></label>
  </div>
  
</header>
    
    <main class="container">
        <article class="blog-post">
            <h1>Advent of SQL 2025 Day 10: Misdelivered Presents</h1>
            
            <div class="post-meta">
                Published on 📅 <time datetime="2025-12-25 15:30 &#43;0530">2025-12-25 15:30 &#43;0530</time>
            </div>
            
            <div class="post-meta">
                Type: <a href="/sqlog">sqlog</a>
            </div>
            
            <div class="post-meta tags">
                <span class="post-series-label">🏷️ Tags:</span>
                
                <a href="/tags/sqlite">#sqlite</a>
                
                <a href="/tags/sql">#sql</a>
                
                <a href="/tags/advent-of-sql">#advent-of-sql</a>
                
            </div>
            
            
            <div class="post-series">
                <span class="series-label">Part of the
                <span class="series-list">
                    
                    <a href="/series/advent-of-sql-2025" class="series-link">📖 advent-of-sql-2025</a>
                    
                </span></span>
                <span class="series-label">series</span>
            </div>
            
            
            
            
            <hr>
            
            <div class="post-content">
                <h2 id="advent-of-sql-day-10---misdelivered-presents">Advent of SQL, Day 10 - Misdelivered Presents</h2>
<p>It's already day 10? We just need 5 more days now! Whoa! that flew by swiftly.</p>
<p>Let's pull in the data.</p>
<p>This is the SQL for day 10 in SQLite.</p>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">DROP TABLE IF EXISTS misdelivered_presents;
DROP TABLE IF EXISTS deliveries;

CREATE TABLE deliveries (
    id INT PRIMARY KEY,
    child_name TEXT,
    delivery_location TEXT,
    gift_name TEXT,
    scheduled_at TIMESTAMP
);

CREATE TABLE misdelivered_presents (
    id INT PRIMARY KEY,
    child_name TEXT,
    delivery_location TEXT,
    gift_name TEXT,
    scheduled_at TIMESTAMP,
    flagged_at TIMESTAMP,
    reason TEXT
);

INSERT INTO deliveries (id, child_name, delivery_location, gift_name, scheduled_at) VALUES
    (1, 'Omar Q.', '45 Maple Street', 'storybook collection', '2025-12-24 21:09:00'),
    (2, 'Sofia K.', '77 Snowflake Road', 'plush reindeer', '2025-12-24 18:35:00'),
    (3, 'Mila N.', 'The Vibes', 'storybook collection', '2025-12-24 21:09:00'),
    (4, 'Elias M.', 'Frost Hollow Cabin', 'board game', '2025-12-24 20:31:00'),
    (5, 'Ravi P.', '45 Maple Street', 'wooden train set', '2025-12-24 18:23:00'),
    (6, 'Jonah W.', '77 Snowflake Road', 'plush reindeer', '2025-12-24 20:34:00'),
    (7, 'Ava J.', '123 Evergreen Lane', 'board game', '2025-12-24 21:03:00'),
    (8, 'Omar Q.', '77 Snowflake Road', 'board game', '2025-12-24 18:56:00'),
    (9, 'Nia G.', 'Frost Hollow Cabin', 'teddy bear', '2025-12-24 21:27:00'),
    (10, 'Zara S.', 'North Pole Annex', 'wooden train set', '2025-12-24 20:58:00'),
    (11, 'Ravi P.', 'Frost Hollow Cabin', 'puzzle box', '2025-12-24 18:39:00'),
    (12, 'Jonah W.', '123 Evergreen Lane', 'puzzle box', '2025-12-24 18:23:00'),
    (13, 'Ravi P.', 'North Pole Annex', 'storybook collection', '2025-12-24 21:36:00'),
    (14, 'Lena F.', 'North Pole Annex', 'teddy bear', '2025-12-24 21:26:00'),
    (15, 'Ava J.', 'North Pole Annex', 'snow globe', '2025-12-24 18:31:00'),
    (16, 'Elias M.', 'Frost Hollow Cabin', 'robot toy', '2025-12-24 20:21:00'),
    (17, 'Sofia K.', 'Frost Hollow Cabin', 'teddy bear', '2025-12-24 20:27:00'),
    (18, 'Jonah W.', '77 Snowflake Road', 'storybook collection', '2025-12-24 20:49:00'),
    (19, 'Jonah W.', 'Frost Hollow Cabin', 'art supplies', '2025-12-24 21:38:00'),
    (20, 'Jonah W.', '123 Evergreen Lane', 'storybook collection', '2025-12-24 19:11:00');

INSERT INTO misdelivered_presents
(id, child_name, delivery_location, gift_name, scheduled_at, flagged_at, reason)
VALUES
    (601, 'Priya D.', 'The Vibes', 'plush reindeer', '2025-12-24 14:00:00', '2025-12-24 14:05:00', 'Invalid delivery location'),
    (602, 'Lena F.', 'Abandoned Lighthouse', 'board game', '2025-12-22 06:00:00', '2025-12-22 06:05:00', 'Invalid delivery location'),
    (603, 'Caleb O.', 'Drifting Igloo', 'board game', '2025-12-24 06:00:00', '2025-12-24 06:05:00', 'Invalid delivery location'),
    (604, 'Mateo C.', 'The Vibes', 'art supplies', '2025-12-22 04:00:00', '2025-12-22 04:05:00', 'Invalid delivery location'),
    (605, 'Hiro T.', 'The Vibes', 'robot toy', '2025-12-24 08:00:00', '2025-12-24 08:05:00', 'Invalid delivery location'),
    (606, 'Priya D.', 'Volcano Rim', 'puzzle box', '2025-12-22 08:00:00', '2025-12-22 08:05:00', 'Invalid delivery location'),
    (607, 'Nia G.', 'Abandoned Lighthouse', 'board game', '2025-12-24 01:00:00', '2025-12-24 01:05:00', 'Invalid delivery location'),
    (608, 'Elias M.', 'Drifting Igloo', 'board game', '2025-12-24 01:00:00', '2025-12-24 01:05:00', 'Invalid delivery location'),
    (609, 'Ravi P.', 'Volcano Rim', 'board game', '2025-12-24 02:00:00', '2025-12-24 02:05:00', 'Invalid delivery location'),
    (610, 'Hiro T.', 'Abandoned Lighthouse', 'science kit', '2025-12-23 20:00:00', '2025-12-23 20:05:00', 'Invalid delivery location'),
    (611, 'Priya D.', 'Drifting Igloo', 'puzzle box', '2025-12-22 21:00:00', '2025-12-22 21:05:00', 'Invalid delivery location'),
    (612, 'Hiro T.', 'Volcano Rim', 'art supplies', '2025-12-23 09:00:00', '2025-12-23 09:05:00', 'Invalid delivery location'),
    (613, 'Jonah W.', 'Abandoned Lighthouse', 'board game', '2025-12-24 01:00:00', '2025-12-24 01:05:00', 'Invalid delivery location'),
    (614, 'Omar Q.', 'Volcano Rim', 'art supplies', '2025-12-22 01:00:00', '2025-12-22 01:05:00', 'Invalid delivery location'),
    (615, 'Omar Q.', 'Drifting Igloo', 'science kit', '2025-12-23 20:00:00', '2025-12-23 20:05:00', 'Invalid delivery location'),
    (616, 'Omar Q.', 'Abandoned Lighthouse', 'teddy bear', '2025-12-24 12:00:00', '2025-12-24 12:05:00', 'Invalid delivery location'),
    (617, 'Zara S.', 'Volcano Rim', 'wooden train set', '2025-12-24 12:00:00', '2025-12-24 12:05:00', 'Invalid delivery location'),
    (618, 'Omar Q.', 'Abandoned Lighthouse', 'teddy bear', '2025-12-23 15:00:00', '2025-12-23 15:05:00', 'Invalid delivery location'),
    (619, 'Caleb O.', 'The Vibes', 'teddy bear', '2025-12-24 14:00:00', '2025-12-24 14:05:00', 'Invalid delivery location'),
    (620, 'Nia G.', 'Abandoned Lighthouse', 'board game', '2025-12-23 03:00:00', '2025-12-23 03:05:00', 'Invalid delivery location');
</code></pre><div class="output"></div></div><div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">SELECT * FROM deliveries;
SELECT * FROM misdelivered_presents;
</code></pre><div class="output"></div></div><p>We have two tables. Almost the same with critical logical distinction among them and one extra column.</p>
<p>Let's see the problem to check it.</p>
<h2 id="problem">Problem</h2>
<blockquote>
<p>Clean-up the deliveries table to remove any records where the delivery_location is 'Volcano Rim', 'Drifting Igloo', 'Abandoned Lighthouse', 'The Vibes'.</p>
<p>Move those records to the misdelivered_presents with all the same columns as deliveries plus a flagged_at column with the current time and a reason column with &quot;Invalid delivery location&quot; listed as the reason for each moved record.</p>
<p>Make sure your final step shows the misdelivered_presents records that you just moved (i.e. don't include any existing records from the misdelivered_presents table).</p>
</blockquote>
<p>Ok, this looks some easy problem.</p>
<ul>
<li>SELECT some data</li>
<li>INSERT that data into other table</li>
<li>DELETE that data from the original table</li>
<li>SELECT the newly inserted data in the other table</li>
</ul>
<p>Right?</p>
<p>Unless!</p>
<blockquote>
<p>Santa turned to you.</p>
<p>“I don’t want this done in five steps,” he said. “And I don’t want any re-selecting. Move the problem presents out of the delivery system, log them in the vault, and show me exactly what you moved.”</p>
</blockquote>
<p>Ouch Santa! Don't be lazy! Be smart he says! Huhh!</p>
<p>Ok, at least let's check both the tables, how many rows they have, and the rows that we want to move around.</p>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">SELECT COUNT(*) AS delivery_count FROM deliveries;
SELECT COUNT(*) AS misdelivered_present_count FROM misdelivered_presents;

SELECT 
    COUNT(*) AS misdelivered_deliveries_count
FROM deliveries 
WHERE 
    delivery_location IN (
        'Volcano Rim',
        'Drifting Igloo',
        'Abandoned Lighthouse',
        'The Vibes'
    );

SELECT 
    COUNT(*) AS misdelivered_present_count
FROM misdelivered_presents
WHERE 
    delivery_location IN (
        'Volcano Rim',
        'Drifting Igloo',
        'Abandoned Lighthouse',
        'The Vibes'
    );
</code></pre><div class="output"></div></div><div class="code-block"><div class="code-header"><span class="language-name"></span><button class="copy-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button></div><pre><code>sqlite> SELECT COUNT(*) FROM deliveries;
+----------+
| COUNT(*) |
+----------+
| 600      |
+----------+
sqlite> SELECT COUNT(*) FROM misdelivered_presents;
+----------+
| COUNT(*) |
+----------+
| 50       |
+----------+
sqlite> SELECT COUNT(*) FROM deliveries WHERE delivery_location IN ('Volcano Rim', 'Drifting Igloo', 'Abandoned Lighthouse', 'The Vibes');
+----------+
| COUNT(*) |
+----------+
| 103      |
+----------+
sqlite> SELECT COUNT(*) FROM misdelivered_presents WHERE delivery_location  IN ('Volcano Rim', 'Drifting Igloo', 'Abandoned Lighthouse', 'The Vibes');
+----------+
| COUNT(*) |
+----------+
| 50       |
+----------+
sqlite> 
</code></pre></div><p>OK, so we need to delete the <code>103</code> records from the <code>deliveries</code> table and move them into the <code>misdelivered_presents</code> at the same time.</p>
<p>How are we going to do that in SQLite.</p>
<p>We can try</p>
<ul>
<li>DELETE FROM deliveries with a SELECT from deliveries</li>
<li>Then INSERT the deleted data into misdelivered_presents</li>
</ul>
<p>Could that work?</p>
<p>Let's see</p>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">WITH moved AS (
    DELETE 
        FROM deliveries
        WHERE delivery_location IN (
            'Volcano Rim',
            'Drifting Igloo',
            'Abandoned Lighthouse',
            'The Vibes'
        )
    RETURNING 
        id, 
        child_name, 
        delivery_location, 
        gift_name, 
        scheduled_at, 
        datetime('now') AS flagged_at, 
        'Invalid delivery location' AS reason
)
SELECT * FROM moved;
</code></pre><div class="output"></div></div><div class="code-block"><div class="code-header"><span class="language-name"></span><button class="copy-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button></div><pre><code>
</code></pre></div><p>Ops! Can't generate a CTE with delete in it.</p>
<p>That's nasty. Thought that could shove it in the insert into the misdelivered table.</p>
<p>But it should be other way then?</p>
<p>Insert first and then use the data to delete?</p>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">WITH inserted_data AS (
  INSERT INTO misdelivered_presents (id, child_name, delivery_location, gift_name, scheduled_at)
  SELECT id, child_name, delivery_location, gift_name, scheduled_at
  FROM deliveries
  WHERE delivery_location IN ('Volcano Rim', 'Drifting Igloo', 'Abandoned Lighthouse', 'The Vibes')
)
DELETE FROM deliveries
WHERE delivery_location IN ('Volcano Rim', 'Drifting Igloo', 'Abandoned Lighthouse', 'The Vibes');

</code></pre><div class="output"></div></div><div class="code-block"><div class="code-header"><span class="language-name"></span><button class="copy-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button></div><pre><code>sqlite> WITH inserted_data AS (
  INSERT INTO misdelivered_presents (id, child_name, delivery_location, gift_name, scheduled_at)
  SELECT id, child_name, delivery_location, gift_name, scheduled_at
  FROM deliveries
  WHERE delivery_location IN ('Volcano Rim', 'Drifting Igloo', 'Abandoned Lighthouse', 'The Vibes')
)
DELETE FROM deliveries
WHERE delivery_location IN ('Volcano Rim', 'Drifting Igloo', 'Abandoned Lighthouse', 'The Vibes');
Parse error: near "INSERT": syntax error
  rt the selected rows into misdelivered_presents   INSERT INTO misdelivered_pre
                                      error here ---^
sqlite> 

</code></pre></div><p>Tried it, didn't work</p>
<p>Quoting the documentation here.</p>
<blockquote>
<p>Common Table Expressions or CTEs act like temporary views that exist only for the duration of a single SQL statement. There are two kinds of common table expressions: &quot;ordinary&quot; and &quot;recursive&quot;. Ordinary common table expressions are helpful for making queries easier to understand by factoring subqueries out of the main SQL statement. Recursive common table expressions provide the ability to do hierarchical or recursive queries of trees and graphs, a capability that is not otherwise available in the SQL language.</p>
</blockquote>
<p>I think it doesn't support CTEs with delete or insert! Sigh!</p>
<p>Now?</p>
<p>BEGIN COMMIT? Atomic Transactions?</p>
<p>Yeah!</p>
<p>Santa wanted it in one go right? That's not possible in SQLite but at least everything will happen or nothing will.</p>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">BEGIN;

WITH misdelivered_deliveries AS (
    SELECT * FROM deliveries 
    WHERE delivery_location IN (
        'Volcano Rim', 
        'Drifting Igloo', 
        'Abandoned Lighthouse', 
        'The Vibes')
)
INSERT INTO misdelivered_presents (
    id, 
    child_name,
    delivery_location, 
    gift_name, 
    scheduled_at, 
    flagged_at, 
    reason
)
SELECT 
    id,
    child_name,
    delivery_location,
    gift_name,
    scheduled_at,
    DATETIME('now'),
    'Invalid delivery location'
FROM misdelivered_deliveries
RETURNING *;

DELETE FROM deliveries 
WHERE id IN (
    SELECT id FROM deliveries 
    WHERE delivery_location IN ('Volcano Rim', 'Drifting Igloo', 'Abandoned Lighthouse', 'The Vibes')
);

COMMIT;
</code></pre><div class="output"></div></div><p>So here, we defined the CTE that selects data from <code>deliveries</code> and uses it to insert into the <code>misdelivered_deliveries</code> table. Then a separate query to delete that data from the <code>deliveries</code> table.</p>
<p>Yeah! I mean I don't think there could be other way to it!</p>
<p>We might or can use triggers to insert into one table when inserted in one table. But I think that is too much of a farfetched solution. We might create a trigger and instantly delete it as it could populate unwanted data if kept in the database.</p>
<h3 id="trigger-to-insert-when-deleted">Trigger to insert when deleted</h3>
<p>We can create a <code>TRIGGER</code> to insert into <code>misdelivered_presents</code> when something is deleted from <code>deliveries</code> table. We will separately have to delete the  records from the <code>deliveries</code> table. But the insert will happen automatically after the deletion.</p>
<p>Opening a fresh instance of the database!</p>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">CREATE TRIGGER move_misdelivered_presents
BEFORE DELETE ON deliveries
FOR EACH ROW
WHEN OLD.delivery_location IN ('Volcano Rim', 'Drifting Igloo', 'Abandoned Lighthouse', 'The Vibes')
BEGIN
    INSERT INTO misdelivered_presents (
        id, child_name, delivery_location, gift_name, 
        scheduled_at, flagged_at, reason
    )
    VALUES (
        OLD.id, OLD.child_name, OLD.delivery_location, OLD.gift_name, 
        OLD.scheduled_at, DATETIME('now'), 'Invalid delivery location'
    );
END;
</code></pre><div class="output"></div></div><p>This will create the trigger to insert the row into <code>misdelivered_presents</code> table when deleted from the <code>deliveries</code> table.</p>
<div class="sql-playground"><div class="controls"><button class="run-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button><button class="edit-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="reset-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg></button></div><pre><code class="language-sql">DELETE FROM deliveries 
WHERE delivery_location IN ('Volcano Rim', 'Drifting Igloo', 'Abandoned Lighthouse', 'The Vibes')
RETURNING *;
</code></pre><div class="output"></div></div><p>Ops! We are returning from the DELETE statement which is wrong as the problem stated to select from the <code>misdelivered_presents</code> table.</p>
<blockquote>
<p>Make sure your final step shows the misdelivered_presents records that you just moved (i.e. don't include any existing records from the misdelivered_presents table).</p>
</blockquote>
<p>This is invalid then!</p>
<p>Though its not technically atomic. It happens before the delete, so it can mess up things.</p>
<div class="code-block"><div class="code-header"><span class="language-name"></span><button class="copy-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button></div><pre><code>sqlite> .read day10-inserts.sql
sqlite> .mode table 
sqlite> CREATE TRIGGER move_misdelivered_presents
BEFORE DELETE ON deliveries
FOR EACH ROW
WHEN OLD.delivery_location IN ('Volcano Rim', 'Drifting Igloo', 'Abandoned Lighthouse', 'The Vibes')
BEGIN
    INSERT INTO misdelivered_presents (
        id, child_name, delivery_location, gift_name, 
        scheduled_at, flagged_at, reason
    )
    VALUES (
        OLD.id, OLD.child_name, OLD.delivery_location, OLD.gift_name, 
        OLD.scheduled_at, DATETIME('now'), 'Invalid delivery location'
    );
END;
sqlite> DELETE FROM deliveries 
WHERE delivery_location IN ('Volcano Rim', 'Drifting Igloo', 'Abandoned Lighthouse', 'The Vibes')
RETURNING *;
+-----+------------+----------------------+----------------------+---------------------+
| id  | child_name |  delivery_location   |      gift_name       |    scheduled_at     |
+-----+------------+----------------------+----------------------+---------------------+
| 3   | Mila N.    | The Vibes            | storybook collection | 2025-12-24 21:09:00 |
| 22  | Lena F.    | Abandoned Lighthouse | plush reindeer       | 2025-12-24 19:08:00 |
| 23  | Mila N.    | Abandoned Lighthouse | storybook collection | 2025-12-24 20:42:00 |
| 29  | Mateo C.   | Volcano Rim          | plush reindeer       | 2025-12-24 21:44:00 |
| 31  | Nia G.     | Drifting Igloo       | robot toy            | 2025-12-24 19:57:00 |
...
...
| 582 | Zara S.    | The Vibes            | teddy bear           | 2025-12-24 21:20:00 |
| 585 | Layla B.   | Abandoned Lighthouse | wooden train set     | 2025-12-24 18:39:00 |
| 587 | Nia G.     | Volcano Rim          | storybook collection | 2025-12-24 18:35:00 |
| 596 | Omar Q.    | Abandoned Lighthouse | puzzle box           | 2025-12-24 19:28:00 |
+-----+------------+----------------------+----------------------+---------------------+
sqlite> DROP TRIGGER move_misdelivered_presents;
sqlite> SELECT COUNT(*) FROM deliveries;
+----------+
| COUNT(*) |
+----------+
| 497      |
+----------+
sqlite> SELECT COUNT(*) FROM misdelivered_presents;
+----------+
| COUNT(*) |
+----------+
| 153      |
+----------+
sqlite> 

</code></pre></div><p>So, it gets the result but I don't think the <code>TRIGGER</code> is a solution to this.</p>
<p>In SQLite, Atomic transaction using begin and end is the only thing to go for right?</p>
<p>Some one prove Santa that it can't be done in SQLite in one query? Please!</p>
<p>That's it from day 10, I have spent enough time on this, banging my head on the sqlite shell!</p>
<p>Off to day 11 tomorrow!</p>

            </div>
        </article>
        
        
        

<nav class="post-navigation" aria-label="Post Navigation">
    <div class="nav-container">
        
        
        <a href="/sqlog/advent-of-sql-2025-day-9" class="nav-link nav-prev" title="Previous Post">
            <span class="nav-arrow">←</span>
            <span class="nav-label">Previous</span>
            <span class="nav-title">Advent of SQL 2025 Day 9: Evergreen Market Orders</span>
        </a>
        

        
        
        <a href="/sqlog/advent-of-sql-2025-day-11" class="nav-link nav-next" title="Next Post">
            <span class="nav-label">Next</span>
            <span class="nav-title">Advent of SQL 2025 Day 11: Behavior Score</span>
            <span class="nav-arrow">→</span>
        </a>
        
    </div>
</nav>


        
        
        


<aside class="related-reading" aria-labelledby="related-reading-title">
    <h3 id="related-reading-title" class="related-title">📚 Related Reading</h3>
    <ul class="related-list">
        
        
        <li class="related-item">
            <a href="/sqlog/advent-of-sql-2025-day-15" class="related-link">
                <span class="related-post-title">Advent of SQL 2025 Day 15: Confirmation Phrase Dispatches</span>
                <span class="related-post-date">2025-12-28 20:30 &#43;0530</span>
            </a>
        </li>
        
        
        
        <li class="related-item">
            <a href="/sqlog/advent-of-sql-2025-day-14" class="related-link">
                <span class="related-post-title">Advent of SQL 2025 Day 14: Ski Resort Paths</span>
                <span class="related-post-date">2025-12-28 15:30 &#43;0530</span>
            </a>
        </li>
        
        
        
        <li class="related-item">
            <a href="/sqlog/advent-of-sql-2025-day-13" class="related-link">
                <span class="related-post-title">Advent of SQL 2025 Day 13: XML Travel Manifests</span>
                <span class="related-post-date">2025-12-27 20:30 &#43;0530</span>
            </a>
        </li>
        
        
        
        <li class="related-item">
            <a href="/sqlog/advent-of-sql-2025-day-12" class="related-link">
                <span class="related-post-title">Advent of SQL 2025 Day 12: Archive Flight Records</span>
                <span class="related-post-date">2025-12-27 15:30 &#43;0530</span>
            </a>
        </li>
        
        
        
        <li class="related-item">
            <a href="/sqlog/advent-of-sql-2025-day-11" class="related-link">
                <span class="related-post-title">Advent of SQL 2025 Day 11: Behavior Score</span>
                <span class="related-post-date">2025-12-26 15:30 &#43;0530</span>
            </a>
        </li>
        
        
    </ul>
</aside>


    </main>
    
    <div id="comments">
        <script src="https://giscus.app/client.js"
            data-repo="Mr-Destructive/meetgor.com"
            data-repo-id="R_kgDOHZ6V_g"
            data-category="Q&A"
            data-category-id="DIC_kwDOHZ6V_s4CRfn4"
            data-mapping="pathname"
            data-strict="0"
            data-reactions-enabled="1"
            data-emit-metadata="0"
            data-input-position="bottom"
            data-theme="dark_high_contrast"
            data-lang="en"
            crossorigin="anonymous"
            async>
        </script>
    </div>
    
    <footer class="site-footer" role="contentinfo">
  <div class="footer-content">
    <p>&copy; Meet Gor. All rights reserved.</p>
    <div class="social-links">
      <a href="/contact" aria-label="Connect with me">Connect with me</a>
    </div>
  </div>
</footer>
    
</body>
</html>
